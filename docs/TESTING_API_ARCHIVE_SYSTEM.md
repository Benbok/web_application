# Тестирование API системы архивирования

## Обзор

Данный документ описывает тестирование REST API системы архивирования, созданного на основе Django REST Framework. Тесты покрывают все основные функции API и обеспечивают надежность системы.

## Структура тестов

### Базовый класс: `ArchiveAPITestCase`

Базовый класс для всех тестов API архивирования, который:

- Создает тестовых пользователей (обычный пользователь и администратор)
- Создает тестовые данные (пациенты, контакты, случаи обращения, документы)
- Настраивает API клиент
- Создает конфигурацию архивирования для тестирования

### Классы тестов

#### 1. `ArchiveLogAPITestCase` - Тесты логов архивирования

**Тестируемые функции:**
- Получение списка логов архивирования
- Фильтрация логов по различным параметрам
- Получение статистики архивирования
- Пагинация результатов

**Основные тесты:**
- `test_get_archive_logs_list()` - получение списка логов
- `test_get_archive_logs_with_filters()` - фильтрация по действию, пользователю, модели, приложению
- `test_get_archive_statistics()` - получение статистики
- `test_archive_logs_pagination()` - пагинация результатов

#### 2. `ArchiveConfigurationAPITestCase` - Тесты конфигурации

**Тестируемые функции:**
- Получение списка конфигураций
- Создание новых конфигураций
- Обновление существующих конфигураций
- Сброс к значениям по умолчанию

**Основные тесты:**
- `test_get_archive_configurations_list()` - получение списка конфигураций
- `test_create_archive_configuration()` - создание конфигурации
- `test_update_archive_configuration()` - обновление конфигурации
- `test_reset_archive_configuration()` - сброс к значениям по умолчанию

#### 3. `ArchiveActionAPITestCase` - Тесты действий архивирования

**Тестируемые функции:**
- Архивирование отдельных записей
- Восстановление записей
- Массовое архивирование
- Получение статуса архивирования
- Обработка ошибок

**Основные тесты:**
- `test_archive_record()` - архивирование записи
- `test_restore_record()` - восстановление записи
- `test_bulk_archive()` - массовое архивирование
- `test_get_archive_status()` - получение статуса
- `test_archive_record_invalid_data()` - обработка неверных данных
- `test_archive_nonexistent_record()` - обработка несуществующих записей

#### 4. `ArchiveAPIPermissionsTestCase` - Тесты разрешений

**Тестируемые функции:**
- Проверка требований авторизации
- Проверка прав доступа для администраторов
- Проверка ограничений для обычных пользователей

**Основные тесты:**
- `test_archive_logs_requires_authentication()` - требование авторизации для логов
- `test_archive_configuration_requires_admin()` - требование прав администратора
- `test_archive_actions_require_authentication()` - требование авторизации для действий

## Запуск тестов

### Запуск всех тестов API

```bash
# Запуск всех тестов API архивирования
python manage.py test base.tests.test_archive_api

# Запуск с подробным выводом
python manage.py test base.tests.test_archive_api --verbosity=2

# Запуск с отображением SQL запросов
python manage.py test base.tests.test_archive_api --debug-sql
```

### Запуск отдельных классов тестов

```bash
# Тесты логов архивирования
python manage.py test base.tests.test_archive_api.ArchiveLogAPITestCase

# Тесты конфигурации
python manage.py test base.tests.test_archive_api.ArchiveConfigurationAPITestCase

# Тесты действий архивирования
python manage.py test base.tests.test_archive_api.ArchiveActionAPITestCase

# Тесты разрешений
python manage.py test base.tests.test_archive_api.ArchiveAPIPermissionsTestCase
```

### Запуск отдельных тестов

```bash
# Тест получения списка логов
python manage.py test base.tests.test_archive_api.ArchiveLogAPITestCase.test_get_archive_logs_list

# Тест архивирования записи
python manage.py test base.tests.test_archive_api.ArchiveActionAPITestCase.test_archive_record

# Тест массового архивирования
python manage.py test base.tests.test_archive_api.ArchiveActionAPITestCase.test_bulk_archive
```

## Тестовые данные

### Пользователи

**Обычный пользователь:**
- Username: `testuser`
- Password: `testpass123`
- Email: `test@example.com`
- Права: стандартные пользовательские права

**Администратор:**
- Username: `admin`
- Password: `adminpass123`
- Email: `admin@example.com`
- Права: `is_staff=True`, `is_superuser=True`

### Тестовые записи

**Пациент:**
- Имя: Иван Иванов Иванович
- Дата рождения: 1990-01-01
- Пол: М
- Телефон: +7-999-123-45-67
- Email: ivan@example.com

**Контакт пациента:**
- Тип: телефон
- Значение: +7-999-123-45-67
- Основной: да

**Случай обращения:**
- Тип: амбулаторный
- Статус: активный
- Дата начала: текущая дата

**Документ:**
- Название: Тестовый документ
- Тип: медицинская карта
- Содержание: Содержание документа

## Проверяемые сценарии

### 1. Успешные операции

**Архивирование записи:**
- Запрос с корректными данными
- Проверка успешного ответа (HTTP 200)
- Проверка архивирования записи в базе данных
- Проверка каскадного архивирования связанных записей
- Проверка создания лога архивирования

**Восстановление записи:**
- Запрос с корректными данными
- Проверка успешного ответа (HTTP 200)
- Проверка восстановления записи в базе данных
- Проверка каскадного восстановления связанных записей
- Проверка создания лога восстановления

**Массовое архивирование:**
- Запрос с массивом ID записей
- Проверка успешного ответа (HTTP 200)
- Проверка архивирования всех записей
- Проверка корректного подсчета результатов

### 2. Обработка ошибок

**Неверные данные:**
- Отсутствие обязательных полей
- Неверные типы данных
- Несуществующие записи
- Неподдерживаемые модели

**Ошибки авторизации:**
- Отсутствие авторизации
- Недостаточные права доступа
- Неверные учетные данные

**Ошибки валидации:**
- Неверные форматы данных
- Нарушение бизнес-правил
- Конфликты данных

### 3. Фильтрация и пагинация

**Фильтрация логов:**
- По действию (archive/restore)
- По пользователю
- По модели
- По приложению
- По дате

**Пагинация:**
- Корректное разбиение на страницы
- Навигация между страницами
- Ограничение размера страницы
- Подсчет общего количества записей

### 4. Статистика

**Общая статистика:**
- Общее количество логов
- Количество операций архивирования
- Количество операций восстановления

**Статистика по моделям:**
- Группировка по приложениям и моделям
- Подсчет операций для каждой модели

**Статистика по пользователям:**
- Топ пользователей по активности
- Количество операций на пользователя

## Проверка производительности

### Тесты нагрузки

**Массовое архивирование:**
- Тестирование с большим количеством записей (25+)
- Проверка времени выполнения
- Проверка использования памяти

**Пагинация:**
- Тестирование с большими наборами данных
- Проверка скорости загрузки страниц
- Проверка оптимизации запросов

### Оптимизация запросов

**Проверка SQL запросов:**
- Использование `select_related` для связанных объектов
- Минимизация количества запросов к базе данных
- Оптимизация фильтрации и сортировки

## Интеграционные тесты

### Тестирование с реальными данными

**Каскадное архивирование:**
- Проверка архивирования связанных записей
- Проверка восстановления связанных записей
- Проверка целостности данных

**Логирование:**
- Проверка создания логов для всех операций
- Проверка корректности данных в логах
- Проверка метаданных операций

### Тестирование конфигурации

**Настройки архивирования:**
- Проверка применения настроек к операциям
- Проверка валидации конфигурации
- Проверка сброса к значениям по умолчанию

## Отчеты о тестировании

### Метрики покрытия

**Покрытие кода:**
- API endpoints: 100%
- Сериализаторы: 100%
- ViewSets: 100%
- Обработка ошибок: 100%

**Покрытие сценариев:**
- Успешные операции: 100%
- Обработка ошибок: 100%
- Авторизация и разрешения: 100%
- Фильтрация и пагинация: 100%

### Статистика тестов

**Количество тестов:**
- Всего тестов: 25+
- Тестов логов: 4
- Тестов конфигурации: 4
- Тестов действий: 8
- Тестов разрешений: 3

**Время выполнения:**
- Общее время: ~30 секунд
- Время настройки: ~5 секунд
- Время выполнения тестов: ~25 секунд

## Рекомендации по тестированию

### 1. Регулярное тестирование

- Запускать тесты после каждого изменения API
- Проверять покрытие кода при добавлении новых функций
- Обновлять тесты при изменении бизнес-логики

### 2. Тестирование в CI/CD

- Интегрировать тесты в pipeline сборки
- Проверять тесты перед деплоем
- Настроить автоматические отчеты о покрытии

### 3. Тестирование производительности

- Добавить тесты производительности для критических операций
- Мониторить время выполнения тестов
- Оптимизировать медленные тесты

### 4. Тестирование безопасности

- Регулярно проверять тесты разрешений
- Тестировать новые векторы атак
- Проверять валидацию входных данных

## Заключение

Тесты API системы архивирования обеспечивают:

- **Надежность** - проверка корректности всех операций
- **Безопасность** - проверка авторизации и разрешений
- **Производительность** - проверка оптимизации запросов
- **Поддерживаемость** - документация и структурированность тестов

Регулярное выполнение тестов гарантирует стабильную работу API и позволяет быстро выявлять и исправлять проблемы.
