# Модуль Documents - Документация функционала

## Обзор модуля

Модуль `documents` отвечает за управление клинической документацией в системе. Реализует динамическую систему создания документов на основе JSON-схем, поддерживает шаблоны документов и обеспечивает гибкую структуру для различных типов клинических документов.

## Модели (Models)

### DocumentType
**Назначение**: Определяет тип и структуру документа через JSON-схему
**Основные поля**:
- `name` - Название типа документа
- `department` - Связь с отделением (опционально)
- `schema` - JSON-схема для генерации формы

**Методы**:
- `__str__()` - Строковое представление типа документа

**Функционал**:
- Определение структуры документов через JSON-схему
- Привязка к отделениям для организации документов
- Динамическая генерация форм на основе схемы

**Пример JSON-схемы**:
```json
{
  "fields": [
    {
      "name": "patient_name",
      "type": "text",
      "label": "ФИО пациента",
      "required": true
    },
    {
      "name": "diagnosis",
      "type": "textarea",
      "label": "Диагноз",
      "required": true
    },
    {
      "name": "temperature",
      "type": "decimal",
      "label": "Температура",
      "required": false
    }
  ]
}
```

### ClinicalDocument
**Назначение**: Хранит экземпляр клинического документа
**Основные поля**:
- `document_type` - Связь с типом документа
- `content_type` и `object_id` - GenericForeignKey для связи с любым объектом
- `author` - Автор документа
- `author_position` - Должность автора на момент создания
- `datetime_document` - Дата документа
- `data` - JSON-поле с данными документа
- `is_signed` - Статус подписания
- `is_canceled` - Статус аннулирования

**Методы**:
- `__str__()` - Строковое представление документа

**Функционал**:
- Гибкая связь с любыми объектами системы через GenericForeignKey
- Хранение структурированных данных в JSON-формате
- Отслеживание автора и его должности
- Поддержка подписания и аннулирования документов

### DocumentTemplate
**Назначение**: Шаблон с предзаполненными данными для определенного типа документа
**Основные поля**:
- `name` - Название шаблона
- `document_type` - Связь с типом документа
- `author` - Автор шаблона
- `is_global` - Флаг общего шаблона
- `template_data` - JSON с предзаполненными данными

**Методы**:
- `__str__()` - Строковое представление шаблона

**Функционал**:
- Создание шаблонов с предзаполненными данными
- Поддержка глобальных и персональных шаблонов
- Уникальность шаблонов для каждого типа документа

## Представления (Views)

### DocumentTypeSelectionView
**Назначение**: Выбор типа документа перед созданием
**Функционал**:
- Отображение доступных типов документов для отделения
- Поиск по названию типа документа
- Передача параметров для создания документа

### DocumentCreateView
**Назначение**: Создание нового клинического документа
**Функционал**:
- Динамическая генерация формы на основе JSON-схемы
- Поддержка применения шаблонов
- Автоматическое заполнение должности автора
- Преобразование Decimal в строки для JSON-хранения

**Поддерживаемые операции**:
- GET: Отображение формы создания
- POST: Обработка создания документа
- Применение шаблонов через кнопку "Применить шаблон"

### DocumentDetailView
**Назначение**: Отображение деталей документа
**Функционал**:
- Отображение документа в форме для чтения
- Заполнение формы данными из JSON-поля
- Отображение метаданных документа

### DocumentUpdateView
**Назначение**: Редактирование клинического документа
**Функционал**:
- Проверка прав доступа (только автор или суперпользователь)
- Динамическая генерация формы редактирования
- Поддержка применения шаблонов при редактировании
- Обновление должности автора

**Безопасность**:
- Проверка прав доступа в методе `dispatch()`
- Разрешение редактирования только автору документа
- Исключение для суперпользователей

### DocumentDeleteView
**Назначение**: Удаление клинического документа
**Функционал**:
- Проверка прав доступа (только автор или суперпользователь)
- Подтверждение удаления
- Безопасное удаление с проверкой прав

## Формы (Forms)

### build_document_form()
**Назначение**: Динамическое создание Django-формы на основе JSON-схемы
**Параметры**:
- `schema` - JSON-схема документа
- `document_type` - Тип документа (опционально)
- `user` - Пользователь (опционально)

**Поддерживаемые типы полей**:
- `text` - Текстовое поле
- `textarea` - Многострочное текстовое поле
- `number` - Целочисленное поле
- `decimal` - Поле с десятичными числами
- `date` - Поле даты
- `datetime` - Поле даты и времени
- `checkbox` - Флажок
- `choice` - Поле выбора

**Функционал**:
- Автоматическое создание полей на основе схемы
- Поддержка обязательных и необязательных полей
- Автоматическое заполнение поля "doctor" текущим пользователем
- Фильтрация шаблонов по правам доступа

## Утилиты (Utilities)

### convert_decimals_to_str()
**Назначение**: Рекурсивное преобразование объектов Decimal в строки
**Параметры**: `data` - данные для преобразования
**Возвращает**: Преобразованные данные
**Логика**:
- Рекурсивный обход словарей и списков
- Преобразование Decimal в строки
- Сохранение структуры данных

## Админ-панель (Admin)

### DocumentTypeAdmin
**Назначение**: Администрирование типов документов
**Функционал**:
- Отображение названия и отделения
- Фильтрация по отделениям
- Поиск по названию

### ClinicalDocumentAdmin
**Назначение**: Администрирование клинических документов
**Функционал**:
- Отображение типа документа, автора, даты, статуса подписания
- Фильтрация по типу документа, автору, статусу подписания, дате
- Поиск по названию типа документа и данным
- Только для чтения поля created_at и updated_at

### DocumentTemplateAdmin
**Назначение**: Администрирование шаблонов документов
**Функционал**:
- Отображение названия, типа документа, автора, флага глобальности
- Фильтрация по типу документа, автору, флагу глобальности
- Поиск по названию и названию типа документа

## Интеграции

### С системой Departments
- Привязка типов документов к отделениям
- Фильтрация документов по отделениям
- Организация документов по структурным подразделениям

### С системой Users
- Отслеживание авторов документов
- Автоматическое заполнение должности автора
- Контроль прав доступа к документам

### С Generic Relations
- Гибкая связь с любыми объектами системы
- Поддержка документов для пациентов, отделений, назначений
- Универсальность системы документооборота

### С JSON Schema
- Динамическая структура документов
- Гибкость в определении полей
- Возможность изменения структуры без миграций

## Архитектурные особенности

1. **Dynamic Form Generation**: Создание форм на основе JSON-схем
2. **Generic Relations**: Универсальная связь с объектами системы
3. **Template System**: Поддержка шаблонов документов
4. **Permission Control**: Контроль прав доступа к документам
5. **JSON Storage**: Гибкое хранение структурированных данных

## Бизнес-логика

### Жизненный цикл документа:
1. **Выбор типа** - определение структуры документа
2. **Создание** - заполнение формы и сохранение
3. **Редактирование** - изменение данных документа
4. **Подписание** - изменение статуса is_signed
5. **Аннулирование** - изменение статуса is_canceled

### Валидации:
- Проверка прав доступа к документам
- Валидация JSON-схемы при создании типов документов
- Контроль уникальности шаблонов для типа документа

### Интеграции с другими модулями:
- **Departments** → типы документов по отделениям
- **Patients** → документы пациентов
- **Treatment Assignments** → документы назначений
- **Users** → авторы и права доступа

## Поддерживаемые типы полей

### Базовые типы:
- **text** - Однострочный текст
- **textarea** - Многострочный текст
- **number** - Целое число
- **decimal** - Десятичное число
- **date** - Дата
- **datetime** - Дата и время
- **checkbox** - Флажок (да/нет)
- **choice** - Выбор из списка

### Специальные поля:
- **doctor** - Автоматически заполняется текущим пользователем
- **datetime_document** - Стандартное поле даты документа
- **template_choice** - Выбор шаблона для применения

## Примеры использования

### Создание типа документа:
```python
document_type = DocumentType.objects.create(
    name="Эпикриз",
    department=cardiology_department,
    schema={
        "fields": [
            {
                "name": "diagnosis",
                "type": "textarea",
                "label": "Диагноз",
                "required": True
            },
            {
                "name": "treatment",
                "type": "textarea", 
                "label": "Лечение",
                "required": True
            }
        ]
    }
)
```

### Создание шаблона:
```python
template = DocumentTemplate.objects.create(
    name="Стандартный эпикриз",
    document_type=document_type,
    author=user,
    is_global=True,
    template_data={
        "diagnosis": "ИБС, стенокардия напряжения",
        "treatment": "Нитроглицерин, аспирин"
    }
)
```

### Создание документа:
```python
document = ClinicalDocument.objects.create(
    document_type=document_type,
    content_object=patient,
    author=user,
    datetime_document=timezone.now(),
    data={
        "diagnosis": "Острый инфаркт миокарда",
        "treatment": "Тромболитическая терапия"
    }
)
``` 