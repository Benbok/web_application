{% extends 'patients/base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="fas fa-cog"></i> {{ title }}
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <form method="post" id="printSettingsForm">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="font_size" class="form-label">
                                            <i class="fas fa-font"></i> Размер шрифта
                                        </label>
                                        <select name="font_size" id="font_size" class="form-select">
                                            <option value="10">10pt - Мелкий</option>
                                            <option value="12" selected>12pt - Обычный</option>
                                            <option value="14">14pt - Крупный</option>
                                            <option value="16">16pt - Очень крупный</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="font_name" class="form-label">
                                            <i class="fas fa-font"></i> Шрифт
                                        </label>
                                        <select name="font_name" id="font_name" class="form-select">
                                            {% for font in available_fonts %}
                                                <option value="{{ font.name }}" 
                                                        {% if font.type == 'system' %}data-type="system"{% else %}data-type="custom"{% endif %}>
                                                    {{ font.display_name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="page_orientation" class="form-label">
                                            <i class="fas fa-file-alt"></i> Ориентация страницы
                                        </label>
                                        <select name="page_orientation" id="page_orientation" class="form-select">
                                            <option value="portrait" selected>Книжная (вертикальная)</option>
                                            <option value="landscape">Альбомная (горизонтальная)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="margins" class="form-label">
                                            <i class="fas fa-arrows-alt-h"></i> Поля страницы
                                        </label>
                                        <select name="margins" id="margins" class="form-select">
                                            <option value="narrow">Узкие (70pt)</option>
                                            <option value="normal" selected>Обычные (50pt)</option>
                                            <option value="wide">Широкие (30pt)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-edit"></i> Включить в документ
                                        </label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="include_header" id="include_header" checked>
                                            <label class="form-check-label" for="include_header">
                                                Заголовок документа
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="include_footer" id="include_footer" checked>
                                            <label class="form-check-label" for="include_footer">
                                                Подпись врача
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-eye"></i> Предварительный просмотр текста
                                        </label>
                                        <div class="border rounded p-3 bg-light" id="textPreview">
                                            <p style="font-size: 12px; line-height: 16px;">
                                                Это пример текста для предварительного просмотра. 
                                                Здесь вы можете увидеть, как будет выглядеть документ 
                                                с выбранными настройками шрифта и полей.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <a href="{% url 'documents:document_print_preview' document.id %}" 
                                       class="btn btn-outline-info">
                                        <i class="fas fa-eye"></i> Предварительный просмотр
                                    </a>
                                    
                                    <a href="{% url 'documents:document_print' document.id %}" 
                                       class="btn btn-outline-success">
                                        <i class="fas fa-download"></i> Скачать PDF (стандарт)
                                    </a>
                                    
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-print"></i> Скачать PDF с настройками
                                    </button>
                                    
                                    <a href="{% url 'documents:document_detail' document.id %}" 
                                       class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left"></i> Назад к документу
                                    </a>
                                </div>
                            </form>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title">
                                        <i class="fas fa-info-circle"></i> Информация о документе
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Тип:</strong> {{ document.document_type.name }}</p>
                                    <p><strong>Дата:</strong> {{ document.datetime_document|date:"d.m.Y" }}</p>
                                    <p><strong>Автор:</strong> {{ document.author.get_full_name|default:document.author.username }}</p>
                                    
                                    {% if document.data %}
                                        <hr>
                                        <h6>Содержимое документа:</h6>
                                        <ul class="list-unstyled">
                                            {% for field_name, field_value in document.data.items %}
                                                {% if field_value %}
                                                    <li><strong>{{ field_name|title }}:</strong> {{ field_value }}</li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                    
                                    <hr>
                                    <h6>Доступные шрифты:</h6>
                                    <ul class="list-unstyled small">
                                        {% for font in available_fonts %}
                                            <li>
                                                <i class="fas fa-{% if font.type == 'system' %}font{% else %}download{% endif %}"></i>
                                                {{ font.display_name }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fontSizeSelect = document.getElementById('font_size');
    const fontNameSelect = document.getElementById('font_name');
    const marginsSelect = document.getElementById('margins');
    const textPreview = document.getElementById('textPreview');
    
    function updatePreview() {
        const fontSize = parseInt(fontSizeSelect.value);
        const lineHeight = fontSize + 4;
        const selectedFont = fontNameSelect.value;
        
        textPreview.style.fontSize = fontSize + 'px';
        textPreview.style.lineHeight = lineHeight + 'px';
        
        // Обновляем текст предварительного просмотра
        const previewText = textPreview.querySelector('p');
        previewText.style.fontSize = fontSize + 'px';
        previewText.style.lineHeight = lineHeight + 'px';
        
        // Применяем выбранный шрифт (если это системный шрифт)
        const selectedOption = fontNameSelect.options[fontNameSelect.selectedIndex];
        if (selectedOption.dataset.type === 'system') {
            // Для системных шрифтов используем CSS
            if (selectedFont === 'helv') {
                previewText.style.fontFamily = 'Arial, Helvetica, sans-serif';
            } else if (selectedFont === 'tibo') {
                previewText.style.fontFamily = 'Times New Roman, serif';
            } else if (selectedFont === 'tibo-i') {
                previewText.style.fontFamily = 'Times New Roman, serif';
                previewText.style.fontStyle = 'italic';
            } else {
                previewText.style.fontFamily = 'Arial, Helvetica, sans-serif';
                previewText.style.fontWeight = 'bold';
            }
        } else {
            // Для пользовательских шрифтов показываем информацию
            previewText.style.fontFamily = 'Arial, Helvetica, sans-serif';
            previewText.innerHTML = `Пример текста с шрифтом <strong>${selectedFont}</strong><br>
                Размер: ${fontSize}px, поля: ${marginsSelect.value}<br>
                <em>Пользовательский шрифт будет применен при генерации PDF</em>`;
        }
    }
    
    fontSizeSelect.addEventListener('change', updatePreview);
    fontNameSelect.addEventListener('change', updatePreview);
    marginsSelect.addEventListener('change', updatePreview);
    
    // Инициализация предварительного просмотра
    updatePreview();
});
</script>
{% endblock %} 