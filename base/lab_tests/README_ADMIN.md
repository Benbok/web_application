# Администрирование лабораторных исследований

## Обзор

В админке Django добавлен полный функционал для управления лабораторными исследованиями и их результатами.

## Доступные модели

### 1. LabTestDefinition (Определения лабораторных исследований)

**Админ-класс**: `LabTestDefinitionAdmin`

**Отображаемые поля**:
- `name` - Название исследования
- `description` - Описание
- `has_schema` - Наличие схемы полей (булево значение)

**Функционал**:
- Поиск по названию и описанию
- Фильтрация по названию
- Сортировка по названию
- Индикатор наличия JSON-схемы

### 2. LabTestResult (Результаты лабораторных исследований)

**Админ-класс**: `LabTestResultAdmin`

**Отображаемые поля в списке**:
- `id` - Идентификатор
- `patient_link` - Ссылка на пациента
- `procedure_type` - Тип процедуры с описанием
- `datetime_result` - Дата и время результата
- `author_info` - Информация об авторе
- `is_completed` - Статус заполнения
- `examination_plan_link` - Ссылка на план обследования
- `created_at` - Дата создания

**Фильтры**:
- По статусу заполнения (`is_completed`)
- По дате результата (`datetime_result`)
- По дате создания (`created_at`)
- По типу процедуры (`procedure_definition__name`)
- По плану обследования (`examination_plan__name`)

**Поиск**:
- По имени, фамилии и отчеству пациента
- По названию процедуры
- По названию плана обследования

**Группировка полей (fieldsets)**:
1. **Основная информация**
   - Пациент
   - Тип процедуры
   - План обследования

2. **Результат**
   - Дата и время результата
   - Данные результата (JSON)
   - Статус заполнения
   - Автор

3. **Предварительный просмотр данных** (сворачиваемый)
   - Читаемый вид JSON-данных

4. **Метаданные** (сворачиваемый)
   - Дата создания
   - Дата обновления

## Особенности реализации

### Кастомный виджет для JSON
- Используется `JSONDataWidget` для поля `data`
- Автоматическое форматирование JSON с отступами
- Поддержка кириллицы (`ensure_ascii=False`)

### Оптимизация производительности
- Использование `select_related` для связанных объектов
- Минимизация количества запросов к БД

### Ссылки между моделями
- Кликабельные ссылки на пациента
- Кликабельные ссылки на план обследования
- Переходы между связанными записями

### Улучшенное отображение
- Форматированный JSON в предварительном просмотре
- Информативные описания полей
- Группировка связанных данных

## Права доступа

Все операции разрешены для администраторов:
- ✅ Просмотр результатов
- ✅ Добавление новых результатов
- ✅ Редактирование существующих результатов
- ✅ Удаление результатов

## Настройки админки

```python
admin.site.site_header = 'Администрирование медицинской системы'
admin.site.site_title = 'МедКарта - Админка'
admin.site.index_title = 'Управление медицинскими данными'
```

## Использование

### Просмотр результатов
1. Войдите в админку Django
2. Перейдите в раздел "Lab test results"
3. Используйте фильтры для поиска нужных результатов
4. Кликните на результат для детального просмотра

### Редактирование результатов
1. Откройте результат для редактирования
2. Измените необходимые поля
3. JSON-данные автоматически форматируются
4. Сохраните изменения

### Добавление новых результатов
1. Нажмите "Добавить Lab test result"
2. Заполните обязательные поля
3. В поле "Данные результата" введите JSON
4. Сохраните результат

## Примеры JSON-данных

### Простой результат
```json
{
  "гемоглобин": {
    "value": "145",
    "unit": "г/л",
    "reference_range": "130-160",
    "status": "normal"
  },
  "эритроциты": {
    "value": "4.8",
    "unit": "10^12/л",
    "reference_range": "4.0-5.5",
    "status": "normal"
  }
}
```

### Сложный результат с вложенностью
```json
{
  "общий анализ крови": {
    "гемоглобин": {
      "value": "145",
      "unit": "г/л",
      "status": "normal"
    },
    "лейкоциты": {
      "value": "6.2",
      "unit": "10^9/л",
      "status": "normal"
    }
  },
  "заключение": "Показатели в пределах нормы"
}
```

## Интеграция с другими приложениями

- **patients** - связь с пациентами
- **examination_management** - связь с планами обследования
- **document_signatures** - подписи документов (через сигналы) 