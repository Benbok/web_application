{% extends 'patients/base.html' %}

{% block title %}Детали результата исследования{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Детали результата для {{ result.procedure_definition.name }}</h1>

    <div class="card shadow mb-4">
        <div class="card-body">
            <p><strong>Пациент:</strong> {{ result.patient.full_name }}</p>
            <p><strong>Тип исследования:</strong> {{ result.procedure_definition.name }}</p>
            <p><strong>Дата выполнения:</strong> {{ result.datetime_result|date:"d.m.Y H:i" }}</p>
            <p><strong>Врач:</strong> {{ result.author.doctor_profile.full_name|default:result.author.username }}</p>
            <p><strong>Статус:</strong> 
                {% if result.is_completed %}
                    <span class="badge bg-success">Заполнено</span>
                {% else %}
                    <span class="badge bg-warning">Ожидает заполнения</span>
                {% endif %}
            </p>
            
            <!-- Статус подписи -->
            <p><strong>Статус подписи:</strong> 
                {% load signature_tags %}
                {% get_signature_status result as signature_status %}
                {% if signature_status.status == 'all_signed' %}
                    <span class="badge bg-success">Подписано</span>
                {% elif signature_status.status == 'partially_signed' %}
                    <span class="badge bg-warning">Частично подписано</span>
                {% elif signature_status.status == 'no_signatures' %}
                    <span class="badge bg-secondary">Не подписано</span>
                {% else %}
                    <span class="badge bg-info">{{ signature_status.text }}</span>
                {% endif %}
            </p>
            {% if result.examination_plan %}
                <p><strong>План обследования:</strong> {{ result.examination_plan.name }}</p>
            {% endif %}

            <hr>
            <h4>Результаты:</h4>
            {% for key, value in result.data.items %}
                <p><strong>{{ key|capfirst }}:</strong> {{ value }}</p>
            {% endfor %}

            <a href="{% url 'lab_tests:result_list' %}" class="btn btn-secondary">Назад к списку</a>
            <a href="{% url 'lab_tests:result_update' result.pk %}" class="btn btn-primary">Редактировать</a>
            
            <!-- Действия с результатом -->
            <div class="mt-3">
                <!-- Кнопка подписания -->
                {% if result.is_completed %}
                    {% load signature_tags %}
                    {% get_signature_status result as signature_status %}
                    {% if signature_status.status != 'all_signed' %}
                        <form method="post" action="{% url 'lab_tests:result_sign' result.pk %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-signature"></i> Подписать документ
                            </button>
                        </form>
                    {% else %}
                        <span class="btn btn-success disabled">
                            <i class="fas fa-check"></i> Документ подписан
                        </span>
                    {% endif %}
                {% endif %}
                
                <!-- Кнопки отклонения и забраковки -->
                {% if not result.is_completed and signature_status.status != 'all_signed' %}
                    <a href="{% url 'lab_tests:result_reject' result.pk %}" class="btn btn-warning">
                        <i class="fas fa-times-circle"></i> Отклонить
                    </a>
                    <a href="{% url 'lab_tests:result_disqualify' result.pk %}" class="btn btn-danger">
                        <i class="fas fa-ban"></i> Забраковать
                    </a>
                {% endif %}
                
                <a href="{% url 'lab_tests:result_delete' result.pk %}" class="btn btn-outline-danger">
                    <i class="fas fa-trash"></i> Удалить
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}