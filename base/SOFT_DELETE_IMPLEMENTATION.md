# Реализация "Мягкого удаления" и синхронизации статусов

## Обзор

В медицинской системе реализован механизм "мягкого удаления" назначений и автоматической синхронизации их статусов с расписанием через Django сигналы.

## Архитектура

### 1. Мягкое удаление (Soft Delete)

Вместо физического удаления записей из базы данных, назначения помечаются как "отмененные" (`cancelled`) с сохранением всей истории изменений.

#### Модели с поддержкой мягкого удаления:

- `TreatmentPlan` (планы лечения)
- `TreatmentMedication` (лекарства в плане лечения)
- `TreatmentRecommendation` (рекомендации в плане лечения)
- `ExaminationPlan` (планы обследования)
- `ExaminationLabTest` (лабораторные исследования в плане обследования)
- `ExaminationInstrumental` (инструментальные исследования в плане обследования)

#### Статусы назначений:

- `active` - Активно
- `completed` - Завершено
- `cancelled` - Отменено (мягкое удаление)
- `paused` - Приостановлено
- `rejected` - Забраковано

### 2. Django сигналы для синхронизации

Система автоматически синхронизирует статусы назначений с запланированными событиями в `clinical_scheduling`.

#### Принцип работы:

1. **Назначение изменяет статус** → Django генерирует сигнал `post_save`
2. **Сигнал перехватывается** → Находятся связанные запланированные события
3. **Статус событий обновляется** → Синхронизация завершена

## Использование

### Отмена плана лечения (мягкое удаление)

```python
from treatment_management.models import TreatmentPlan

# Получаем план лечения
plan = TreatmentPlan.objects.get(pk=1)

# Отменяем план лечения (автоматически отменяет все активные назначения)
plan.cancel(
    reason="План лечения отменен",
    cancelled_by=request.user
)
```

### Отмена назначения (мягкое удаление)

```python
from treatment_management.models import TreatmentMedication

# Получаем назначение
medication = TreatmentMedication.objects.get(pk=1)

# Отменяем назначение
medication.cancel(
    reason="Пациент отказался от лечения",
    cancelled_by=request.user
)
```

### Приостановка назначения

```python
# Приостанавливаем назначение
medication.pause(
    reason="Временная аллергическая реакция",
    paused_by=request.user
)
```

### Возобновление назначения

```python
# Возобновляем приостановленное назначение
medication.resume()
```

### Завершение назначения

```python
# Завершаем назначение
medication.complete(
    notes="Курс лечения завершен успешно",
    completed_by=request.user
)
```

### Проверка статуса

```python
# Проверяем текущий статус
if medication.is_active():
    print("Назначение активно")
elif medication.is_cancelled():
    print("Назначение отменено")
elif medication.is_paused():
    print("Назначение приостановлено")
elif medication.is_completed():
    print("Назначение завершено")

# Получаем историю изменений статуса
history = medication.get_status_history()
for change in history:
    print(f"{change['status']}: {change['date']} - {change['reason']}")
```

## Веб-интерфейс

### Кнопки "Удаления" теперь используют Soft Delete

**Важно:** Все кнопки "Удаления" в веб-интерфейсе `treatment_management` теперь используют функционал мягкого удаления вместо физического удаления из базы данных.

#### Что происходит при нажатии кнопки "Отменить":

1. **Назначение помечается как "Отменено"** (`status = 'cancelled'`)
2. **Записывается причина отмены** (`cancellation_reason`)
3. **Записывается пользователь, отменивший** (`cancelled_by`)
4. **Записывается время отмены** (`cancelled_at`)
5. **Автоматически отменяются все связанные события** в расписании через Django сигналы
6. **Запись остается в базе данных** для полного аудита

#### Представления, использующие Soft Delete:

**В `treatment_management`:**
- **`TreatmentMedicationDeleteView`** - отмена назначения лекарства
- **`TreatmentRecommendationDeleteView`** - отмена рекомендации
- **`TreatmentPlanDeleteView`** - отмена плана лечения (включая все назначения)

**В `examination_management`:**
- **`ExaminationLabTestDeleteView`** - отмена лабораторного исследования
- **`ExaminationInstrumentalDeleteView`** - отмена инструментального исследования
- **`ExaminationPlanDeleteView`** - отмена плана обследования (включая все исследования)

#### Преимущества для пользователей:

- **Безопасность:** Невозможно случайно потерять важную медицинскую информацию
- **Аудит:** Полная история всех изменений сохраняется
- **Восстановление:** Отмененные назначения можно возобновить
- **Синхронизация:** Автоматическое обновление расписания

## Автоматическая синхронизация

### Как это работает:

1. **Отмена назначения** → Все будущие запланированные события помечаются как `canceled`
2. **Приостановка назначения** → Все будущие события помечаются как `skipped`
3. **Возобновление назначения** → Приостановленные события возвращаются в статус `scheduled`
4. **Завершение назначения** → Все события помечаются как `completed`

### Пример синхронизации:

```python
# В treatment_management/signals.py
@receiver(post_save, sender=TreatmentMedication)
def sync_treatment_medication_status(sender, instance, created, **kwargs):
    if created:
        return  # Новое назначение
    
    content_type = ContentType.objects.get_for_model(TreatmentMedication)
    scheduled_appointments = ScheduledAppointment.objects.filter(
        content_type=content_type,
        object_id=instance.pk
    )
    
    if instance.status == 'cancelled':
        # Отменяем все будущие события
        future_appointments = scheduled_appointments.filter(
            scheduled_date__gte=timezone.now().date()
        )
        for appointment in future_appointments:
            appointment.execution_status = 'canceled'
            appointment.save()
```

## Преимущества реализации

### 1. Сохранение истории
- Все изменения статуса записываются с указанием пользователя и времени
- Причины отмены/приостановки сохраняются для анализа
- Полная аудиторская трассировка

### 2. Автоматическая синхронизация
- Расписание автоматически обновляется при изменении статуса назначения
- Нет необходимости вручную обновлять связанные записи
- Консистентность данных между приложениями

### 3. Безопасность
- Физическое удаление не рекомендуется
- Все изменения логируются
- Возможность отката изменений

### 4. Производительность
- Использование `update_fields` для оптимизации обновлений
- Индексы на ключевых полях статуса
- Минимальное количество запросов к базе данных

## Миграции

### Создание миграций:

```bash
python manage.py makemigrations treatment_management
python manage.py makemigrations examination_management
```

### Применение миграций:

```bash
python manage.py migrate
```

## Административная панель

В админке Django добавлены поля для управления статусом:

- **Основная информация**: статус, инструкции
- **Статус**: детальная информация об изменениях (сворачиваемый блок)
- **Временные метки**: даты создания и обновления

## Рекомендации по использованию

### 1. Вместо физического удаления используйте отмену:

```python
# ❌ Не делайте так
medication.delete()

# ✅ Делайте так
medication.cancel(reason="Причина отмены", cancelled_by=user)
```

### 2. Всегда указывайте причину изменений:

```python
# ❌ Без причины
medication.pause(paused_by=user)

# ✅ С причиной
medication.pause(reason="Временная аллергическая реакция", paused_by=user)
```

### 3. Используйте проверки статуса:

```python
# Проверяйте возможность действия перед его выполнением
if medication.can_be_cancelled():
    medication.cancel(reason="Причина", cancelled_by=user)
else:
    raise ValidationError("Нельзя отменить это назначение")
```

### 4. Логируйте важные изменения:

```python
import logging
logger = logging.getLogger(__name__)

try:
    medication.cancel(reason="Причина", cancelled_by=user)
    logger.info(f"Назначение {medication.pk} отменено пользователем {user}")
except Exception as e:
    logger.error(f"Ошибка при отмене назначения {medication.pk}: {e}")
```

## Устранение неполадок

### Проблема: Сигналы не работают

**Решение**: Убедитесь, что в `apps.py` загружаются сигналы:

```python
def ready(self):
    try:
        import app_name.signals
    except ImportError:
        pass
```

### Проблема: Миграции не применяются

**Решение**: Проверьте зависимости между приложениями и порядок миграций.

### Проблема: Статусы не синхронизируются

**Решение**: Убедитесь, что `ContentType` правильно настроен и связанные записи существуют.

## Заключение

Реализация мягкого удаления и автоматической синхронизации обеспечивает:

- **Целостность данных** в медицинской системе
- **Полную историю** всех изменений
- **Автоматическую синхронизацию** между приложениями
- **Безопасность** и соответствие медицинским стандартам

Система готова к использованию в продакшене и может быть расширена дополнительной функциональностью по мере необходимости. 