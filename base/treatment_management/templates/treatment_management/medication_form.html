{% extends "patients/base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<style>
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .card-header {
        border-bottom: none;
    }
    
    .form-label.fw-bold {
        color: #495057;
    }
    
    .text-primary {
        color: #0d6efd !important;
    }
    
    .text-success {
        color: #198754 !important;
    }
    
    .text-info {
        color: #0dcaf0 !important;
    }
    
    #forms-grid .card,
    #regimens-grid .card {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    #forms-grid .card:hover,
    #regimens-grid .card:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .border-primary {
        border-color: #bbdefb !important;
    }
    
    .border-success {
        border-color: #c8e6c9 !important;
    }
    
    .border-warning {
        border-color: #fff3cd !important;
    }
    
    .border-info {
        border-color: #b2dfdb !important;
    }
    
    /* Мягкие цвета для заголовков карточек */
    .bg-primary {
        background-color: #e3f2fd !important;
        color: #1565c0 !important;
    }
    
    .bg-info {
        background-color: #e0f2f1 !important;
        color: #00695c !important;
    }
    
    .bg-success {
        background-color: #e8f5e8 !important;
        color: #2e7d32 !important;
    }
    
    /* Дополнительные мягкие цвета для текста внутри карточек */
    .text-primary {
        color: #1976d2 !important;
    }
    
    .text-success {
        color: #388e3c !important;
    }
    
    .text-info {
        color: #0097a7 !important;
    }
</style>
{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li{% if message.tags == "error" %} class="alert alert-danger"{% elif message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<div class="card mt-4">
    <div class="card-header">
        <h4 class="card-title mb-0">{{ title }}</h4>
                 <small class="text-muted">
             {% if owner.patient %}
                 Пациент: {{ owner.patient.get_full_name_with_age }} | 
             {% endif %}
             План: {{ treatment_plan.name }}
         </small>
    </div>
    <div class="card-body">
        <form method="post" novalidate>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- БЛОК 1: Выбор препарата -->
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-pills"></i> Выбор препарата
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.medication.id_for_label }}" class="form-label fw-bold">{{ form.medication.label }}</label>
                                {% autoescape off %}
                                {{ form.medication|add_class:"form-select" }}
                                {% endautoescape %}
                                {% if form.medication.help_text %}
                                    <div class="form-text">{{ form.medication.help_text }}</div>
                                {% endif %}
                                {% for error in form.medication.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.custom_medication.id_for_label }}" class="form-label fw-bold">{{ form.custom_medication.label }}</label>
                                {{ form.custom_medication|add_class:"form-control" }}
                                {% if form.custom_medication.help_text %}
                                    <div class="form-text">{{ form.custom_medication.help_text }}</div>
                                {% endif %}
                                {% for error in form.custom_medication.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- БЛОК 2: Выбор формы и схемы применения -->
            <div class="card mb-4 border-info" id="forms-schemes-container" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list-ul"></i> Выбор формы и схемы применения
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Выбор доступных форм препарата -->
                    <div class="mb-4" id="available-forms-container" style="display: none;">
                        <label class="form-label fw-bold text-primary">
                            <i class="fas fa-capsules"></i> Доступные формы препарата:
                        </label>
                        <div id="available-forms-content">
                            <div class="row" id="forms-grid">
                                <!-- Формы будут добавлены динамически -->
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Выберите форму для получения соответствующей информации о дозировке
                            </small>
                        </div>
                    </div>
                    
                    <!-- Выбор схемы применения -->
                    <div class="mb-3" id="regimens-container" style="display: none;">
                        <label class="form-label fw-bold text-success">
                            <i class="fas fa-clipboard-list"></i> Схемы применения:
                        </label>
                        <div id="regimens-content">
                            <div class="row" id="regimens-grid">
                                <!-- Схемы будут добавлены динамически -->
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Выберите схему для автоматического заполнения полей дозировки
                            </small>
                        </div>
                    </div>
                    
                    <!-- Поле для отображения ссылки на источник информации -->
                    <div class="mb-3" id="external-link-container" style="display: none;">
                        <label class="form-label fw-bold text-info">
                            <i class="fas fa-external-link-alt"></i> Источник информации о препарате:
                        </label>
                        <div id="external-link-content">
                            <div class="d-flex align-items-center gap-2">
                                <a href="#" id="external-link" target="_blank" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-external-link-alt"></i> Открыть информацию о препарате
                                </a>
                                <small class="text-muted" id="medication-info-text"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- БЛОК 3: Детали назначения -->
            <div class="card mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clipboard-prescription"></i> Детали назначения
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.dosage.id_for_label }}" class="form-label fw-bold">{{ form.dosage.label }}</label>
                                {{ form.dosage|add_class:"form-control" }}
                                {% if form.dosage.help_text %}
                                    <div class="form-text">{{ form.dosage.help_text }}</div>
                                {% endif %}
                                {% for error in form.dosage.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.frequency.id_for_label }}" class="form-label fw-bold">{{ form.frequency.label }}</label>
                                {{ form.frequency|add_class:"form-control" }}
                                {% if form.frequency.help_text %}
                                    <div class="form-text">{{ form.frequency.help_text }}</div>
                                {% endif %}
                                {% for error in form.frequency.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
            
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.route.id_for_label }}" class="form-label fw-bold">{{ form.route.label }}</label>
                                {{ form.route|add_class:"form-select" }}
                                {% if form.route.help_text %}
                                    <div class="form-text">{{ form.route.help_text }}</div>
                                {% endif %}
                                {% for error in form.route.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.duration.id_for_label }}" class="form-label fw-bold">{{ form.duration.label }}</label>
                                {{ form.duration|add_class:"form-control" }}
                                {% if form.duration.help_text %}
                                    <div class="form-text">{{ form.duration.help_text }}</div>
                                {% endif %}
                                {% for error in form.duration.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
            
                    <div class="mb-3">
                        <label for="{{ form.instructions.id_for_label }}" class="form-label fw-bold">{{ form.instructions.label }}</label>
                        {{ form.instructions|add_class:"form-control" }}
                        {% if form.instructions.help_text %}
                            <div class="form-text">{{ form.instructions.help_text }}</div>
                        {% endif %}
                        {% for error in form.instructions.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> {% if object %}Сохранить{% else %}Добавить лекарство{% endif %}
                </button>
                {% if owner_model == 'encounter' %}
                    <a href="{% url 'encounters:encounter_detail' pk=owner.id %}" 
                       class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> К случаю
                    </a>
                {% elif owner_model == 'patientdepartmentstatus' %}
                    <a href="{% url 'departments:patient_history' pk=owner.id %}" 
                       class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> К истории
                    </a>
                {% endif %}
                <a href="{% url 'treatment_management:plan_detail' owner_model=owner_model owner_id=owner.id pk=treatment_plan.pk %}" 
                   class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Назад
                </a>
            </div>
        </form>
    </div>
</div>

<script>
console.log('🚀 Скрипт загружен!');

// Глобальные функции для отображения форм и схем
function displayAvailableForms(forms, selectedFormId = null) {
    console.log(`🎨 Отображаем ${forms.length} доступных форм, выбранная: ${selectedFormId}`);
    
    const container = document.getElementById('available-forms-container');
    const grid = document.getElementById('forms-grid');
    
    if (!container || !grid) {
        console.error('❌ Не найдены элементы контейнера форм');
        return;
    }
    
    // Очищаем предыдущие формы
    grid.innerHTML = '';
    
    // Создаем карточки для каждой формы
    forms.forEach((form, index) => {
        const formCard = document.createElement('div');
        formCard.className = 'col-md-4 mb-2';
        
        const isSelected = selectedFormId && form.id == selectedFormId;
        const cardClass = isSelected ? 'border-primary' : 'border-secondary';
        
        // Создаем безопасное название формы для HTML
        const safeFormName = form.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
        const releaseFormName = form.release_form && form.release_form.name ? form.release_form.name : 'Форма не указана';
        
        // Добавляем информацию о количестве схем
        const regimensCount = form.regimens ? form.regimens.length : 0;
        const regimensInfo = regimensCount > 0 ? `<br><small class="text-info">${regimensCount} схем применения</small>` : '';
        
        formCard.innerHTML = `
            <div class="card ${cardClass} h-100 cursor-pointer" 
                 onclick="selectForm(${form.id}, '${safeFormName}')"
                 style="cursor: pointer; transition: all 0.2s;">
                <div class="card-body p-2 text-center">
                    <h6 class="card-title mb-1">${form.name}</h6>
                    <small class="text-muted">${releaseFormName}</small>
                    ${regimensInfo}
                    ${isSelected ? '<br><small class="text-primary"><i class="fas fa-check"></i> Выбрано</small>' : ''}
                </div>
            </div>
        `;
        
        grid.appendChild(formCard);
    });
    
    // Показываем контейнер
    container.style.display = 'block';
    
    // Показываем основной контейнер форм и схем
    const formsSchemesContainer = document.getElementById('forms-schemes-container');
    if (formsSchemesContainer) {
        formsSchemesContainer.style.display = 'block';
    }
    
    // Если выбрана форма, показываем схемы для неё
    if (selectedFormId) {
        const selectedForm = forms.find(f => f.id == selectedFormId);
        if (selectedForm && selectedForm.regimens) {
            displayRegimens(selectedForm.regimens, selectedForm.id);
        }
    }
}

function displayRegimens(regimens, formId) {
    console.log(`📋 Отображаем ${regimens.length} схем применения для формы ${formId}`);
    
    const container = document.getElementById('regimens-container');
    const grid = document.getElementById('regimens-grid');
    
    if (!container || !grid) {
        console.error('❌ Не найдены элементы контейнера схем');
        return;
    }
    
    // Очищаем предыдущие схемы
    grid.innerHTML = '';
    
    // Создаем карточки для каждой схемы
    regimens.forEach((regimen, index) => {
        const regimenCard = document.createElement('div');
        regimenCard.className = 'col-md-6 mb-2';
        
        const cardClass = regimen.is_suitable ? 'border-success' : 'border-warning';
        const suitabilityText = regimen.is_suitable ? 
            '<small class="text-success"><i class="fas fa-check-circle"></i> Подходит</small>' : 
            '<small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Проверьте</small>';
        
        regimenCard.innerHTML = `
            <div class="card ${cardClass} h-100 cursor-pointer" 
                 onclick="selectRegimen(${regimen.id}, '${regimen.name.replace(/'/g, "\\'").replace(/"/g, '\\"')}')"
                 style="cursor: pointer; transition: all 0.2s;">
                <div class="card-body p-2">
                    <h6 class="card-title mb-1">${regimen.name}</h6>
                    <div class="small text-muted">
                        <div class="regimen-dosage"><strong>Дозировка:</strong> ${regimen.dosage || 'Не указана'}</div>
                        <div class="regimen-frequency"><strong>Частота:</strong> ${regimen.frequency || 'Не указана'}</div>
                        <div class="regimen-route"><strong>Путь:</strong> ${regimen.route || 'Не указан'}</div>
                        <div class="regimen-duration"><strong>Длительность:</strong> ${regimen.duration || 'Не указана'}</div>
                    </div>
                    ${regimen.notes ? `<div class="mt-2"><small class="text-info">${regimen.notes}</small></div>` : ''}
                    ${suitabilityText}
                </div>
            </div>
        `;
        
        grid.appendChild(regimenCard);
    });
    
    // Показываем контейнер
    container.style.display = 'block';
}

// Глобальные функции для выбора форм и схем
async function selectForm(tradeNameId, formName) {
    console.log(`🎯 Выбрана форма: ${formName} (ID: ${tradeNameId})`);
    
    // Обновляем UI выбранной формы
    updateSelectedFormUI(tradeNameId);
    
    // Загружаем детальную информацию о выбранной форме
    try {
        const patientId = '{{ patient.id|default:"null" }}';
        const url = '{% url "treatment_management:trade_name_info" 0 %}'.replace('0', tradeNameId);
        let fullUrl = patientId && patientId !== 'null' ? `${url}?patient_id=${patientId}` : url;
        
        console.log(`📡 Загружаем информацию о форме: ${fullUrl}`);
        
        const response = await fetch(fullUrl);
        const data = await response.json();
        console.log('📡 Ответ API формы:', data);
        
        if (data.success && data.form_info) {
            console.log('✅ Получена информация о форме:', data.form_info);
            updateFormWithTradeNameInfo(data.form_info);
            
            // Показываем схемы применения для выбранной формы
            if (data.form_info.all_regimens) {
                displayRegimens(data.form_info.all_regimens, tradeNameId);
            }
        } else {
            console.error('❌ Не удалось получить информацию о форме');
        }
    } catch (error) {
        console.error('❌ Ошибка при загрузке информации о форме:', error);
    }
}

function selectRegimen(regimenId, regimenName) {
    console.log(`📋 Выбрана схема: ${regimenName} (ID: ${regimenId})`);
    
    // Обновляем UI выбранной схемы
    updateSelectedRegimenUI(regimenId);
    
    // Находим выбранную схему в данных
    const regimensContainer = document.getElementById('regimens-container');
    if (regimensContainer && regimensContainer.style.display !== 'none') {
        // Ищем схему в текущих данных
        const regimenCards = document.querySelectorAll('#regimens-grid .card');
        let selectedRegimen = null;
        
        regimenCards.forEach(card => {
            const onclickAttr = card.getAttribute('onclick');
            if (onclickAttr && onclickAttr.includes(`selectRegimen(${regimenId},`)) {
                // Извлекаем данные схемы из карточки используя классы
                const dosageElement = card.querySelector('.regimen-dosage');
                const frequencyElement = card.querySelector('.regimen-frequency');
                const routeElement = card.querySelector('.regimen-route');
                const durationElement = card.querySelector('.regimen-duration');
                
                const dosageText = dosageElement ? dosageElement.textContent.replace('Дозировка:', '').trim() : '';
                const frequencyText = frequencyElement ? frequencyElement.textContent.replace('Частота:', '').trim() : '';
                const routeText = routeElement ? routeElement.textContent.replace('Путь:', '').trim() : '';
                const durationText = durationElement ? durationElement.textContent.replace('Длительность:', '').trim() : '';
                
                selectedRegimen = {
                    id: regimenId,
                    name: regimenName,
                    dosage: dosageText,
                    frequency: frequencyText,
                    route: routeText,
                    duration: durationText
                };
            }
        });
        
        if (selectedRegimen) {
            // Заполняем поля формы выбранной схемой
            updateFormWithRegimenInfo(selectedRegimen);
        }
    }
}

// Глобальные функции для обновления UI
function updateSelectedFormUI(selectedFormId) {
    console.log(`🎨 Обновляем UI для выбранной формы ID: ${selectedFormId}`);
    const cards = document.querySelectorAll('#forms-grid .card');
    
    cards.forEach((card, index) => {
        // Извлекаем ID формы из onclick атрибута
        const onclickAttr = card.getAttribute('onclick');
        
        if (onclickAttr && onclickAttr.includes(`selectForm(${selectedFormId},`)) {
            card.classList.remove('border-secondary');
            card.classList.add('border-primary');
            // Обновляем текст "Выбрано"
            const selectedText = card.querySelector('.text-primary');
            if (selectedText) {
                selectedText.innerHTML = '<i class="fas fa-check"></i> Выбрано';
            }
        } else {
            card.classList.remove('border-primary');
            card.classList.add('border-secondary');
            // Убираем текст "Выбрано"
            const selectedText = card.querySelector('.text-primary');
            if (selectedText) {
                selectedText.innerHTML = '';
            }
        }
    });
}

function updateSelectedRegimenUI(selectedRegimenId) {
    console.log(`📋 Обновляем UI для выбранной схемы ID: ${selectedRegimenId}`);
    const cards = document.querySelectorAll('#regimens-grid .card');
    
    cards.forEach((card, index) => {
        // Извлекаем ID схемы из onclick атрибута
        const onclickAttr = card.getAttribute('onclick');
        
        if (onclickAttr && onclickAttr.includes(`selectRegimen(${selectedRegimenId},`)) {
            card.classList.remove('border-warning', 'border-success');
            card.classList.add('border-primary');
            // Добавляем текст "Выбрано"
            let selectedText = card.querySelector('.text-primary');
            if (!selectedText) {
                selectedText = document.createElement('div');
                selectedText.className = 'text-primary mt-2';
                card.querySelector('.card-body').appendChild(selectedText);
            }
            selectedText.innerHTML = '<i class="fas fa-check"></i> Выбрано';
        } else {
            // Возвращаем исходные классы
            const isSuitable = card.classList.contains('border-success') || card.classList.contains('border-warning');
            card.classList.remove('border-primary');
            if (isSuitable) {
                card.classList.add('border-success');
            } else {
                card.classList.add('border-warning');
            }
            // Убираем текст "Выбрано"
            const selectedText = card.querySelector('.text-primary');
            if (selectedText) {
                selectedText.remove();
            }
        }
    });
}

// Глобальные функции для обновления формы
function updateFormWithTradeNameInfo(formInfo) {
    console.log('📝 Обновляем форму с информацией:', formInfo);
    
    // Получаем элементы формы из DOM
    const dosageField = document.getElementById('{{ form.dosage.id_for_label }}');
    const frequencyField = document.getElementById('{{ form.frequency.id_for_label }}');
    const routeField = document.getElementById('{{ form.route.id_for_label }}');
    const durationField = document.getElementById('{{ form.duration.id_for_label }}');
    const instructionsField = document.getElementById('{{ form.instructions.id_for_label }}');
    const externalLinkContainer = document.getElementById('external-link-container');
    const externalLink = document.getElementById('external-link');
    
    // Обновляем поля формы
    if (dosageField && formInfo.dosage) dosageField.value = formInfo.dosage;
    if (frequencyField && formInfo.frequency) frequencyField.value = formInfo.frequency;
    if (routeField && formInfo.route) routeField.value = formInfo.route;
    if (durationField && formInfo.duration) durationField.value = formInfo.duration;
    if (instructionsField && formInfo.instructions) instructionsField.value = formInfo.instructions;
    
    // Обновляем внешнюю ссылку
    if (externalLinkContainer && externalLink && formInfo.external_url) {
        externalLink.href = formInfo.external_url;
        externalLinkContainer.style.display = 'block';
        
        // Обновляем текст информации
        const medicationInfoText = document.getElementById('medication-info-text');
        if (medicationInfoText) {
            let infoText = '';
            if (formInfo.name) {
                infoText += `Торговое название: ${formInfo.name}`;
            }
            if (formInfo.medication_name) {
                infoText += infoText ? ` | МНН: ${formInfo.medication_name}` : `МНН: ${formInfo.medication_name}`;
            }
            if (formInfo.release_form && formInfo.release_form.name) {
                infoText += infoText ? ` | Форма: ${formInfo.release_form.name}` : `Форма: ${formInfo.release_form.name}`;
            }
            
            medicationInfoText.textContent = infoText;
        }
    }
    
    // Показываем схемы применения, если они есть
    if (formInfo.all_regimens && formInfo.all_regimens.length > 0) {
        displayRegimens(formInfo.all_regimens, formInfo.id);
    } else {
        // Скрываем контейнер с схемами, если их нет
        const regimensContainer = document.getElementById('regimens-container');
        if (regimensContainer) regimensContainer.style.display = 'none';
    }
    
    // Показываем основной контейнер форм и схем
    const formsSchemesContainer = document.getElementById('forms-schemes-container');
    if (formsSchemesContainer) {
        formsSchemesContainer.style.display = 'block';
    }
}

function updateFormWithRegimenInfo(regimenInfo) {
    console.log('📝 Обновляем форму с информацией о схеме:', regimenInfo);
    
    // Получаем элементы формы из DOM
    const dosageField = document.getElementById('{{ form.dosage.id_for_label }}');
    const frequencyField = document.getElementById('{{ form.frequency.id_for_label }}');
    const routeField = document.getElementById('{{ form.route.id_for_label }}');
    const durationField = document.getElementById('{{ form.duration.id_for_label }}');
    const instructionsField = document.getElementById('{{ form.instructions.id_for_label }}');
    
    // Обновляем поля формы
    if (dosageField && regimenInfo.dosage) dosageField.value = regimenInfo.dosage;
    if (frequencyField && regimenInfo.frequency) frequencyField.value = regimenInfo.frequency;
    if (routeField && regimenInfo.route) routeField.value = regimenInfo.route;
    if (durationField && regimenInfo.duration) durationField.value = regimenInfo.duration;
    
    // Добавляем информацию о выбранной схеме в поле инструкций
    if (instructionsField) {
        let instructions = `Схема: ${regimenInfo.name}`;
        if (regimenInfo.dosage) instructions += ` | Дозировка: ${regimenInfo.dosage}`;
        if (regimenInfo.frequency) instructions += ` | Частота: ${regimenInfo.frequency}`;
        if (regimenInfo.route) instructions += ` | Путь: ${regimenInfo.route}`;
        if (regimenInfo.duration) instructions += ` | Длительность: ${regimenInfo.duration}`;
        
        instructionsField.value = instructions;
    }
    
    console.log('✅ Форма обновлена информацией о схеме применения');
}

// Основной код при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ DOM загружен!');
    
    const medicationField = document.getElementById('{{ form.medication.id_for_label }}');
    const customMedicationField = document.getElementById('{{ form.custom_medication.id_for_label }}');
    const dosageField = document.getElementById('{{ form.dosage.id_for_label }}');
    const frequencyField = document.getElementById('{{ form.frequency.id_for_label }}');
    const routeField = document.getElementById('{{ form.route.id_for_label }}');
    const durationField = document.getElementById('{{ form.duration.id_for_label }}');
    const instructionsField = document.getElementById('{{ form.instructions.id_for_label }}');
    const externalLinkContainer = document.getElementById('external-link-container');
    const externalLink = document.getElementById('external-link');
    
    // Переменная для хранения ID торгового наименования
    let currentTradeNameId = null;
    
    // Функция для очистки всех данных о препарате
    function clearAllMedicationData() {
        console.log('🧹 Очищаем все данные о препарате');
        
        // Очищаем поля формы
        if (dosageField) dosageField.value = '';
        if (frequencyField) frequencyField.value = '';
        if (routeField) routeField.value = 'oral';
        if (durationField) durationField.value = '';
        if (instructionsField) instructionsField.value = '';
        
        // Скрываем ссылку на источник
        if (externalLinkContainer) externalLinkContainer.style.display = 'none';
        
        // Очищаем и скрываем контейнер с доступными формами
        const availableFormsContainer = document.getElementById('available-forms-container');
        if (availableFormsContainer) {
            availableFormsContainer.style.display = 'none';
            const formsGrid = document.getElementById('forms-grid');
            if (formsGrid) formsGrid.innerHTML = '';
        }
        
        // Очищаем и скрываем контейнер с схемами
        const regimensContainer = document.getElementById('regimens-container');
        if (regimensContainer) {
            regimensContainer.style.display = 'none';
            const regimensGrid = document.getElementById('regimens-grid');
            if (regimensGrid) regimensGrid.innerHTML = '';
        }
        
        // Скрываем основной контейнер форм и схем
        const formsSchemesContainer = document.getElementById('forms-schemes-container');
        if (formsSchemesContainer) formsSchemesContainer.style.display = 'none';
        
        // Очищаем текст информации о препарате
        const medicationInfoText = document.getElementById('medication-info-text');
        if (medicationInfoText) medicationInfoText.textContent = '';
        
        console.log('✅ Все данные о препарате очищены');
    }
    
    // Функция для автоматического заполнения полей дозировки
    async function loadMedicationInfo(medicationId, tradeNameId = null) {
        console.log(`🔍 Загружаем информацию о препарате: ID=${medicationId}, TradeNameID=${tradeNameId}`);
        
        // Сначала очищаем все старые данные при загрузке нового препарата
        console.log('🧹 Очищаем старые данные о предыдущем препарате');
        clearAllMedicationData();
        
        if (!medicationId) {
            console.log('❌ ID препарата не указан, очищаем поля');
            return;
        }
        
        try {
            // Передаем ID пациента для учета возрастной группы
            const patientId = '{{ patient.id|default:"null" }}';
            const url = '{% url "treatment_management:medication_info" 0 %}'.replace('0', medicationId);
            let fullUrl = patientId && patientId !== 'null' ? `${url}?patient_id=${patientId}` : url;
            
            // Добавляем ID торгового наименования, если он есть
            if (tradeNameId) {
                fullUrl += (fullUrl.includes('?') ? '&' : '?') + `trade_name_id=${tradeNameId}`;
            }
            
            console.log(`📡 Запрос к API: ${fullUrl}`);
            const response = await fetch(fullUrl);
            const data = await response.json();
            console.log('📡 API ответ:', data);
            
            if (data.success && data.medication) {
                const med = data.medication;
                console.log('✅ Получены данные о препарате:', med);
                
                // Заполняем поля автоматически
                if (dosageField && med.dosage) dosageField.value = med.dosage;
                if (frequencyField && med.frequency) frequencyField.value = med.frequency;
                if (routeField && med.route) routeField.value = med.route;
                if (durationField && med.duration) durationField.value = med.duration;
                if (instructionsField && med.instructions) instructionsField.value = med.instructions;
                
                // Обрабатываем внешнюю ссылку и информацию о препарате
                if (externalLinkContainer && externalLink) {
                    const medicationInfoText = document.getElementById('medication-info-text');
                    
                    if (med.external_url) {
                        externalLink.href = med.external_url;
                        externalLinkContainer.style.display = 'block';
                        
                        // Отображаем дополнительную информацию о препарате
                        let infoText = '';
                        if (med.trade_name) {
                            infoText += `Торговое название: ${med.trade_name}`;
                        }
                        if (med.generic_concept) {
                            infoText = infoText == '' ? `МНН: ${med.generic_concept}` : infoText + ` | МНН: ${med.generic_concept}`;
                        }
                        if (med.medication_form) {
                            infoText = infoText == '' ? `Форма: ${med.medication_form}` : infoText + ` | Форма: ${med.medication_form}`;
                        }
                        
                        if (medicationInfoText) {
                            medicationInfoText.textContent = infoText;
                        }
                    } else {
                        externalLinkContainer.style.display = 'none';
                        if (medicationInfoText) medicationInfoText.textContent = '';
                    }
                }
                
                // Отображаем доступные формы препарата
                if (med.available_forms && med.available_forms.length > 0) {
                    console.log(`🎯 Найдено ${med.available_forms.length} доступных форм:`, med.available_forms);
                    displayAvailableForms(med.available_forms, tradeNameId);
                } else {
                    console.log('❌ Доступные формы не найдены');
                    // Скрываем контейнер если форм нет
                    const availableFormsContainer = document.getElementById('available-forms-container');
                    if (availableFormsContainer) availableFormsContainer.style.display = 'none';
                    // Скрываем контейнер с схемами
                    const regimensContainer = document.getElementById('regimens-container');
                    if (regimensContainer) regimensContainer.style.display = 'none';
                }
            }
        } catch (error) {
            console.error('❌ Ошибка при загрузке информации о препарате:', error);
        }
    }
    
    // Показываем/скрываем поля в зависимости от выбора
    function toggleFields() {
        const hasMedication = medicationField.value !== '';
        const hasCustomMedication = customMedicationField.value.trim() !== '';
        
        if (hasMedication && hasCustomMedication) {
            alert('Выберите либо препарат из справочника, либо введите собственный препарат');
            // Очищаем поле собственного препарата
            customMedicationField.value = '';
            return;
        }
        
        // Если выбрано поле собственного препарата, очищаем поле препарата из справочника
        if (hasCustomMedication && hasMedication) {
            medicationField.value = '';
            currentTradeNameId = null;
        }
    }
    
    // Для select2 используем правильные события
    $(medicationField).on('select2:select', function(e) {
        toggleFields();
        // Сохраняем ID торгового наименования
        currentTradeNameId = e.params.data.trade_name_id || null;
        loadMedicationInfo(e.params.data.id, currentTradeNameId);
    });
    
    $(medicationField).on('select2:clear', function(e) {
        toggleFields();
        currentTradeNameId = null;
        clearAllMedicationData();
    });
    
    // Также добавляем обычный слушатель change на случай
    medicationField.addEventListener('change', function() {
        toggleFields();
        if (this.value) {
            loadMedicationInfo(this.value, currentTradeNameId);
        } else {
            clearAllMedicationData();
        }
    });
    
    customMedicationField.addEventListener('input', function() {
        toggleFields();
        // Если вводится собственный препарат, очищаем данные о препарате из справочника
        if (this.value.trim() !== '') {
            clearAllMedicationData();
        }
    });
    
    // Загружаем информацию о лекарстве при загрузке страницы, если оно уже выбрано
    if (medicationField.value) {
        loadMedicationInfo(medicationField.value, currentTradeNameId);
    }
    
    // Вызываем toggleFields при загрузке
    toggleFields();
});

</script>
{% endblock %} 