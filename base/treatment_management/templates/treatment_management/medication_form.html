{% extends "patients/base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<style>
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .card-header {
        border-bottom: none;
    }
    
    .form-label.fw-bold {
        color: #495057;
    }
    
    .text-primary {
        color: #0d6efd !important;
    }
    
    .text-success {
        color: #198754 !important;
    }
    
    .text-info {
        color: #0dcaf0 !important;
    }
    
    #forms-grid .card,
    #regimens-grid .card {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    #forms-grid .card:hover,
    #regimens-grid .card:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .border-primary {
        border-color: #bbdefb !important;
    }
    
    .border-success {
        border-color: #c8e6c9 !important;
    }
    
    .border-warning {
        border-color: #fff3cd !important;
    }
    
    .border-info {
        border-color: #b2dfdb !important;
    }
    
    /* –ú—è–≥–∫–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .bg-primary {
        background-color: #e3f2fd !important;
        color: #1565c0 !important;
    }
    
    .bg-info {
        background-color: #e0f2f1 !important;
        color: #00695c !important;
    }
    
    .bg-success {
        background-color: #e8f5e8 !important;
        color: #2e7d32 !important;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º—è–≥–∫–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .text-primary {
        color: #1976d2 !important;
    }
    
    .text-success {
        color: #388e3c !important;
    }
    
    .text-info {
        color: #0097a7 !important;
    }
</style>
{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li{% if message.tags == "error" %} class="alert alert-danger"{% elif message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<div class="card mt-4">
    <div class="card-header">
        <h4 class="card-title mb-0">{{ title }}</h4>
                 <small class="text-muted">
             {% if owner.patient %}
                 –ü–∞—Ü–∏–µ–Ω—Ç: {{ owner.patient.get_full_name_with_age }} | 
             {% endif %}
             –ü–ª–∞–Ω: {{ treatment_plan.name }}
         </small>
    </div>
    <div class="card-body">
        <form method="post" novalidate>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- –ë–õ–û–ö 1: –í—ã–±–æ—Ä –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ -->
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-pills"></i> –í—ã–±–æ—Ä –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.medication.id_for_label }}" class="form-label fw-bold">{{ form.medication.label }}</label>
                                {% autoescape off %}
                                {{ form.medication|add_class:"form-select" }}
                                {% endautoescape %}
                                {% if form.medication.help_text %}
                                    <div class="form-text">{{ form.medication.help_text }}</div>
                                {% endif %}
                                {% for error in form.medication.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.custom_medication.id_for_label }}" class="form-label fw-bold">{{ form.custom_medication.label }}</label>
                                {{ form.custom_medication|add_class:"form-control" }}
                                {% if form.custom_medication.help_text %}
                                    <div class="form-text">{{ form.custom_medication.help_text }}</div>
                                {% endif %}
                                {% for error in form.custom_medication.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ë–õ–û–ö 2: –í—ã–±–æ—Ä —Ñ–æ—Ä–º—ã –∏ —Å—Ö–µ–º—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è -->
            <div class="card mb-4 border-info" id="forms-schemes-container" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list-ul"></i> –í—ã–±–æ—Ä —Ñ–æ—Ä–º—ã –∏ —Å—Ö–µ–º—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
                    </h5>
                </div>
                <div class="card-body">
                    <!-- –í—ã–±–æ—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ä–º –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ -->
                    <div class="mb-4" id="available-forms-container" style="display: none;">
                        <label class="form-label fw-bold text-primary">
                            <i class="fas fa-capsules"></i> –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º—ã –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:
                        </label>
                        <div id="available-forms-content">
                            <div class="row" id="forms-grid">
                                <!-- –§–æ—Ä–º—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ–∑–∏—Ä–æ–≤–∫–µ
                            </small>
                        </div>
                    </div>
                    
                    <!-- –í—ã–±–æ—Ä —Å—Ö–µ–º—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è -->
                    <div class="mb-3" id="regimens-container" style="display: none;">
                        <label class="form-label fw-bold text-success">
                            <i class="fas fa-clipboard-list"></i> –°—Ö–µ–º—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:
                        </label>
                        <div id="regimens-content">
                            <div class="row" id="regimens-grid">
                                <!-- –°—Ö–µ–º—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ö–µ–º—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π –¥–æ–∑–∏—Ä–æ–≤–∫–∏
                            </small>
                        </div>
                    </div>
                    
                    <!-- –ü–æ–ª–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
                    <div class="mb-3" id="external-link-container" style="display: none;">
                        <label class="form-label fw-bold text-info">
                            <i class="fas fa-external-link-alt"></i> –ò—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ:
                        </label>
                        <div id="external-link-content">
                            <div class="d-flex align-items-center gap-2">
                                <a href="#" id="external-link" target="_blank" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-external-link-alt"></i> –û—Ç–∫—Ä—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ
                                </a>
                                <small class="text-muted" id="medication-info-text"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ë–õ–û–ö 3: –î–µ—Ç–∞–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è -->
            <div class="card mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clipboard-prescription"></i> –î–µ—Ç–∞–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.dosage.id_for_label }}" class="form-label fw-bold">{{ form.dosage.label }}</label>
                                {{ form.dosage|add_class:"form-control" }}
                                {% if form.dosage.help_text %}
                                    <div class="form-text">{{ form.dosage.help_text }}</div>
                                {% endif %}
                                {% for error in form.dosage.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.frequency.id_for_label }}" class="form-label fw-bold">{{ form.frequency.label }}</label>
                                {{ form.frequency|add_class:"form-control" }}
                                {% if form.frequency.help_text %}
                                    <div class="form-text">{{ form.frequency.help_text }}</div>
                                {% endif %}
                                {% for error in form.frequency.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
            
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.route.id_for_label }}" class="form-label fw-bold">{{ form.route.label }}</label>
                                {{ form.route|add_class:"form-select" }}
                                {% if form.route.help_text %}
                                    <div class="form-text">{{ form.route.help_text }}</div>
                                {% endif %}
                                {% for error in form.route.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.duration.id_for_label }}" class="form-label fw-bold">{{ form.duration.label }}</label>
                                {{ form.duration|add_class:"form-control" }}
                                {% if form.duration.help_text %}
                                    <div class="form-text">{{ form.duration.help_text }}</div>
                                {% endif %}
                                {% for error in form.duration.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
            
                    <div class="mb-3">
                        <label for="{{ form.instructions.id_for_label }}" class="form-label fw-bold">{{ form.instructions.label }}</label>
                        {{ form.instructions|add_class:"form-control" }}
                        {% if form.instructions.help_text %}
                            <div class="form-text">{{ form.instructions.help_text }}</div>
                        {% endif %}
                        {% for error in form.instructions.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> {% if object %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å{% else %}–î–æ–±–∞–≤–∏—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–æ{% endif %}
                </button>
                {% if owner_model == 'encounter' %}
                    <a href="{% url 'encounters:encounter_detail' pk=owner.id %}" 
                       class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> –ö —Å–ª—É—á–∞—é
                    </a>
                {% elif owner_model == 'patientdepartmentstatus' %}
                    <a href="{% url 'departments:patient_history' pk=owner.id %}" 
                       class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> –ö –∏—Å—Ç–æ—Ä–∏–∏
                    </a>
                {% endif %}
                <a href="{% url 'treatment_management:plan_detail' owner_model=owner_model owner_id=owner.id pk=treatment_plan.pk %}" 
                   class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                </a>
            </div>
        </form>
    </div>
</div>

<script>
console.log('üöÄ –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ä–º –∏ —Å—Ö–µ–º
function displayAvailableForms(forms, selectedFormId = null) {
    console.log(`üé® –û—Ç–æ–±—Ä–∞–∂–∞–µ–º ${forms.length} –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ä–º, –≤—ã–±—Ä–∞–Ω–Ω–∞—è: ${selectedFormId}`);
    
    const container = document.getElementById('available-forms-container');
    const grid = document.getElementById('forms-grid');
    
    if (!container || !grid) {
        console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ñ–æ—Ä–º');
        return;
    }
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ñ–æ—Ä–º—ã
    grid.innerHTML = '';
    
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–æ—Ä–º—ã
    forms.forEach((form, index) => {
        const formCard = document.createElement('div');
        formCard.className = 'col-md-4 mb-2';
        
        const isSelected = selectedFormId && form.id == selectedFormId;
        const cardClass = isSelected ? 'border-primary' : 'border-secondary';
        
        // –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–ª—è HTML
        const safeFormName = form.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
        const releaseFormName = form.release_form && form.release_form.name ? form.release_form.name : '–§–æ—Ä–º–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å—Ö–µ–º
        const regimensCount = form.regimens ? form.regimens.length : 0;
        const regimensInfo = regimensCount > 0 ? `<br><small class="text-info">${regimensCount} —Å—Ö–µ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è</small>` : '';
        
        formCard.innerHTML = `
            <div class="card ${cardClass} h-100 cursor-pointer" 
                 onclick="selectForm(${form.id}, '${safeFormName}')"
                 style="cursor: pointer; transition: all 0.2s;">
                <div class="card-body p-2 text-center">
                    <h6 class="card-title mb-1">${form.name}</h6>
                    <small class="text-muted">${releaseFormName}</small>
                    ${regimensInfo}
                    ${isSelected ? '<br><small class="text-primary"><i class="fas fa-check"></i> –í—ã–±—Ä–∞–Ω–æ</small>' : ''}
                </div>
            </div>
        `;
        
        grid.appendChild(formCard);
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    container.style.display = 'block';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ä–º –∏ —Å—Ö–µ–º
    const formsSchemesContainer = document.getElementById('forms-schemes-container');
    if (formsSchemesContainer) {
        formsSchemesContainer.style.display = 'block';
    }
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —Ñ–æ—Ä–º–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ö–µ–º—ã –¥–ª—è –Ω–µ—ë
    if (selectedFormId) {
        const selectedForm = forms.find(f => f.id == selectedFormId);
        if (selectedForm && selectedForm.regimens) {
            displayRegimens(selectedForm.regimens, selectedForm.id);
        }
    }
}

function displayRegimens(regimens, formId) {
    console.log(`üìã –û—Ç–æ–±—Ä–∞–∂–∞–µ–º ${regimens.length} —Å—Ö–µ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —Ñ–æ—Ä–º—ã ${formId}`);
    
    const container = document.getElementById('regimens-container');
    const grid = document.getElementById('regimens-grid');
    
    if (!container || !grid) {
        console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å—Ö–µ–º');
        return;
    }
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ö–µ–º—ã
    grid.innerHTML = '';
    
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ö–µ–º—ã
    regimens.forEach((regimen, index) => {
        const regimenCard = document.createElement('div');
        regimenCard.className = 'col-md-6 mb-2';
        
        const cardClass = regimen.is_suitable ? 'border-success' : 'border-warning';
        const suitabilityText = regimen.is_suitable ? 
            '<small class="text-success"><i class="fas fa-check-circle"></i> –ü–æ–¥—Ö–æ–¥–∏—Ç</small>' : 
            '<small class="text-warning"><i class="fas fa-exclamation-triangle"></i> –ü—Ä–æ–≤–µ—Ä—å—Ç–µ</small>';
        
        regimenCard.innerHTML = `
            <div class="card ${cardClass} h-100 cursor-pointer" 
                 onclick="selectRegimen(${regimen.id}, '${regimen.name.replace(/'/g, "\\'").replace(/"/g, '\\"')}')"
                 style="cursor: pointer; transition: all 0.2s;">
                <div class="card-body p-2">
                    <h6 class="card-title mb-1">${regimen.name}</h6>
                    <div class="small text-muted">
                        <div class="regimen-dosage"><strong>–î–æ–∑–∏—Ä–æ–≤–∫–∞:</strong> ${regimen.dosage || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                        <div class="regimen-frequency"><strong>–ß–∞—Å—Ç–æ—Ç–∞:</strong> ${regimen.frequency || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                        <div class="regimen-route"><strong>–ü—É—Ç—å:</strong> ${regimen.route || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                        <div class="regimen-duration"><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${regimen.duration || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                    </div>
                    ${regimen.notes ? `<div class="mt-2"><small class="text-info">${regimen.notes}</small></div>` : ''}
                    ${suitabilityText}
                </div>
            </div>
        `;
        
        grid.appendChild(regimenCard);
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    container.style.display = 'block';
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ä–º –∏ —Å—Ö–µ–º
async function selectForm(tradeNameId, formName) {
    console.log(`üéØ –í—ã–±—Ä–∞–Ω–∞ —Ñ–æ—Ä–º–∞: ${formName} (ID: ${tradeNameId})`);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã
    updateSelectedFormUI(tradeNameId);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ
    try {
        const patientId = '{{ patient.id|default:"null" }}';
        const url = '{% url "treatment_management:trade_name_info" 0 %}'.replace('0', tradeNameId);
        let fullUrl = patientId && patientId !== 'null' ? `${url}?patient_id=${patientId}` : url;
        
        console.log(`üì° –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–æ—Ä–º–µ: ${fullUrl}`);
        
        const response = await fetch(fullUrl);
        const data = await response.json();
        console.log('üì° –û—Ç–≤–µ—Ç API —Ñ–æ—Ä–º—ã:', data);
        
        if (data.success && data.form_info) {
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–æ—Ä–º–µ:', data.form_info);
            updateFormWithTradeNameInfo(data.form_info);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ö–µ–º—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã
            if (data.form_info.all_regimens) {
                displayRegimens(data.form_info.all_regimens, tradeNameId);
            }
        } else {
            console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–æ—Ä–º–µ');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–æ—Ä–º–µ:', error);
    }
}

function selectRegimen(regimenId, regimenName) {
    console.log(`üìã –í—ã–±—Ä–∞–Ω–∞ —Å—Ö–µ–º–∞: ${regimenName} (ID: ${regimenId})`);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ö–µ–º—ã
    updateSelectedRegimenUI(regimenId);
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ö–µ–º—É –≤ –¥–∞–Ω–Ω—ã—Ö
    const regimensContainer = document.getElementById('regimens-container');
    if (regimensContainer && regimensContainer.style.display !== 'none') {
        // –ò—â–µ–º —Å—Ö–µ–º—É –≤ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        const regimenCards = document.querySelectorAll('#regimens-grid .card');
        let selectedRegimen = null;
        
        regimenCards.forEach(card => {
            const onclickAttr = card.getAttribute('onclick');
            if (onclickAttr && onclickAttr.includes(`selectRegimen(${regimenId},`)) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—è –∫–ª–∞—Å—Å—ã
                const dosageElement = card.querySelector('.regimen-dosage');
                const frequencyElement = card.querySelector('.regimen-frequency');
                const routeElement = card.querySelector('.regimen-route');
                const durationElement = card.querySelector('.regimen-duration');
                
                const dosageText = dosageElement ? dosageElement.textContent.replace('–î–æ–∑–∏—Ä–æ–≤–∫–∞:', '').trim() : '';
                const frequencyText = frequencyElement ? frequencyElement.textContent.replace('–ß–∞—Å—Ç–æ—Ç–∞:', '').trim() : '';
                const routeText = routeElement ? routeElement.textContent.replace('–ü—É—Ç—å:', '').trim() : '';
                const durationText = durationElement ? durationElement.textContent.replace('–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:', '').trim() : '';
                
                selectedRegimen = {
                    id: regimenId,
                    name: regimenName,
                    dosage: dosageText,
                    frequency: frequencyText,
                    route: routeText,
                    duration: durationText
                };
            }
        });
        
        if (selectedRegimen) {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ö–µ–º–æ–π
            updateFormWithRegimenInfo(selectedRegimen);
        }
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
function updateSelectedFormUI(selectedFormId) {
    console.log(`üé® –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã ID: ${selectedFormId}`);
    const cards = document.querySelectorAll('#forms-grid .card');
    
    cards.forEach((card, index) => {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Ñ–æ—Ä–º—ã –∏–∑ onclick –∞—Ç—Ä–∏–±—É—Ç–∞
        const onclickAttr = card.getAttribute('onclick');
        
        if (onclickAttr && onclickAttr.includes(`selectForm(${selectedFormId},`)) {
            card.classList.remove('border-secondary');
            card.classList.add('border-primary');
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç "–í—ã–±—Ä–∞–Ω–æ"
            const selectedText = card.querySelector('.text-primary');
            if (selectedText) {
                selectedText.innerHTML = '<i class="fas fa-check"></i> –í—ã–±—Ä–∞–Ω–æ';
            }
        } else {
            card.classList.remove('border-primary');
            card.classList.add('border-secondary');
            // –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç "–í—ã–±—Ä–∞–Ω–æ"
            const selectedText = card.querySelector('.text-primary');
            if (selectedText) {
                selectedText.innerHTML = '';
            }
        }
    });
}

function updateSelectedRegimenUI(selectedRegimenId) {
    console.log(`üìã –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ö–µ–º—ã ID: ${selectedRegimenId}`);
    const cards = document.querySelectorAll('#regimens-grid .card');
    
    cards.forEach((card, index) => {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Å—Ö–µ–º—ã –∏–∑ onclick –∞—Ç—Ä–∏–±—É—Ç–∞
        const onclickAttr = card.getAttribute('onclick');
        
        if (onclickAttr && onclickAttr.includes(`selectRegimen(${selectedRegimenId},`)) {
            card.classList.remove('border-warning', 'border-success');
            card.classList.add('border-primary');
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç "–í—ã–±—Ä–∞–Ω–æ"
            let selectedText = card.querySelector('.text-primary');
            if (!selectedText) {
                selectedText = document.createElement('div');
                selectedText.className = 'text-primary mt-2';
                card.querySelector('.card-body').appendChild(selectedText);
            }
            selectedText.innerHTML = '<i class="fas fa-check"></i> –í—ã–±—Ä–∞–Ω–æ';
        } else {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –∫–ª–∞—Å—Å—ã
            const isSuitable = card.classList.contains('border-success') || card.classList.contains('border-warning');
            card.classList.remove('border-primary');
            if (isSuitable) {
                card.classList.add('border-success');
            } else {
                card.classList.add('border-warning');
            }
            // –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç "–í—ã–±—Ä–∞–Ω–æ"
            const selectedText = card.querySelector('.text-primary');
            if (selectedText) {
                selectedText.remove();
            }
        }
    });
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
function updateFormWithTradeNameInfo(formInfo) {
    console.log('üìù –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:', formInfo);
    
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –∏–∑ DOM
    const dosageField = document.getElementById('{{ form.dosage.id_for_label }}');
    const frequencyField = document.getElementById('{{ form.frequency.id_for_label }}');
    const routeField = document.getElementById('{{ form.route.id_for_label }}');
    const durationField = document.getElementById('{{ form.duration.id_for_label }}');
    const instructionsField = document.getElementById('{{ form.instructions.id_for_label }}');
    const externalLinkContainer = document.getElementById('external-link-container');
    const externalLink = document.getElementById('external-link');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
    if (dosageField && formInfo.dosage) dosageField.value = formInfo.dosage;
    if (frequencyField && formInfo.frequency) frequencyField.value = formInfo.frequency;
    if (routeField && formInfo.route) routeField.value = formInfo.route;
    if (durationField && formInfo.duration) durationField.value = formInfo.duration;
    if (instructionsField && formInfo.instructions) instructionsField.value = formInfo.instructions;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É
    if (externalLinkContainer && externalLink && formInfo.external_url) {
        externalLink.href = formInfo.external_url;
        externalLinkContainer.style.display = 'block';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        const medicationInfoText = document.getElementById('medication-info-text');
        if (medicationInfoText) {
            let infoText = '';
            if (formInfo.name) {
                infoText += `–¢–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: ${formInfo.name}`;
            }
            if (formInfo.medication_name) {
                infoText += infoText ? ` | –ú–ù–ù: ${formInfo.medication_name}` : `–ú–ù–ù: ${formInfo.medication_name}`;
            }
            if (formInfo.release_form && formInfo.release_form.name) {
                infoText += infoText ? ` | –§–æ—Ä–º–∞: ${formInfo.release_form.name}` : `–§–æ—Ä–º–∞: ${formInfo.release_form.name}`;
            }
            
            medicationInfoText.textContent = infoText;
        }
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ö–µ–º—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (formInfo.all_regimens && formInfo.all_regimens.length > 0) {
        displayRegimens(formInfo.all_regimens, formInfo.id);
    } else {
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å—Ö–µ–º–∞–º–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        const regimensContainer = document.getElementById('regimens-container');
        if (regimensContainer) regimensContainer.style.display = 'none';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ä–º –∏ —Å—Ö–µ–º
    const formsSchemesContainer = document.getElementById('forms-schemes-container');
    if (formsSchemesContainer) {
        formsSchemesContainer.style.display = 'block';
    }
}

function updateFormWithRegimenInfo(regimenInfo) {
    console.log('üìù –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ö–µ–º–µ:', regimenInfo);
    
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –∏–∑ DOM
    const dosageField = document.getElementById('{{ form.dosage.id_for_label }}');
    const frequencyField = document.getElementById('{{ form.frequency.id_for_label }}');
    const routeField = document.getElementById('{{ form.route.id_for_label }}');
    const durationField = document.getElementById('{{ form.duration.id_for_label }}');
    const instructionsField = document.getElementById('{{ form.instructions.id_for_label }}');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
    if (dosageField && regimenInfo.dosage) dosageField.value = regimenInfo.dosage;
    if (frequencyField && regimenInfo.frequency) frequencyField.value = regimenInfo.frequency;
    if (routeField && regimenInfo.route) routeField.value = regimenInfo.route;
    if (durationField && regimenInfo.duration) durationField.value = regimenInfo.duration;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ö–µ–º–µ –≤ –ø–æ–ª–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
    if (instructionsField) {
        let instructions = `–°—Ö–µ–º–∞: ${regimenInfo.name}`;
        if (regimenInfo.dosage) instructions += ` | –î–æ–∑–∏—Ä–æ–≤–∫–∞: ${regimenInfo.dosage}`;
        if (regimenInfo.frequency) instructions += ` | –ß–∞—Å—Ç–æ—Ç–∞: ${regimenInfo.frequency}`;
        if (regimenInfo.route) instructions += ` | –ü—É—Ç—å: ${regimenInfo.route}`;
        if (regimenInfo.duration) instructions += ` | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${regimenInfo.duration}`;
        
        instructionsField.value = instructions;
    }
    
    console.log('‚úÖ –§–æ—Ä–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ö–µ–º–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è');
}

// –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω!');
    
    const medicationField = document.getElementById('{{ form.medication.id_for_label }}');
    const customMedicationField = document.getElementById('{{ form.custom_medication.id_for_label }}');
    const dosageField = document.getElementById('{{ form.dosage.id_for_label }}');
    const frequencyField = document.getElementById('{{ form.frequency.id_for_label }}');
    const routeField = document.getElementById('{{ form.route.id_for_label }}');
    const durationField = document.getElementById('{{ form.duration.id_for_label }}');
    const instructionsField = document.getElementById('{{ form.instructions.id_for_label }}');
    const externalLinkContainer = document.getElementById('external-link-container');
    const externalLink = document.getElementById('external-link');
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
    let currentTradeNameId = null;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ
    function clearAllMedicationData() {
        console.log('üßπ –û—á–∏—â–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ');
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
        if (dosageField) dosageField.value = '';
        if (frequencyField) frequencyField.value = '';
        if (routeField) routeField.value = 'oral';
        if (durationField) durationField.value = '';
        if (instructionsField) instructionsField.value = '';
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫
        if (externalLinkContainer) externalLinkContainer.style.display = 'none';
        
        // –û—á–∏—â–∞–µ–º –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞–º–∏
        const availableFormsContainer = document.getElementById('available-forms-container');
        if (availableFormsContainer) {
            availableFormsContainer.style.display = 'none';
            const formsGrid = document.getElementById('forms-grid');
            if (formsGrid) formsGrid.innerHTML = '';
        }
        
        // –û—á–∏—â–∞–µ–º –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å—Ö–µ–º–∞–º–∏
        const regimensContainer = document.getElementById('regimens-container');
        if (regimensContainer) {
            regimensContainer.style.display = 'none';
            const regimensGrid = document.getElementById('regimens-grid');
            if (regimensGrid) regimensGrid.innerHTML = '';
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ä–º –∏ —Å—Ö–µ–º
        const formsSchemesContainer = document.getElementById('forms-schemes-container');
        if (formsSchemesContainer) formsSchemesContainer.style.display = 'none';
        
        // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ
        const medicationInfoText = document.getElementById('medication-info-text');
        if (medicationInfoText) medicationInfoText.textContent = '';
        
        console.log('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ –æ—á–∏—â–µ–Ω—ã');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π –¥–æ–∑–∏—Ä–æ–≤–∫–∏
    async function loadMedicationInfo(medicationId, tradeNameId = null) {
        console.log(`üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ: ID=${medicationId}, TradeNameID=${tradeNameId}`);
        
        // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
        console.log('üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ');
        clearAllMedicationData();
        
        if (!medicationId) {
            console.log('‚ùå ID –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω, –æ—á–∏—â–∞–µ–º –ø–æ–ª—è');
            return;
        }
        
        try {
            // –ü–µ—Ä–µ–¥–∞–µ–º ID –ø–∞—Ü–∏–µ–Ω—Ç–∞ –¥–ª—è —É—á–µ—Ç–∞ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã
            const patientId = '{{ patient.id|default:"null" }}';
            const url = '{% url "treatment_management:medication_info" 0 %}'.replace('0', medicationId);
            let fullUrl = patientId && patientId !== 'null' ? `${url}?patient_id=${patientId}` : url;
            
            // –î–æ–±–∞–≤–ª—è–µ–º ID —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (tradeNameId) {
                fullUrl += (fullUrl.includes('?') ? '&' : '?') + `trade_name_id=${tradeNameId}`;
            }
            
            console.log(`üì° –ó–∞–ø—Ä–æ—Å –∫ API: ${fullUrl}`);
            const response = await fetch(fullUrl);
            const data = await response.json();
            console.log('üì° API –æ—Ç–≤–µ—Ç:', data);
            
            if (data.success && data.medication) {
                const med = data.medication;
                console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ:', med);
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                if (dosageField && med.dosage) dosageField.value = med.dosage;
                if (frequencyField && med.frequency) frequencyField.value = med.frequency;
                if (routeField && med.route) routeField.value = med.route;
                if (durationField && med.duration) durationField.value = med.duration;
                if (instructionsField && med.instructions) instructionsField.value = med.instructions;
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ
                if (externalLinkContainer && externalLink) {
                    const medicationInfoText = document.getElementById('medication-info-text');
                    
                    if (med.external_url) {
                        externalLink.href = med.external_url;
                        externalLinkContainer.style.display = 'block';
                        
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ
                        let infoText = '';
                        if (med.trade_name) {
                            infoText += `–¢–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: ${med.trade_name}`;
                        }
                        if (med.generic_concept) {
                            infoText = infoText == '' ? `–ú–ù–ù: ${med.generic_concept}` : infoText + ` | –ú–ù–ù: ${med.generic_concept}`;
                        }
                        if (med.medication_form) {
                            infoText = infoText == '' ? `–§–æ—Ä–º–∞: ${med.medication_form}` : infoText + ` | –§–æ—Ä–º–∞: ${med.medication_form}`;
                        }
                        
                        if (medicationInfoText) {
                            medicationInfoText.textContent = infoText;
                        }
                    } else {
                        externalLinkContainer.style.display = 'none';
                        if (medicationInfoText) medicationInfoText.textContent = '';
                    }
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º—ã –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
                if (med.available_forms && med.available_forms.length > 0) {
                    console.log(`üéØ –ù–∞–π–¥–µ–Ω–æ ${med.available_forms.length} –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ä–º:`, med.available_forms);
                    displayAvailableForms(med.available_forms, tradeNameId);
                } else {
                    console.log('‚ùå –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ —Ñ–æ—Ä–º –Ω–µ—Ç
                    const availableFormsContainer = document.getElementById('available-forms-container');
                    if (availableFormsContainer) availableFormsContainer.style.display = 'none';
                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å—Ö–µ–º–∞–º–∏
                    const regimensContainer = document.getElementById('regimens-container');
                    if (regimensContainer) regimensContainer.style.display = 'none';
                }
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ:', error);
        }
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±–æ—Ä–∞
    function toggleFields() {
        const hasMedication = medicationField.value !== '';
        const hasCustomMedication = customMedicationField.value.trim() !== '';
        
        if (hasMedication && hasCustomMedication) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–±–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞, –ª–∏–±–æ –≤–≤–µ–¥–∏—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–µ–ø–∞—Ä–∞—Ç');
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
            customMedicationField.value = '';
            return;
        }
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –ø–æ–ª–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞, –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
        if (hasCustomMedication && hasMedication) {
            medicationField.value = '';
            currentTradeNameId = null;
        }
    }
    
    // –î–ª—è select2 –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
    $(medicationField).on('select2:select', function(e) {
        toggleFields();
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
        currentTradeNameId = e.params.data.trade_name_id || null;
        loadMedicationInfo(e.params.data.id, currentTradeNameId);
    });
    
    $(medicationField).on('select2:clear', function(e) {
        toggleFields();
        currentTradeNameId = null;
        clearAllMedicationData();
    });
    
    // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å change –Ω–∞ —Å–ª—É—á–∞–π
    medicationField.addEventListener('change', function() {
        toggleFields();
        if (this.value) {
            loadMedicationInfo(this.value, currentTradeNameId);
        } else {
            clearAllMedicationData();
        }
    });
    
    customMedicationField.addEventListener('input', function() {
        toggleFields();
        // –ï—Å–ª–∏ –≤–≤–æ–¥–∏—Ç—Å—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–µ–ø–∞—Ä–∞—Ç, –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
        if (this.value.trim() !== '') {
            clearAllMedicationData();
        }
    });
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ –æ–Ω–æ —É–∂–µ –≤—ã–±—Ä–∞–Ω–æ
    if (medicationField.value) {
        loadMedicationInfo(medicationField.value, currentTradeNameId);
    }
    
    // –í—ã–∑—ã–≤–∞–µ–º toggleFields –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    toggleFields();
});

</script>
{% endblock %} 