{% extends "patients/base.html" %}
{% block title %}{{ patient.last_name }} {{ patient.first_name }} | –ú–µ–¥–ö–∞—Ä—Ç{% endblock %}
{% block page_title %}–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ü–∏–µ–Ω—Ç–µ{% endblock %}

{% block content %}
<!-- –ò—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π / –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π -->
{% include "encounters/encounter_list.html" with encounters=encounters %}

<div class="card mt-4">
    <div class="card-body">
        <h4 class="card-title mb-4"><i class="fas fa-user-injured me-2"></i>{{ patient.full_name }}</h4>
        <div class="row">
            <div class="col-md-3">
                <div class="nav flex-column nav-pills me-3" id="patientTab" role="tablist" aria-orientation="vertical">
                    <button class="nav-link active" id="tab-personal" data-bs-toggle="pill" data-bs-target="#personal" type="button" role="tab">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
                    <button class="nav-link" id="tab-passport" data-bs-toggle="pill" data-bs-target="#passport" type="button" role="tab">–ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
                    <button class="nav-link" id="tab-id" data-bs-toggle="pill" data-bs-target="#idinfo" type="button" role="tab">–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</button>
                    <button class="nav-link" id="tab-contacts" data-bs-toggle="pill" data-bs-target="#contacts" type="button" role="tab">–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –∞–¥—Ä–µ—Å–∞</button>
                    <button class="nav-link" id="tab-representative" data-bs-toggle="pill" data-bs-target="#representative" type="button" role="tab">–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å</button>
                </div>
            </div>
            <div class="col-md-9">
                <div class="tab-content" id="patientTabContent">
                    <!-- –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                    <div class="tab-pane fade show active" id="personal" role="tabpanel">
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item"><strong>–§–ò–û:</strong> {{ patient.full_name }}</li>
                            <li class="list-group-item"><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> {{ patient.birth_date|date:"d.m.Y" }}</li>
                            <li class="list-group-item"><strong>–ü–æ–ª:</strong> {{ patient.get_gender_display }}</li>
                        </ul>
                    </div>

                    <!-- –ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                    <div class="tab-pane fade" id="passport" role="tabpanel">
                        {% if document %}
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item"><strong>–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞:</strong> {{ document.document_type }}</li>
                            <li class="list-group-item"><strong>–°–µ—Ä–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞:</strong> {{ document.passport_series }}</li>
                            <li class="list-group-item"><strong>–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞:</strong> {{ document.passport_number }}</li>
                            <li class="list-group-item"><strong>–ö–µ–º –≤—ã–¥–∞–Ω:</strong> {{ document.passport_issued_by }}</li>
                            <li class="list-group-item"><strong>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏:</strong> {{ document.passport_issued_date|date:"d.m.Y" }}</li>
                            <li class="list-group-item"><strong>–ö–æ–¥ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è:</strong> {{ document.passport_department_code }}</li>
                        </ul>
                        {% else %}
                        <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                        {% endif %}
                    </div>

                    <!-- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è -->
                    <div class="tab-pane fade" id="idinfo" role="tabpanel">
                        {% if document %}
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item"><strong>–°–ù–ò–õ–°:</strong> {{ document.snils }}</li>
                            <li class="list-group-item"><strong>–ü–æ–ª–∏—Å –û–ú–°/–î–ú–°:</strong> {{ document.insurance_policy_number }}</li>
                            <li class="list-group-item"><strong>–°—Ç—Ä–∞—Ö–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è:</strong> {{ document.insurance_company }}</li>
                        </ul>
                        {% else %}
                        <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                        {% endif %}
                    </div>

                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –∞–¥—Ä–µ—Å–∞ -->
                    <div class="tab-pane fade" id="contacts" role="tabpanel">
                        {% if contact or address %}
                        <ul class="list-group list-group-flush mb-3">
                            {% if contact %}
                            <li class="list-group-item"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ contact.phone }}</li>
                            <li class="list-group-item"><strong>Email:</strong> {{ contact.email }}</li>
                            {% endif %}
                            {% if address %}
                            <li class="list-group-item"><strong>–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> {{ address.registration_address }}</li>
                            <li class="list-group-item"><strong>–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è:</strong> {{ address.residential_address }}</li>
                            {% endif %}
                        </ul>
                        {% else %}
                        <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                        {% endif %}
                    </div>

                    <!-- –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å -->
                    <div class="tab-pane fade" id="representative" role="tabpanel">
                        {% if contact %}
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item"><strong>–§–ò–û –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è:</strong> {{ contact.legal_representative_full_name }}</li>
                            <li class="list-group-item"><strong>–°—Ç–µ–ø–µ–Ω—å —Ä–æ–¥—Å—Ç–≤–∞:</strong> {{ contact.legal_representative_relation }}</li>
                            <li class="list-group-item"><strong>–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è:</strong> {{ contact.legal_representative_contacts }}</li>
                        </ul>
                        {% else %}
                        <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ —Å –¥–µ—Ç—å–º–∏ –∏ —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏ -->
        {% if patient.patient_type != 'newborn' %}
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="fas fa-child me-2"></i>–î–µ—Ç–∏</h5>
                {% if patient.children.all %}
                <ul class="list-group list-group-flush">
                    {% for child in patient.children.all %}
                    <li class="list-group-item">
                        <a href="{% url 'patients:patient_detail' child.pk %}">{{ child.full_name }}</a> ({{ child.birth_date|date:"d.m.Y" }})
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ—Ç—è—Ö.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if patient.parents.exists %}
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="fas fa-user-friends me-2"></i>–†–æ–¥–∏—Ç–µ–ª–∏</h5>
                <ul class="list-group list-group-flush">
                    {% for parent in patient.parents.all %}
                    <li class="list-group-item">
                        <a href="{% url 'patients:patient_detail' parent.pk %}">{{ parent.full_name }}</a>
                        ({{ parent.birth_date|date:"d.m.Y" }})
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

        <div class="d-flex gap-2 mt-4">
            <a href="{% url 'patients:patient_update' patient.pk %}" class="btn btn-outline-primary">
                <i class="fas fa-edit me-1"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>
            {% if patient.patient_type != 'newborn' %}
            <div class="btn-group">
                <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-plus-circle me-1"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Ç–æ–º–∫–∞
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'patients:newborn_create' parent_id=patient.pk %}">üë∂ –ù–æ–≤–æ—Ä–æ–∂–¥–µ–Ω–Ω–æ–≥–æ</a></li>
                    <li><a class="dropdown-item" href="{% url 'patients:child_create' parent_id=patient.pk %}">üßí –†–µ–±—ë–Ω–∫–∞</a></li>
                    <li><a class="dropdown-item" href="{% url 'patients:teen_create' parent_id=patient.pk %}">üë¶ –ü–æ–¥—Ä–æ—Å—Ç–∫–∞</a></li>
                </ul>
            </div>
            {% endif %}
            <a href="{% url 'patients:patient_delete' patient.pk %}" class="btn btn-outline-danger">
                <i class="fas fa-trash-alt me-1"></i> –£–¥–∞–ª–∏—Ç—å
            </a>
            <a href="{% url 'patients:patient_list' %}" class="btn btn-outline-secondary ms-auto">
                <i class="fas fa-arrow-left me-1"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
            </a>
        </div>
    </div>
</div>
{% endblock %}
