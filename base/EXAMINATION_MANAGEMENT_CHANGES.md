# Изменения в системе управления обследованиями

## Обзор изменений

Внесены изменения для улучшения функциональности системы управления лабораторными и инструментальными исследованиями:

1. **Убрана возможность удаления записей** со стороны лаборанта
2. **Добавлена возможность браковки анализов** с указанием причины
3. **Улучшена система статусов** назначений
4. **Добавлены автоматические сигналы** для удаления связанных назначений

## Детали изменений

### 1. Модели (treatment_assignments/models.py)

#### Новые поля:
- `rejection_reason` - причина брака назначения
- Новый статус `'rejected'` (Забраковано) в `STATUS_CHOICES`

#### Новые методы в BaseAssignment:
- `reject(reason, rejected_by)` - перевод назначения в статус "Забраковано"
- `can_be_rejected()` - проверка возможности браковки
- `can_be_deleted()` - проверка возможности удаления
- `can_be_edited()` - проверка возможности редактирования

### 2. Представления

#### Лабораторные исследования (lab_tests/views.py):
- Убрано `LabTestResultDeleteView`
- Добавлено `LabTestAssignmentRejectView` для браковки
- Обновлено `LabTestAssignmentListView` с фильтрацией по статусу

#### Инструментальные исследования (instrumental_procedures/views.py):
- Убрано `InstrumentalProcedureResultDeleteView`
- Добавлено `InstrumentalProcedureAssignmentRejectView` для браковки
- Обновлено `InstrumentalProcedureAssignmentListView` с фильтрацией по статусу

### 3. URL-маршруты

#### Лабораторные исследования:
- Убран: `results/<int:pk>/delete/`
- Добавлен: `assignments/<int:pk>/reject/`

#### Инструментальные исследования:
- Убран: `results/<int:pk>/delete/`
- Добавлен: `assignments/<int:pk>/reject/`

### 4. Шаблоны

#### Новые шаблоны:
- `lab_tests/templates/lab_tests/assignment_reject.html` - форма браковки лабораторных исследований
- `instrumental_procedures/templates/instrumental_procedures/assignment_reject.html` - форма браковки инструментальных исследований

#### Обновленные шаблоны:
- `assignment_list.html` - убраны кнопки удаления, добавлены кнопки браковки
- Добавлены фильтры по новому статусу "Забраковано"
- Улучшено отображение статусов и действий

### 5. Сигналы (examination_management/models.py)

Добавлены автоматические сигналы Django:
- `delete_lab_test_assignment` - автоматическое удаление назначения при удалении записи из плана
- `delete_instrumental_procedure_assignment` - автоматическое удаление назначения при удалении записи из плана
- `delete_plan_assignments` - удаление всех связанных назначений при удалении плана

## Логика работы

### Браковка назначения:
1. Лаборант нажимает кнопку "Забраковать"
2. Открывается форма с полем для указания причины брака
3. При подтверждении назначение переводится в статус "Забраковано"
4. Устанавливается дата завершения и причина брака

### Автоматическое удаление назначений:
1. При удалении записи из плана обследования автоматически удаляется связанное назначение
2. Это обеспечивает синхронизацию между планом и списком назначений для лаборанта

### Фильтрация:
- Добавлен фильтр по статусу "Забраковано"
- Улучшена навигация между различными статусами назначений

## Преимущества изменений

1. **Целостность данных** - убрана возможность случайного удаления важных записей
2. **Отслеживание брака** - теперь можно анализировать причины брака анализов
3. **Автоматизация** - назначения автоматически удаляются при изменении плана
4. **Улучшенный UX** - более понятные действия и статусы для лаборантов

## Миграции

Создана и применена миграция `0003_generaltreatmentassignment_rejection_reason_and_more.py`:
- Добавлено поле `rejection_reason` для всех типов назначений
- Обновлены ограничения для поля `status`

## Тестирование

Для проверки работы сигналов создан тестовый скрипт `test_examination_signals.py`, который:
- Создает тестовые данные
- Проверяет автоматическое создание назначений
- Тестирует автоматическое удаление назначений при удалении записей
- Проверяет работу всех сигналов 