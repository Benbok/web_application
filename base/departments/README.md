# Модуль Departments - Документация функционала

## Обзор модуля

Модуль `departments` отвечает за управление отделениями больницы и статусами пациентов в отделениях. Включает функционал для приема, выписки и перевода пациентов между отделениями, а также ведение истории лечения.

## Модели (Models)

### Department
**Назначение**: Модель отделения больницы
**Основные поля**:
- `name` - Наименование отделения
- `slug` - Код отделения (уникальный идентификатор)
- `description` - Описание отделения

**Методы**:
- `__str__()` - Строковое представление отделения
- Автоматическая генерация slug при сохранении

**Функционал**:
- Уникальные идентификаторы отделений
- Автоматическое создание slug из названия
- Интеграция с системой документов и назначений

### PatientDepartmentStatus
**Назначение**: Модель для отслеживания статуса пациента в отделении
**Основные поля**:
- `patient` - Связь с пациентом
- `department` - Связь с отделением
- `status` - Статус в отделении (pending, accepted, discharged, transferred_out, transfer_cancelled)
- `admission_date` - Дата поступления (автоматически)
- `accepted_by` - Сотрудник, принявший пациента
- `acceptance_date` - Дата принятия
- `discharge_date` - Дата выписки
- `notes` - Заметки
- `source_encounter` - Случай обращения-источник перевода

**Статусы**:
- `pending` - Ожидает принятия
- `accepted` - Принят в отделение
- `discharged` - Выписан из отделения
- `transferred_out` - Переведен в другое отделение
- `transfer_cancelled` - Перевод отменен

**Методы**:
- `accept_patient(user)` - Принятие пациента в отделение
- `discharge_patient()` - Выписка пациента из отделения
- `cancel_transfer()` - Отмена перевода
- `archive()` - Архивирование с синхронизацией
- `unarchive()` - Восстановление из архива

**Функционал**:
- Управление жизненным циклом пациента в отделении
- Интеграция с системой обращений (encounters)
- Поддержка документов и назначений через GenericRelation
- Система архивирования

## Представления (Views)

### DepartmentListView
**Назначение**: Отображение списка отделений
**Функционал**:
- Исключает отделение "admission" из списка
- Предоставляет контекст для шаблона

### DepartmentDetailView
**Назначение**: Детальный просмотр отделения с пациентами
**Функционал**:
- Отображает пациентов по статусам (ожидающие, принятые)
- Оптимизированные запросы с select_related
- Сортировка по датам

### PatientDepartmentAcceptView
**Назначение**: Принятие пациента в отделение
**Метод**: POST
**Функционал**:
- Валидация соответствия отделения
- Вызов метода accept_patient()
- Уведомления пользователя о результате

### PatientDepartmentHistoryView
**Назначение**: Просмотр истории пациента в отделении
**Функционал**:
- Фильтрация документов и назначений
- Пагинация для всех типов данных
- Поиск по датам, авторам, типам документов
- Интеграция с системой назначений (лекарства, процедуры, анализы)

**Поддерживаемые типы данных**:
- Клинические документы
- Назначения лекарств
- Общие назначения лечения
- Назначения лабораторных анализов
- Назначения инструментальных процедур

### PatientAcceptanceView
**Назначение**: Форма принятия пациента с указанием даты
**Функционал**:
- Кастомная форма с полем даты принятия
- Автоматическое заполнение статуса и сотрудника
- Перенаправление с поддержкой параметра next

### PatientDepartmentDischargeView
**Назначение**: Выписка пациента из отделения
**Метод**: POST
**Функционал**:
- Валидация соответствия отделения
- Вызов метода discharge_patient()
- Уведомления пользователя о результате

## Формы (Forms)

### DepartmentForm
**Назначение**: Форма создания/редактирования отделения
**Функционал**:
- Автоматическая генерация slug из названия
- Валидация уникальности slug

### PatientAcceptanceForm
**Назначение**: Форма принятия пациента с указанием даты
**Поля**: acceptance_date
**Виджеты**: DateTimeInput с типом datetime-local
**Функционал**: Позволяет указать точную дату и время принятия

### DocumentAndAssignmentFilterForm
**Назначение**: Форма фильтрации документов и назначений
**Поля**:
- `start_date` - Начальная дата
- `end_date` - Конечная дата
- `author` - Автор/назначивший врач
- `document_type` - Тип документа
- `search_query` - Поисковый запрос

**Функционал**:
- Динамическая фильтрация по отделению
- Поиск по содержимому документов и назначений
- Поддержка всех типов назначений

## Админ-панель (Admin)

### DepartmentAdmin
**Назначение**: Администрирование отделений
**Функционал**:
- Ограничение прав только для суперпользователей
- Поиск по названию и slug
- Группировка полей в fieldsets

### PatientDepartmentStatusAdmin
**Назначение**: Администрирование статусов пациентов в отделениях
**Функционал**:
- Отображение статуса архивирования
- Действия массового архивирования/восстановления
- Фильтрация по статусу, архиву, дате поступления
- Поиск по данным пациента и отделения

## Шаблонные теги (Template Tags)

### custom_filters.py
**Назначение**: Кастомные фильтры для шаблонов

#### `last_category`
**Функционал**: Извлечение последней категории из иерархического пути
**Логика**:
- Разделение по "->" и взятие последнего элемента
- Альтернативно: разделение по "] " и взятие второго элемента
**Пример**: "A -> B -> C" → "C"

## Интеграции

### С системой Encounters
- Связь через `source_encounter`
- Синхронизация при архивировании/восстановлении
- Отмена переводов при изменении статуса

### С системой Documents
- GenericRelation для клинических документов
- Фильтрация по типам документов отделения
- Привязка документов к статусам пациентов

### С системой Treatment Assignments
- Интеграция с назначениями лекарств
- Интеграция с общими назначениями лечения
- Интеграция с лабораторными анализами
- Интеграция с инструментальными процедурами

### С системой Patients
- Связь пациентов с отделениями
- Отслеживание истории пребывания

## Архитектурные особенности

1. **Soft Delete**: Использование ArchivableModel для мягкого удаления
2. **Generic Relations**: Гибкая связь с документами и назначениями
3. **State Management**: Управление статусами пациентов
4. **Audit Trail**: Отслеживание изменений с временными метками
5. **Permission Control**: Ограничение доступа к админ-функциям

## Бизнес-логика

### Жизненный цикл пациента в отделении:
1. **Поступление** - создание записи со статусом 'pending'
2. **Принятие** - изменение статуса на 'accepted' с указанием сотрудника
3. **Лечение** - ведение документов и назначений
4. **Выписка** - изменение статуса на 'discharged' с датой выписки
5. **Перевод** - создание новой записи в другом отделении

### Валидации:
- Проверка соответствия отделения при операциях
- Валидация статусов для выполнения операций
- Контроль дат (дата выписки не может быть раньше даты принятия)

### Интеграции с другими модулями:
- **Appointments** → переводы через encounters
- **Documents** → клиническая документация
- **Treatment Assignments** → назначения лечения
- **Patients** → управление пациентами 