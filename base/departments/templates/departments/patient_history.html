{% extends 'patients/base.html' %}
{% block title %}
    {{ title }}
{% endblock %}
{% block page_title %}
    {{ title }}
{% endblock %}
{% block content %}
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0">{{ title }}</h3>
            <div>
                <a href="{% url 'treatment_assignments:daily_plan' model_name='patientdepartmentstatus' object_id=patient_status.pk %}?next={{ request.get_full_path|urlencode }}"
                   class="btn btn-info me-2"><i class="fas fa-calendar-alt me-1"></i> Лист назначений</a>
                <a href="{% url 'departments:department_detail' patient_status.department.pk %}"
                   class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-1"></i> К отделению</a>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Основные сведения о размещении</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <strong>Пациент:</strong>
                        <a href="{% url 'patients:patient_detail' patient_status.patient.pk %}">{{ patient_status.patient.full_name }}</a>
                    </li>
                    <li class="list-group-item">
                        <strong>Отделение:</strong> {{ patient_status.department.name }}
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Дата поступления:</strong>
                            {% if patient_status.acceptance_date %}
                                {{ patient_status.acceptance_date|date:'d.m.Y H:i' }}
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </div>
                        <a href="{% url 'departments:patient_accept_form' pk=patient_status.pk %}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-secondary" title="Редактировать дату принятия">
                            <i class="fas fa-calendar-alt"></i>
                        </a>
                    </li>
                    <li class="list-group-item">
                        <strong>Дата выписки:</strong>
                        {% if patient_status.discharge_date %}
                            {{ patient_status.discharge_date|date:'d.m.Y H:i' }}
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    </li>
                    <li class="list-group-item">
                        <strong>Статус:</strong> {{ patient_status.get_status_display }}
                    </li>
                </ul>
            </div>
        </div>

        {% if active_assignments or inactive_assignments %}
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card mb-4 border-success shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Активные назначения</h5>
                    </div>
                    <div class="card-body">
                        {% if active_assignments %}
                        <div class="accordion accordion-flush" id="activeAssignmentsAccordion">
                            {% for assignment in active_assignments %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="activeAssignmentHeading{{ assignment.assignment_type }}{{ assignment.pk }}">
                                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#activeAssignmentCollapse{{ assignment.assignment_type }}{{ assignment.pk }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="activeAssignmentCollapse{{ assignment.assignment_type }}{{ assignment.pk }}">
                                        {# ИЗМЕНЕНИЕ: Используем treatment_name из модели #}
                                        <strong>{{ assignment.treatment_name }}</strong>
                                        <span class="ms-auto text-muted small">
                                            {{ assignment.start_date|date:'d.m.Y' }}
                                        </span>
                                    </button>
                                </h2>
                                <div id="activeAssignmentCollapse{{ assignment.assignment_type }}{{ assignment.pk }}" class="accordion-collapse collapse" aria-labelledby="activeAssignmentHeading{{ assignment.assignment_type }}{{ assignment.pk }}" data-bs-parent="#activeAssignmentsAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-group list-group-flush">
                                            {# ИЗМЕНЕНИЕ: Динамический вывод деталей в зависимости от типа #}
                                            {% if assignment.assignment_type == 'medication' %}
                                                <li class="list-group-item"><strong>Дозировка:</strong> {{ assignment.dosage|default:"-" }}</li>
                                                <li class="list-group-item"><strong>Частота:</strong> {{ assignment.frequency|default:"-" }}</li>
                                                <li class="list-group-item"><strong>Путь введения:</strong> {{ assignment.route|default:"-" }}</li>
                                            {% endif %}
                                            <li class="list-group-item"><strong>Назначивший врач:</strong>
                                                {% if assignment.assigning_doctor.doctor_profile.full_name %}
                                                    {{ assignment.assigning_doctor.doctor_profile.full_name }}
                                                {% else %}
                                                    {{ assignment.assigning_doctor.get_full_name|default:assignment.assigning_doctor.username }}
                                                {% endif %}
                                            </li>
                                            {% if assignment.notes %}
                                            <li class="list-group-item"><strong>Примечания:</strong> {{ assignment.notes|linebreaksbr }}</li>
                                            {% endif %}
                                        </ul>
                                        <div class="mt-3 d-flex justify-content-end gap-2">
                                            {# ИЗМЕНЕНИЕ: Используем правильные методы для URL #}
                                            <a href="{{ assignment.get_update_url }}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit me-1"></i> Редактировать</a>
                                            <a href="{{ assignment.get_absolute_url }}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-info"><i class="fas fa-info-circle me-1"></i> Детали</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">Нет активных назначений.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4 border-secondary shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Завершенные / Приостановленные / Отмененные</h5>
                    </div>
                    <div class="card-body">
                        {% if inactive_assignments %}
                        <div class="accordion accordion-flush" id="inactiveAssignmentsAccordion">
                            {% for assignment in inactive_assignments %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="inactiveAssignmentHeading{{ assignment.assignment_type }}{{ assignment.pk }}">
                                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#inactiveAssignmentCollapse{{ assignment.assignment_type }}{{ assignment.pk }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="inactiveAssignmentCollapse{{ assignment.assignment_type }}{{ assignment.pk }}">
                                        {# ИЗМЕНЕНИЕ: Используем treatment_name из модели #}
                                        <strong>{{ assignment.treatment_name }}</strong>
                                        <span class="ms-auto text-muted small">
                                            {{ assignment.start_date|date:'d.m.Y H:i' }} -
                                            {% if assignment.end_date %}
                                                {{ assignment.end_date|date:'d.m.Y H:i' }}
                                            {% else %}
                                                ({{ assignment.get_status_display }})
                                            {% endif %}
                                        </span>
                                    </button>
                                </h2>
                                <div id="inactiveAssignmentCollapse{{ assignment.assignment_type }}{{ assignment.pk }}" class="accordion-collapse collapse" aria-labelledby="inactiveAssignmentHeading{{ assignment.assignment_type }}{{ assignment.pk }}" data-bs-parent="#inactiveAssignmentsAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-group list-group-flush">
                                            {# ИЗМЕНЕНИЕ: Динамический вывод деталей в зависимости от типа #}
                                            {% if assignment.assignment_type == 'medication' %}
                                                <li class="list-group-item"><strong>Дозировка:</strong> {{ assignment.dosage|default:"-" }}</li>
                                                <li class="list-group-item"><strong>Частота:</strong> {{ assignment.frequency|default:"-" }}</li>
                                                <li class="list-group-item"><strong>Путь введения:</strong> {{ assignment.route|default:"-" }}</li>
                                            {% endif %}
                                            <li class="list-group-item"><strong>Назначивший врач:</strong>
                                                {% if assignment.assigning_doctor.doctor_profile.full_name %}
                                                    {{ assignment.assigning_doctor.doctor_profile.full_name }}
                                                {% else %}
                                                    {{ assignment.assigning_doctor.get_full_name|default:assignment.assigning_doctor.username }}
                                                {% endif %}
                                            </li>
                                            {% if assignment.notes %}
                                            <li class="list-group-item"><strong>Примечания:</strong> {{ assignment.notes|linebreaksbr }}</li>
                                            {% endif %}
                                        </ul>
                                        <div class="mt-3 d-flex justify-content-end gap-2">
                                            {# ИЗМЕНЕНИЕ: Используем правильные методы для URL #}
                                            <a href="{{ assignment.get_update_url }}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit me-1"></i> Редактировать</a>
                                            <a href="{{ assignment.get_absolute_url }}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-info"><i class="fas fa-info-circle me-1"></i> Детали</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">Нет неактивных назначений.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Фильтр документов</h5>
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-3">{{ filter_form.start_date.label_tag }}
                        {{ filter_form.start_date }}</div>
                    <div class="col-md-3">{{ filter_form.end_date.label_tag }}
                        {{ filter_form.end_date }}</div>
                    <div class="col-md-3">{{ filter_form.author.label_tag }}
                        {{ filter_form.author }}</div>
                    <div class="col-md-3">{{ filter_form.search_query.label_tag }}
                        {{ filter_form.search_query }}</div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">Применить фильтр</button>
                        <a href="{% url 'departments:patient_history' patient_status.pk %}" class="btn btn-secondary">Сбросить</a>
                    </div>
                </form>
            </div>
        </div>

        <ul class="nav nav-tabs flex-row mt-4" id="documentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="daily-notes-tab" data-bs-toggle="tab" data-bs-target="#daily-notes"
                        type="button" role="tab" aria-controls="daily-notes" aria-selected="true">Дневниковые записи
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments"
                        type="button" role="tab" aria-controls="assignments" aria-selected="false">Назначения
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="other-tab" data-bs-toggle="tab" data-bs-target="#other" type="button"
                        role="tab" aria-controls="other" aria-selected="false">Другое (будущие вкладки)
                </button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="documentTabsContent">
            <div class="tab-pane fade show active" id="daily-notes" role="tabpanel" aria-labelledby="daily-notes-tab">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Дневниковые записи</h5>
                            <a href="{% url 'documents:document_type_selection' model_name='patientdepartmentstatus' object_id=patient_status.pk %}?next={{ request.get_full_path|urlencode }}"
                               class="btn btn-primary btn-sm">
                                <i class="fas fa-plus me-1"></i> Добавить запись
                            </a>
                        </div>
                        {% if daily_notes_page_obj %}
                            <div class="accordion" id="dailyNotesAccordion">
                                {% for doc in daily_notes_page_obj %}
                                    {% include 'departments/partials/note_accordion_item.html' with object=doc %}
                                {% endfor %}
                            </div>

                            <nav aria-label="Навигация по дневникам" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    {% if daily_notes_page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?daily_notes_page=
                                                       {{ daily_notes_page_obj.previous_page_number }}{% for key, value in request.GET.items %}
                                                      {% if key != 'daily_notes_page' %}
                                                        &{{ key }}={{ value }}
                                                      {% endif %}
                                                    {% endfor %}">
                                                Предыдущая
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">Предыдущая</span>
                                        </li>
                                    {% endif %}

                                    {% for i in daily_notes_page_obj.paginator.page_range %}
                                        {% if daily_notes_page_obj.number == i %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ i }}</span>
                                            </li>
                                        {% else %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                   href="?daily_notes_page=
                                                           {{ i }}{% for key, value in request.GET.items %}
                                                        {% if key != 'daily_notes_page' %}
                                                          &{{ key }}={{ value }}
                                                        {% endif %}
                                                      {% endfor %}">
                                                    {{ i }}
                                                </a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}

                                    {% if daily_notes_page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?daily_notes_page=
                                                       {{ daily_notes_page_obj.next_page_number }}{% for key, value in request.GET.items %}
                                                      {% if key != 'daily_notes_page' %}
                                                        &{{ key }}={{ value }}
                                                      {% endif %}
                                                    {% endfor %}">
                                                Следующая
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">Следующая</span>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% else %}
                            <p class="text-muted">Нет дневниковых записей для отображения по заданным фильтрам.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="assignments" role="tabpanel" aria-labelledby="assignments-tab">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Медицинские назначения</h5>

                        <ul class="nav nav-tabs mb-3 flex-row" id="assignmentSubTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="medication-assignments-tab" data-bs-toggle="tab" data-bs-target="#medication-assignments" type="button" role="tab" aria-controls="medication-assignments" aria-selected="true">Препараты</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="general-assignments-tab" data-bs-toggle="tab" data-bs-target="#general-assignments" type="button" role="tab" aria-controls="general-assignments" aria-selected="false">Общие</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="lab-assignments-tab" data-bs-toggle="tab" data-bs-target="#lab-assignments" type="button" role="tab" aria-controls="lab-assignments" aria-selected="false">Лаб. исследования</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="instrumental-assignments-tab" data-bs-toggle="tab" data-bs-target="#instrumental-assignments" type="button" role="tab" aria-controls="instrumental-assignments" aria-selected="false">Инстр. исследования</button>
                            </li>
                        </ul>

                        <div class="tab-content" id="assignmentSubTabsContent">
                            {# Препараты #}
                            <div class="tab-pane fade show active" id="medication-assignments" role="tabpanel" aria-labelledby="medication-assignments-tab">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="card-title mb-0">Назначения препаратов</h6>
                                    <a href="{% url 'treatment_assignments:medication_assignment_create' model_name='patientdepartmentstatus' object_id=patient_status.pk %}?next={{ request.get_full_path|urlencode }}"
                                       class="btn btn-primary btn-sm"><i class="fas fa-plus me-1"></i> Добавить препарат</a>
                                </div>
                                {% if medication_assignments_page_obj %}
                                    <div class="accordion" id="medicationAssignmentsAccordion">
                                        {% for assignment in medication_assignments_page_obj %}
                                            {% include 'departments/partials/assignment_accordion_item.html' with object=assignment accordion_id='medicationAssignmentsAccordion' %}
                                        {% endfor %}
                                    </div>
                                    <nav aria-label="Навигация по препаратам" class="mt-3">
                                        <ul class="pagination justify-content-center">
                                            {% if medication_assignments_page_obj.has_previous %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?medication_assignments_page={{ medication_assignments_page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'medication_assignments_page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Предыдущая</a>
                                                </li>
                                            {% else %}
                                                <li class="page-item disabled"><span class="page-link">Предыдущая</span></li>
                                            {% endif %}
                                            {% for i in medication_assignments_page_obj.paginator.page_range %}
                                                {% if medication_assignments_page_obj.number == i %}
                                                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                                                {% else %}
                                                    <li class="page-item"><a class="page-link" href="?medication_assignments_page={{ i }}{% for key, value in request.GET.items %}{% if key != 'medication_assignments_page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a></li>
                                                {% endif %}
                                            {% endfor %}
                                            {% if medication_assignments_page_obj.has_next %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?medication_assignments_page={{ medication_assignments_page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'medication_assignments_page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Следующая</a>
                                                </li>
                                            {% else %}
                                                <li class="page-item disabled"><span class="page-link">Следующая</span></li>
                                            {% endif %}
                                        </ul>
                                    </nav>
                                {% else %}
                                    <p class="text-muted">Нет назначений препаратов для отображения по заданным фильтрам.</p>
                                {% endif %}
                            </div>

                            {# Общие назначения #}
                            <div class="tab-pane fade" id="general-assignments" role="tabpanel" aria-labelledby="general-assignments-tab">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="card-title mb-0">Общие назначения</h6>
                                    <a href="{% url 'treatment_assignments:general_assignment_create' model_name='patientdepartmentstatus' object_id=patient_status.pk %}?next={{ request.get_full_path|urlencode }}"
                                       class="btn btn-primary btn-sm"><i class="fas fa-plus me-1"></i> Добавить общее</a>
                                </div>
                                {% if general_treatment_assignments_page_obj %}
                                    <div class="accordion" id="generalAssignmentsAccordion">
                                        {% for assignment in general_treatment_assignments_page_obj %}
                                            {% include 'departments/partials/assignment_accordion_item.html' with object=assignment accordion_id='generalAssignmentsAccordion' %}
                                        {% endfor %}
                                    </div>
                                    <nav aria-label="Навигация по общим назначениям" class="mt-3">
                                        <ul class="pagination justify-content-center">
                                            {% if general_treatment_assignments_page_obj.has_previous %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?general_treatment_assignments_page={{ general_treatment_assignments_page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'general_treatment_assignments_page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Предыдущая</a>
                                                </li>
                                            {% else %}
                                                <li class="page-item disabled"><span class="page-link">Предыдущая</span></li>
                                            {% endif %}
                                            {% for i in general_treatment_assignments_page_obj.paginator.page_range %}
                                                {% if general_treatment_assignments_page_obj.number == i %}
                                                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                                                {% else %}
                                                    <li class="page-item"><a class="page-link" href="?general_treatment_assignments_page={{ i }}{% for key, value in request.GET.items %}{% if key != 'general_treatment_assignments_page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a></li>
                                                {% endif %}
                                            {% endfor %}
                                            {% if general_treatment_assignments_page_obj.has_next %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?general_treatment_assignments_page={{ general_treatment_assignments_page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'general_treatment_assignments_page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Следующая</a>
                                                </li>
                                            {% else %}
                                                <li class="page-item disabled"><span class="page-link">Следующая</span></li>
                                            {% endif %}
                                        </ul>
                                    </nav>
                                {% else %}
                                    <p class="text-muted">Нет общих назначений для отображения по заданным фильтрам.</p>
                                {% endif %}
                            </div>

                            {# Лабораторные исследования #}
                            <div class="tab-pane fade" id="lab-assignments" role="tabpanel" aria-labelledby="lab-assignments-tab">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="card-title mb-0">Назначения лабораторных исследований</h6>
                                    <a href="{% url 'treatment_assignments:lab_assignment_create' model_name='patientdepartmentstatus' object_id=patient_status.pk %}?next={{ request.get_full_path|urlencode }}"
                                       class="btn btn-primary btn-sm"><i class="fas fa-plus me-1"></i> Добавить лаб.</a>
                                </div>
                                {% if lab_test_assignments_page_obj %}
                                    <div class="accordion" id="labAssignmentsAccordion">
                                        {% for assignment in lab_test_assignments_page_obj %}
                                            {% include 'departments/partials/assignment_accordion_item.html' with object=assignment accordion_id='labAssignmentsAccordion' %}
                                        {% endfor %}
                                    </div>
                                    <nav aria-label="Навигация по лабораторным исследованиям" class="mt-3">
                                        <ul class="pagination justify-content-center">
                                            {% if lab_test_assignments_page_obj.has_previous %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?lab_test_assignments_page={{ lab_test_assignments_page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'lab_test_assignments_page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Предыдущая</a>
                                                </li>
                                            {% else %}
                                                <li class="page-item disabled"><span class="page-link">Предыдущая</span></li>
                                            {% endif %}
                                            {% for i in lab_test_assignments_page_obj.paginator.page_range %}
                                                {% if lab_test_assignments_page_obj.number == i %}
                                                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                                                {% else %}
                                                    <li class="page-item"><a class="page-link" href="?lab_test_assignments_page={{ i }}{% for key, value in request.GET.items %}{% if key != 'lab_test_assignments_page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a></li>
                                                {% endif %}
                                            {% endfor %}
                                            {% if lab_test_assignments_page_obj.has_next %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?lab_test_assignments_page={{ lab_test_assignments_page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'lab_test_assignments_page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Следующая</a>
                                                </li>
                                            {% else %}
                                                <li class="page-item disabled"><span class="page-link">Следующая</span></li>
                                            {% endif %}
                                        </ul>
                                    </nav>
                                {% else %}
                                    <p class="text-muted">Нет назначений лабораторных исследований для отображения по заданным фильтрам.</p>
                                {% endif %}
                            </div>

                            {# Инструментальные исследования #}
                            <div class="tab-pane fade" id="instrumental-assignments" role="tabpanel" aria-labelledby="instrumental-assignments-tab">
                               <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="card-title mb-0">Назначения инструментальных исследований</h6>
                                    <a href="{% url 'treatment_assignments:instrumental_assignment_create' model_name='patientdepartmentstatus' object_id=patient_status.pk %}?next={{ request.get_full_path|urlencode }}"
                                       class="btn btn-primary btn-sm"><i class="fas fa-plus me-1"></i> Добавить инстр.</a>
                                </div>
                                {% if instrumental_procedure_assignments_page_obj %}
                                    <div class="accordion" id="instrumentalAssignmentsAccordion">
                                        {% for assignment in instrumental_procedure_assignments_page_obj %}
                                            {% include 'departments/partials/assignment_accordion_item.html' with object=assignment accordion_id='instrumentalAssignmentsAccordion' %}
                                        {% endfor %}
                                    </div>
                                    <nav aria-label="Навигация по инструментальным исследованиям" class="mt-3">
                                        <ul class="pagination justify-content-center">
                                            {% if instrumental_procedure_assignments_page_obj.has_previous %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?instrumental_procedure_assignments_page={{ instrumental_procedure_assignments_page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'instrumental_procedure_assignments_page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Предыдущая</a>
                                                </li>
                                            {% else %}
                                                <li class="page-item disabled"><span class="page-link">Предыдущая</span></li>
                                            {% endif %}
                                            {% for i in instrumental_procedure_assignments_page_obj.paginator.page_range %}
                                                {% if instrumental_procedure_assignments_page_obj.number == i %}
                                                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                                                {% else %}
                                                    <li class="page-item"><a class="page-link" href="?instrumental_procedure_assignments_page={{ i }}{% for key, value in request.GET.items %}{% if key != 'instrumental_procedure_assignments_page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a></li>
                                                {% endif %}
                                            {% endfor %}
                                            {% if instrumental_procedure_assignments_page_obj.has_next %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?instrumental_procedure_assignments_page={{ instrumental_procedure_assignments_page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'instrumental_procedure_assignments_page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Следующая</a>
                                                </li>
                                            {% else %}
                                                <li class="page-item disabled"><span class="page-link">Следующая</span></li>
                                            {% endif %}
                                        </ul>
                                    </nav>
                                {% else %}
                                    <p class="text-muted">Нет назначений инструментальных исследований для отображения по заданным фильтрам.</p>
                                {% endif %}
                            </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="other" role="tabpanel" aria-labelledby="other-tab">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Другие данные</h5>
                        <p class="text-muted">Здесь будут располагаться другие типы записей или информации.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
