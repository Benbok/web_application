{% extends 'patients/base.html' %}
{% block title %}
    {{ title }}
{% endblock %}
{% block page_title %}
    {{ title }}
{% endblock %}
{% block content %}
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0">{{ title }}</h3>
            <div>
                <a href="{% url 'treatment_assignments:daily_plan' model_name='patientdepartmentstatus' object_id=patient_status.pk %}?next={{ request.get_full_path|urlencode }}"
                   class="btn btn-info me-2"><i class="fas fa-calendar-alt me-1"></i> Лист назначений</a>
                <a href="{% url 'departments:department_detail' patient_status.department.pk %}"
                   class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-1"></i> К отделению</a>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Основные сведения о размещении</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <strong>Пациент:</strong>
                        <a href="{% url 'patients:patient_detail' patient_status.patient.pk %}">{{ patient_status.patient.full_name }}</a>
                    </li>
                    <li class="list-group-item">
                        <strong>Отделение:</strong> {{ patient_status.department.name }}
                    </li>
                    <li class="list-group-item">
                        <strong>Дата поступления:</strong> {{ patient_status.admission_date|date:'d.m.Y H:i' }}
                    </li>
                    <li class="list-group-item">
                        <strong>Дата выписки:</strong>
                        {% if patient_status.discharge_date %}
                            {{ patient_status.discharge_date|date:'d.m.Y H:i' }}
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    </li>
                    <li class="list-group-item">
                        <strong>Статус:</strong> {{ patient_status.get_status_display }}
                    </li>
                </ul>
            </div>
        </div>

        {% if active_assignments or inactive_assignments %}
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card mb-4 border-success shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Активные назначения</h5>
                    </div>
                    <div class="card-body">
                        {% if active_assignments %}
                        <div class="accordion accordion-flush" id="activeAssignmentsAccordion">
                            {% for assignment in active_assignments %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="activeAssignmentHeading{{ assignment.assignment_type }}{{ assignment.pk }}">
                                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#activeAssignmentCollapse{{ assignment.assignment_type }}{{ assignment.pk }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="activeAssignmentCollapse{{ assignment.assignment_type }}{{ assignment.pk }}">
                                        {# ИЗМЕНЕНИЕ: Используем treatment_name из модели #}
                                        <strong>{{ assignment.treatment_name }}</strong>
                                        <span class="ms-auto text-muted small">
                                            {{ assignment.start_date|date:'d.m.Y' }}
                                        </span>
                                    </button>
                                </h2>
                                <div id="activeAssignmentCollapse{{ assignment.assignment_type }}{{ assignment.pk }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="activeAssignmentHeading{{ assignment.assignment_type }}{{ assignment.pk }}" data-bs-parent="#activeAssignmentsAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-group list-group-flush">
                                            {# ИЗМЕНЕНИЕ: Динамический вывод деталей в зависимости от типа #}
                                            {% if assignment.assignment_type == 'medication' %}
                                                <li class="list-group-item"><strong>Дозировка:</strong> {{ assignment.dosage|default:"-" }}</li>
                                                <li class="list-group-item"><strong>Частота:</strong> {{ assignment.frequency|default:"-" }}</li>
                                                <li class="list-group-item"><strong>Путь введения:</strong> {{ assignment.route|default:"-" }}</li>
                                            {% endif %}
                                            <li class="list-group-item"><strong>Назначивший врач:</strong> {{ assignment.assigning_doctor.get_full_name|default:assignment.assigning_doctor.username }}</li>
                                            {% if assignment.notes %}
                                            <li class="list-group-item"><strong>Примечания:</strong> {{ assignment.notes|linebreaksbr }}</li>
                                            {% endif %}
                                        </ul>
                                        <div class="mt-3 d-flex justify-content-end gap-2">
                                            {# ИЗМЕНЕНИЕ: Используем правильные методы для URL #}
                                            <a href="{{ assignment.get_update_url }}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit me-1"></i> Редактировать</a>
                                            <a href="{{ assignment.get_absolute_url }}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-info"><i class="fas fa-info-circle me-1"></i> Детали</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">Нет активных назначений.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4 border-secondary shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Завершенные / Приостановленные / Отмененные</h5>
                    </div>
                    <div class="card-body">
                        {% if inactive_assignments %}
                        <div class="accordion accordion-flush" id="inactiveAssignmentsAccordion">
                            {% for assignment in inactive_assignments %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="inactiveAssignmentHeading{{ assignment.assignment_type }}{{ assignment.pk }}">
                                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#inactiveAssignmentCollapse{{ assignment.assignment_type }}{{ assignment.pk }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="inactiveAssignmentCollapse{{ assignment.assignment_type }}{{ assignment.pk }}">
                                        {# ИЗМЕНЕНИЕ: Используем treatment_name из модели #}
                                        <strong>{{ assignment.treatment_name }}</strong>
                                        <span class="ms-auto text-muted small">
                                            {{ assignment.start_date|date:'d.m.Y H:i' }} - 
                                            {% if assignment.end_date %}
                                                {{ assignment.end_date|date:'d.m.Y H:i' }}
                                            {% else %}
                                                ({{ assignment.get_status_display }})
                                            {% endif %}
                                        </span>
                                    </button>
                                </h2>
                                <div id="inactiveAssignmentCollapse{{ assignment.assignment_type }}{{ assignment.pk }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="inactiveAssignmentHeading{{ assignment.assignment_type }}{{ assignment.pk }}" data-bs-parent="#inactiveAssignmentsAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-group list-group-flush">
                                            {# ИЗМЕНЕНИЕ: Динамический вывод деталей в зависимости от типа #}
                                            {% if assignment.assignment_type == 'medication' %}
                                                <li class="list-group-item"><strong>Дозировка:</strong> {{ assignment.dosage|default:"-" }}</li>
                                                <li class="list-group-item"><strong>Частота:</strong> {{ assignment.frequency|default:"-" }}</li>
                                                <li class="list-group-item"><strong>Путь введения:</strong> {{ assignment.route|default:"-" }}</li>
                                            {% endif %}
                                            <li class="list-group-item"><strong>Назначивший врач:</strong> {{ assignment.assigning_doctor.get_full_name|default:assignment.assigning_doctor.username }}</li>
                                            {% if assignment.notes %}
                                            <li class="list-group-item"><strong>Примечания:</strong> {{ assignment.notes|linebreaksbr }}</li>
                                            {% endif %}
                                        </ul>
                                        <div class="mt-3 d-flex justify-content-end gap-2">
                                            {# ИЗМЕНЕНИЕ: Используем правильные методы для URL #}
                                            <a href="{{ assignment.get_update_url }}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit me-1"></i> Редактировать</a>
                                            <a href="{{ assignment.get_absolute_url }}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-info"><i class="fas fa-info-circle me-1"></i> Детали</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">Нет неактивных назначений.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Фильтр документов</h5>
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-3">{{ filter_form.start_date.label_tag }}
                        {{ filter_form.start_date }}</div>
                    <div class="col-md-3">{{ filter_form.end_date.label_tag }}
                        {{ filter_form.end_date }}</div>
                    <div class="col-md-3">{{ filter_form.author.label_tag }}
                        {{ filter_form.author }}</div>
                    <div class="col-md-3">{{ filter_form.search_query.label_tag }}
                        {{ filter_form.search_query }}</div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">Применить фильтр</button>
                        <a href="{% url 'departments:patient_history' patient_status.pk %}" class="btn btn-secondary">Сбросить</a>
                    </div>
                </form>
            </div>
        </div>

        <ul class="nav nav-tabs flex-row mt-4" id="documentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="daily-notes-tab" data-bs-toggle="tab" data-bs-target="#daily-notes"
                        type="button" role="tab" aria-controls="daily-notes" aria-selected="true">Дневниковые записи
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments"
                        type="button" role="tab" aria-controls="assignments" aria-selected="false">Назначения
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="other-tab" data-bs-toggle="tab" data-bs-target="#other" type="button"
                        role="tab" aria-controls="other" aria-selected="false">Другое (будущие вкладки)
                </button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="documentTabsContent">
            <div class="tab-pane fade show active" id="daily-notes" role="tabpanel" aria-labelledby="daily-notes-tab">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Дневниковые записи</h5>
                            <a href="{% url 'documents:document_type_selection' model_name='patientdepartmentstatus' object_id=patient_status.pk %}?next={{ request.get_full_path|urlencode }}"
                               class="btn btn-primary btn-sm">
                                <i class="fas fa-plus me-1"></i> Добавить запись
                            </a>
                        </div>
                        {% if daily_notes_page_obj %}
                            <div class="accordion" id="dailyNotesAccordion">
                                {% for doc in daily_notes_page_obj %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="dailyNoteHeading{{ doc.pk }}">
                                            <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#dailyNoteCollapse{{ doc.pk }}"
                                                    aria-expanded="{% if forloop.first %}
                                                      true
                                                    {% else %}
                                                      false
                                                    {% endif %}"
                                                    aria-controls="dailyNoteCollapse{{ doc.pk }}">
                                                <strong>{{ doc.datetime_document|date:'d.m.Y H:i' }}</strong>
                                                — {{ doc.author.get_full_name|default:doc.author.username }}
                                                {% if doc.title %}
                                                    <span class="ms-auto text-muted small">{{ doc.title|truncatechars:50 }}</span>
                                                {% endif %}
                                            </button>
                                        </h2>
                                        <div id="dailyNoteCollapse{{ doc.pk }}"
                                             class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                                             aria-labelledby="dailyNoteHeading{{ doc.pk }}"
                                             data-bs-parent="#dailyNotesAccordion">
                                            <div class="accordion-body">
                                                {% load custom_filters %}
                                                <strong>Документ:</strong> {{ doc.document_type.name }}<br/>
                                                {% if doc.data.severity_assessment %}
                                                    <strong>Состояние:</strong><br/>{{ doc.data.severity_assessment|linebreaks }}
                                                {% endif %}
                                                <div class="mt-3 d-flex justify-content-end gap-2">
                                                    <a href="{% url 'documents:document_update' doc.pk %}?next={{ request.get_full_path|urlencode }}"
                                                       class="btn btn-sm btn-outline-primary"><i
                                                            class="fas fa-edit me-1"></i> Редактировать</a>
                                                    <a href="{% url 'documents:document_detail' doc.pk %}?next={{ request.get_full_path|urlencode }}"
                                                       class="btn btn-sm btn-outline-info"><i
                                                            class="fas fa-info-circle me-1"></i> Детали</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <nav aria-label="Навигация по дневникам" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    {% if daily_notes_page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?daily_notes_page=
                                                       {{ daily_notes_page_obj.previous_page_number }}{% for key, value in request.GET.items %}
                          {% if key != 'daily_notes_page' %}
                            &{{ key }}={{ value }}
                          {% endif %}
                        {% endfor %}">
                                                Предыдущая
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">Предыдущая</span>
                                        </li>
                                    {% endif %}

                                    {% for i in daily_notes_page_obj.paginator.page_range %}
                                        {% if daily_notes_page_obj.number == i %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ i }}</span>
                                            </li>
                                        {% else %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                   href="?daily_notes_page=
                                                           {{ i }}{% for key, value in request.GET.items %}
                            {% if key != 'daily_notes_page' %}
                              &{{ key }}={{ value }}
                            {% endif %}
                          {% endfor %}">
                                                    {{ i }}
                                                </a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}

                                    {% if daily_notes_page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?daily_notes_page=
                                                       {{ daily_notes_page_obj.next_page_number }}{% for key, value in request.GET.items %}
                          {% if key != 'daily_notes_page' %}
                            &{{ key }}={{ value }}
                          {% endif %}
                        {% endfor %}">
                                                Следующая
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">Следующая</span>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% else %}
                            <p class="text-muted">Нет дневниковых записей для отображения по заданным фильтрам.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="assignments" role="tabpanel" aria-labelledby="assignments-tab">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Медицинские назначения</h5>
                            <div class="btn-group" role="group" aria-label="Добавить назначение">
                                <a href="{% url 'treatment_assignments:medication_assignment_create' model_name='patientdepartmentstatus' object_id=patient_status.pk %}?next={{ request.get_full_path|urlencode }}"
                                   class="btn btn-primary btn-sm"><i class="fas fa-plus me-1"></i> Препарат</a>
                                <a href="{% url 'treatment_assignments:general_assignment_create' model_name='patientdepartmentstatus' object_id=patient_status.pk %}?next={{ request.get_full_path|urlencode }}"
                                   class="btn btn-primary btn-sm"><i class="fas fa-plus me-1"></i> Общее</a>
                                <a href="{% url 'treatment_assignments:lab_assignment_create' model_name='patientdepartmentstatus' object_id=patient_status.pk %}?next={{ request.get_full_path|urlencode }}"
                                   class="btn btn-primary btn-sm"><i class="fas fa-plus me-1"></i> Лаб.</a>
                                <a href="{% url 'treatment_assignments:instrumental_assignment_create' model_name='patientdepartmentstatus' object_id=patient_status.pk %}?next={{ request.get_full_path|urlencode }}"
                                   class="btn btn-primary btn-sm"><i class="fas fa-plus me-1"></i> Инстр.</a>
                            </div>
                        </div>
                        {% if assignments_page_obj %}
                            <div class="accordion" id="assignmentsAccordion">
                                {% for assignment in assignments_page_obj %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="assignmentHeading{{ assignment.pk }}">
                                            <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#assignmentCollapse{{ assignment.pk }}"
                                                    aria-expanded="{% if forloop.first %}
                                                      true
                                                    {% else %}
                                                      false
                                                    {% endif %}"
                                                    aria-controls="assignmentCollapse{{ assignment.pk }}">
                                                <strong>{{ assignment.start_date|date:'d.m.Y H:i' }}</strong>
                                                — {{ assignment.assigning_doctor.get_full_name|default:assignment.assigning_doctor.username }}
                                                <span class="ms-auto text-muted small">{{ assignment.treatment_name }}</span>
                                                {% if assignment.status == 'active' %}
                                                    <i class="fas fa-check-circle text-success ms-2" title="Активно"></i>
                                                {% elif assignment.status == 'completed' %}
                                                    <i class="fas fa-circle-check text-primary ms-2" title="Завершено"></i>
                                                {% elif assignment.status == 'paused' %}
                                                    <i class="fas fa-pause-circle text-warning ms-2" title="Приостановлено"></i>
                                                {% elif assignment.status == 'canceled' %}
                                                    <i class="fas fa-times-circle text-danger ms-2" title="Отменено"></i>
                                                {% endif %}
                                            </button>
                                        </h2>
                                        <div id="assignmentCollapse{{ assignment.pk }}"
                                             class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                                             aria-labelledby="assignmentHeading{{ assignment.pk }}"
                                             data-bs-parent="#assignmentsAccordion">
                                            <div class="accordion-body">
                                                <strong>Название лечения:</strong> {{ assignment.medication }}<br/>
                                                <strong>Дата начала:</strong> {{ assignment.start_date|date:'d.m.Y H:i' }}<br/>
                                                {% if assignment.end_date %}
                                                <strong>Дата завершения:</strong> {{ assignment.end_date|date:'d.m.Y H:i' }}<br/>
                                                {% endif %}
                                                <strong>Статус:</strong> {{ assignment.get_status_display }}
                                                <div class="mt-3 d-flex justify-content-end gap-2">
                                                    <a href="{{ assignment.get_update_url }}?next={{ request.get_full_path|urlencode }}"
                                                       class="btn btn-sm btn-outline-primary"><i
                                                            class="fas fa-edit me-1"></i> Редактировать</a>
                                                    <a href="{{ assignment.get_update_url }}?next={{ request.get_full_path|urlencode }}"
                                                       class="btn btn-sm btn-outline-info"><i
                                                            class="fas fa-info-circle me-1"></i> Детали</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <nav aria-label="Навигация по назначениям" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    {% if assignments_page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?assignments_page=
                                                       {{ assignments_page_obj.previous_page_number }}{% for key, value in request.GET.items %}
                          {% if key != 'assignments_page' %}
                            &{{ key }}={{ value }}
                          {% endif %}
                        {% endfor %}">
                                                Предыдущая
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">Предыдущая</span>
                                        </li>
                                    {% endif %}
                                    {% for i in assignments_page_obj.paginator.page_range %}
                                        {% if assignments_page_obj.number == i %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ i }}</span>
                                            </li>
                                        {% else %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                   href="?assignments_page=
                                                           {{ i }}{% for key, value in request.GET.items %}
                            {% if key != 'assignments_page' %}
                              &{{ key }}={{ value }}
                            {% endif %}
                          {% endfor %}">
                                                    {{ i }}
                                                </a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    {% if assignments_page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?assignments_page=
                                                       {{ assignments_page_obj.next_page_number }}{% for key, value in request.GET.items %}
                          {% if key != 'assignments_page' %}
                            &{{ key }}={{ value }}
                          {% endif %}
                        {% endfor %}">
                                                Следующая
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">Следующая</span>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% else %}
                            <p class="text-muted">Нет назначений для отображения по заданным фильтрам.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="other" role="tabpanel" aria-labelledby="other-tab">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Другие данные</h5>
                        <p class="text-muted">Здесь будут располагаться другие типы записей или информации.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
