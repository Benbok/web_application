# Детальная документация методов модуля Departments

## Модели (Models)

### Department

#### `__str__()`
**Назначение**: Строковое представление отделения
**Возвращает**: `str` - форматированная строка с информацией об отделении
**Формат**: "{slug} - {name}" или "{name}" если slug отсутствует
**Пример**: "cardiology - Кардиология" или "Кардиология"

### PatientDepartmentStatus

#### `__str__()`
**Назначение**: Строковое представление статуса пациента в отделении
**Возвращает**: `str` - форматированная строка с информацией о пациенте и отделении
**Формат**: "{ФИО пациента} - {название отделения} ({статус})"
**Пример**: "Иванов И.И. - Кардиология (Принят в отделение)"

#### `accept_patient(user)`
**Назначение**: Принятие пациента в отделение
**Параметры**:
- `user` (User) - сотрудник, принимающий пациента
**Возвращает**: `bool` - True если принятие успешно, False если статус не 'pending'
**Логика**:
1. Проверяет, что статус равен 'pending'
2. Устанавливает статус 'accepted'
3. Заполняет поле accepted_by
4. Сохраняет изменения
**Использование**: `patient_status.accept_patient(request.user)`

#### `discharge_patient()`
**Назначение**: Выписка пациента из отделения
**Возвращает**: `bool` - True если выписка успешна, False если статус не 'accepted'
**Логика**:
1. Проверяет, что статус равен 'accepted'
2. Устанавливает статус 'discharged'
3. Заполняет поле discharge_date текущим временем
4. Сохраняет изменения
**Использование**: `patient_status.discharge_patient()`

#### `cancel_transfer()`
**Назначение**: Отмена перевода пациента
**Возвращает**: `bool` - True если отмена успешна, False если статус не подходящий
**Логика**:
1. Проверяет, что статус в ['pending', 'accepted']
2. Устанавливает статус 'transfer_cancelled'
3. Добавляет заметку с датой отмены
4. Сохраняет изменения
**Использование**: `patient_status.cancel_transfer()`

#### `archive()`
**Назначение**: Архивирование статуса пациента с синхронизацией
**Логика**:
- Вызывает родительский метод archive() из ArchivableModel
- Не делает каскадное архивирование source_encounter для избежания рекурсии
**Использование**: `patient_status.archive()`

#### `unarchive()`
**Назначение**: Восстановление из архива
**Логика**:
- Вызывает родительский метод unarchive() из ArchivableModel
- Не делает каскадное разархивирование source_encounter
**Использование**: `patient_status.unarchive()`

## Представления (Views)

### DepartmentListView

#### `get_queryset()`
**Назначение**: Получение списка отделений
**Возвращает**: Queryset с исключением отделения "admission"
**Логика**: Фильтрует отделения, исключая системное отделение приема

#### `get_context_data()`
**Назначение**: Подготовка контекста для шаблона
**Возвращает**: `dict` - контекст с заголовком страницы
**Логика**: Добавляет заголовок "Отделения" в контекст

### DepartmentDetailView

#### `get_context_data()`
**Назначение**: Подготовка контекста с пациентами отделения
**Возвращает**: `dict` - контекст с пациентами по статусам
**Логика**:
1. Получает ожидающих пациентов (status='pending')
2. Получает принятых пациентов (status='accepted')
3. Оптимизирует запросы с select_related
4. Сортирует по датам
**Контекст**:
- `pending_patients` - пациенты ожидающие принятия
- `accepted_patients` - пациенты принятые в отделение
- `title` - заголовок страницы

### PatientDepartmentAcceptView

#### `post()`
**Назначение**: Обработка принятия пациента
**Параметры**: `request`, `pk`, `department_pk`
**Логика**:
1. Получает PatientDepartmentStatus по pk
2. Проверяет соответствие отделения
3. Вызывает accept_patient() с текущим пользователем
4. Показывает уведомление о результате
5. Перенаправляет к деталям отделения
**Возвращает**: HttpResponse с перенаправлением

### PatientDepartmentHistoryView

#### `get_filtered_documents_and_assignments(patient_status, filter_form)`
**Назначение**: Получение отфильтрованных документов и назначений
**Параметры**:
- `patient_status` (PatientDepartmentStatus) - статус пациента
- `filter_form` (DocumentAndAssignmentFilterForm) - форма фильтрации
**Возвращает**: `tuple` - (documents, medication_assignments, general_treatment_assignments, lab_test_assignments, instrumental_procedure_assignments)
**Логика**:
1. Получает ContentType для PatientDepartmentStatus
2. Фильтрует документы по отделению
3. Фильтрует все типы назначений
4. Применяет фильтры из формы:
   - По датам (start_date, end_date)
   - По автору (author)
   - По типу документа (document_type)
   - По поисковому запросу (search_query)
5. Сортирует результаты по датам

#### `paginate_queryset(queryset, page_param, per_page=10)`
**Назначение**: Пагинация queryset
**Параметры**:
- `queryset` - набор данных для пагинации
- `page_param` (str) - параметр страницы в URL
- `per_page` (int) - количество элементов на странице
**Возвращает**: Page object
**Логика**:
1. Создает Paginator с указанным количеством элементов
2. Получает номер страницы из GET параметров
3. Возвращает объект страницы

#### `get_context_data()`
**Назначение**: Подготовка контекста для истории пациента
**Возвращает**: `dict` - контекст с отфильтрованными и пагинированными данными
**Логика**:
1. Создает форму фильтрации
2. Получает отфильтрованные данные
3. Применяет пагинацию к каждому типу данных
4. Добавляет заголовок страницы
**Контекст**:
- `filter_form` - форма фильтрации
- `daily_notes_page_obj` - пагинированные документы
- `medication_assignments_page_obj` - пагинированные назначения лекарств
- `general_treatment_assignments_page_obj` - пагинированные общие назначения
- `lab_test_assignments_page_obj` - пагинированные лабораторные анализы
- `instrumental_procedure_assignments_page_obj` - пагинированные инструментальные процедуры
- `title` - заголовок страницы

### PatientAcceptanceView

#### `form_valid(form)`
**Назначение**: Обработка валидной формы принятия пациента
**Параметры**: `form` (PatientAcceptanceForm)
**Логика**:
1. Сохраняет форму без коммита
2. Устанавливает статус 'accepted'
3. Заполняет поле accepted_by текущим пользователем
4. Сохраняет объект
5. Показывает уведомление об успехе
6. Перенаправляет к success_url
**Возвращает**: HttpResponse с перенаправлением

#### `get_success_url()`
**Назначение**: Определение URL для перенаправления после успешного принятия
**Возвращает**: `str` - URL для перенаправления
**Логика**:
1. Проверяет параметр 'next' в GET запросе
2. Если есть - возвращает его
3. Иначе возвращает URL деталей отделения

#### `get_context_data()`
**Назначение**: Подготовка контекста для формы принятия
**Возвращает**: `dict` - контекст с заголовком и next_url
**Контекст**:
- `title` - заголовок страницы
- `next_url` - URL для перенаправления

### PatientDepartmentDischargeView

#### `post()`
**Назначение**: Обработка выписки пациента
**Параметры**: `request`, `pk`, `department_pk`
**Логика**:
1. Получает PatientDepartmentStatus по pk
2. Проверяет соответствие отделения
3. Вызывает discharge_patient()
4. Показывает уведомление о результате
5. Перенаправляет к деталям отделения
**Возвращает**: HttpResponse с перенаправлением

## Формы (Forms)

### DepartmentForm

#### `clean_slug()`
**Назначение**: Валидация и генерация slug
**Возвращает**: `str` - валидный slug
**Логика**:
1. Получает slug из cleaned_data
2. Если slug пустой - генерирует из названия
3. Возвращает обработанный slug
**Использование**: Автоматически вызывается при валидации формы

### DocumentAndAssignmentFilterForm

#### `__init__(*args, **kwargs)`
**Назначение**: Инициализация формы с динамической фильтрацией
**Параметры**: `department` (Department) - отделение для фильтрации
**Логика**:
1. Извлекает department из kwargs
2. Вызывает родительский __init__
3. Если отделение передано - фильтрует типы документов по отделению
4. Иначе показывает все типы документов

## Админ-панель (Admin)

### DepartmentAdmin

#### `has_add_permission(request)`
**Назначение**: Проверка права на создание отделений
**Возвращает**: `bool` - True только для суперпользователей

#### `has_change_permission(request, obj=None)`
**Назначение**: Проверка права на изменение отделений
**Возвращает**: `bool` - True только для суперпользователей

#### `has_delete_permission(request, obj=None)`
**Назначение**: Проверка права на удаление отделений
**Возвращает**: `bool` - True только для суперпользователей

### PatientDepartmentStatusAdmin

#### `archive_selected(request, queryset)`
**Назначение**: Массовое архивирование статусов пациентов
**Параметры**:
- `request` - HTTP запрос
- `queryset` - выбранные объекты
**Логика**:
1. Вызывает archive() для каждого объекта
2. Показывает уведомление о количестве архивированных записей
**Сообщение**: "X записей архивировано."

#### `unarchive_selected(request, queryset)`
**Назначение**: Массовое восстановление статусов пациентов из архива
**Параметры**:
- `request` - HTTP запрос
- `queryset` - выбранные объекты
**Логика**:
1. Сбрасывает флаги архивирования для каждого объекта
2. Показывает уведомление о количестве восстановленных записей
**Сообщение**: "X записей восстановлено из архива."

#### `get_queryset(request)`
**Назначение**: Получение всех записей включая архивированные
**Возвращает**: Queryset через all_objects

## Шаблонные теги (Template Tags)

### custom_filters.py

#### `last_category(value)`
**Назначение**: Извлечение последней категории из иерархического пути
**Параметры**: `value` - строка с иерархическим путем
**Возвращает**: `str` - последняя категория или пустая строка
**Логика**:
1. Проверяет наличие значения
2. Если содержит "->" - разделяет и берет последний элемент
3. Иначе разделяет по "] " и берет второй элемент
**Примеры**:
- "A -> B -> C" → "C"
- "[Category] Subcategory" → "Subcategory"

## Примеры использования

### Создание отделения
```python
department = Department.objects.create(
    name="Кардиология",
    slug="cardiology",
    description="Отделение кардиологии"
)
```

### Принятие пациента в отделение
```python
patient_status = PatientDepartmentStatus.objects.get(id=1)
if patient_status.accept_patient(request.user):
    print("Пациент успешно принят")
else:
    print("Пациент уже принят или имеет другой статус")
```

### Выписка пациента из отделения
```python
patient_status = PatientDepartmentStatus.objects.get(id=1)
if patient_status.discharge_patient():
    print("Пациент успешно выписан")
else:
    print("Пациент не может быть выписан")
```

### Отмена перевода
```python
patient_status = PatientDepartmentStatus.objects.get(id=1)
if patient_status.cancel_transfer():
    print("Перевод отменен")
else:
    print("Перевод не может быть отменен")
```

### Архивирование статуса
```python
patient_status = PatientDepartmentStatus.objects.get(id=1)
patient_status.archive()  # Архивирует статус пациента
```

### Фильтрация документов и назначений
```python
# В представлении
filter_form = DocumentAndAssignmentFilterForm(request.GET, department=department)
docs, meds, generals, labs, procedures = self.get_filtered_documents_and_assignments(
    patient_status, filter_form
)
```

### Пагинация данных
```python
# В представлении
paginated_docs = self.paginate_queryset(docs, 'daily_notes_page', 10)
```

### Использование шаблонного тега
```django
{% load custom_filters %}
{{ category_path|last_category }}
``` 