{% extends "patients/base.html" %}
{% load static %}

{% block title %}{{ examination_plan.name }}{% endblock %}

{% block content %}
{% comment %} Блок сообщений Django оставлен без изменений {% endcomment %}
{% if messages %}
<div class="messages mt-3">
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endfor %}
</div>
{% endif %}

{% comment %} 
  Основная карточка плана обследования. 
  Ключевое изменение: все действия теперь собраны в заголовке в одном месте.
{% endcomment %}
<div class="card mt-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            {% comment %} Левая часть: Название и базовая информация {% endcomment %}
            <div>
                <h4 class="card-title mb-0">
                    <i class="fas fa-notes-medical"></i> {{ examination_plan.name }}
                </h4>
                <small class="text-muted">
                    {% if owner.patient %}
                        Пациент: <a href="{% url 'patients:patient_detail' owner.patient.pk %}">{{ owner.patient.get_full_name_with_age }}</a>
                        {% if owner_model == 'encounter' %}
                            | Случай: <a href="{% url 'encounters:encounter_detail' owner.id %}">{{ owner.date_start|date:"d.m.Y" }}</a>
                        {% endif %}
                    {% else %}
                        {{ owner }}
                    {% endif %}
                </small>
            </div>
            {% comment %} 
              Правая часть: ЕДИНАЯ панель действий.
              - Главные действия ("Добавить") - это яркие кнопки.
              - Второстепенные и опасные действия убраны в выпадающее меню.
            {% endcomment %}
            <div class="btn-toolbar mt-2 mt-md-0" role="toolbar">
                <div class="btn-group me-2" role="group">
                    <a href="{% url 'examination_management:lab_test_create' plan_pk=examination_plan.pk %}" class="btn btn-success">
                        <i class="fas fa-flask me-1"></i> Добавить лабораторное
                    </a>
                    <a href="{% url 'examination_management:instrumental_create' plan_pk=examination_plan.pk %}" class="btn btn-info">
                        <i class="fas fa-stethoscope me-1"></i> Добавить инструментальное
                    </a>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        Действия
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">

                        <li><a class="dropdown-item text-danger" href="{% if owner_model == 'encounter' %}{% url 'examination_management:examination_plan_delete' encounter_pk=owner.pk pk=examination_plan.pk %}{% else %}{% url 'examination_management:plan_delete' owner_model=owner_model owner_id=owner.id pk=examination_plan.pk %}{% endif %}">
                            <i class="fas fa-trash fa-fw me-2"></i>Удалить план
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        {% comment %} 
          Информационный блок - ПЕРЕРАБОТАН в компактные бейджи
        {% endcomment %}
        <div class="mb-4">
            {% if examination_plan.description %}
                <div class="mb-3">
                    <h6 class="card-subtitle mb-2 text-muted">Описание:</h6>
                    <p class="mb-0">{{ examination_plan.description|linebreaks }}</p>
                </div>
            {% endif %}
            
            {% comment %} Блок прогресса выполнения плана {% endcomment %}
            {% if progress and progress.total > 0 %}
            <div class="mb-3">
                <h6 class="card-subtitle mb-2 text-muted">Прогресс выполнения:</h6>
                <div class="row">
                    <div class="col-md-8">
                        <div class="progress mb-2" style="height: 25px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ progress.percentage|default:0 }}%" 
                                 aria-valuenow="{{ progress.percentage|default:0 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ progress.percentage|default:0 }}%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex flex-column">
                            <small class="text-success">
                                <i class="fas fa-check-circle me-1"></i>Выполнено: {{ progress.completed|default:0 }}/{{ progress.total }}
                            </small>
                            {% if progress.rejected and progress.rejected > 0 %}
                            <small class="text-danger">
                                <i class="fas fa-times-circle me-1"></i>Забраковано: {{ progress.rejected }}
                            </small>
                            {% endif %}
                            {% if progress.active and progress.active > 0 %}
                            <small class="text-primary">
                                <i class="fas fa-clock me-1"></i>В работе: {{ progress.active }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                {% comment %} Общий статус плана {% endcomment %}
                <div class="mt-2">
                    {% if progress.status == 'completed' %}
                        <span class="badge bg-success fs-6">
                            <i class="fas fa-check-circle me-1"></i>План полностью выполнен
                        </span>
                    {% elif progress.status == 'rejected' %}
                        <span class="badge bg-danger fs-6">
                            <i class="fas fa-times-circle me-1"></i>Все исследования забракованы
                        </span>
                    {% elif progress.status == 'in_progress' %}
                        <span class="badge bg-warning fs-6">
                            <i class="fas fa-clock me-1"></i>План в процессе выполнения
                        </span>
                    {% else %}
                        <span class="badge bg-secondary fs-6">
                            <i class="fas fa-hourglass-start me-1"></i>План ожидает выполнения
                        </span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="mb-3">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Прогресс выполнения:</strong> 
                    {% if progress %}
                        Всего исследований: {{ progress.total|default:0 }}, 
                        Выполнено: {{ progress.completed|default:0 }}, 
                        Забраковано: {{ progress.rejected|default:0 }}, 
                        В работе: {{ progress.active|default:0 }}
                    {% else %}
                        Данные прогресса недоступны
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <div class="d-flex flex-wrap gap-2">
                <span class="badge bg-light text-dark">
                    <i class="fas fa-clock me-1"></i>Создан: {{ examination_plan.created_at|date:"d.m.Y H:i" }}
                </span>
                <span class="badge bg-success text-white">
                    <i class="fas fa-flask me-1"></i>Лабораторных: {{ examination_plan.lab_tests.all.count }}
                </span>
                <span class="badge bg-info text-white">
                    <i class="fas fa-stethoscope me-1"></i>Инструментальных: {{ examination_plan.instrumental_procedures.all.count }}
                </span>
            </div>
        </div>
        
        <hr>

        {% comment %} Блок с лабораторными исследованиями - ПЕРЕРАБОТАН в компактные карточки {% endcomment %}
        <h5 class="mb-3"><i class="fas fa-flask me-1"></i> Лабораторные исследования</h5>
        {% if lab_tests_with_status %}
            <div class="row">
                {% for item in lab_tests_with_status %}
                {% with lab_test=item.examination_lab_test status_info=item.status_info schedule_data=item.schedule_data %}
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 {% if status_info.status == 'completed' %}border-success{% elif status_info.status == 'rejected' %}border-danger{% elif status_info.status == 'active' %}border-primary{% else %}border-secondary{% endif %}">
                        <div class="card-header bg-white p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        {% if lab_test.is_archived %}
                                            <i class="fas fa-archive text-warning me-2" title="Исследование архивировано"></i>
                                        {% elif status_info.status != 'active' and status_info.has_results %}
                                            <i class="fas fa-lock text-muted me-2" title="Исследование заблокировано для редактирования"></i>
                                        {% endif %}
                                        {{ lab_test.lab_test.name }}
                                    </h6>
                                    {% if lab_test.instructions %}
                                        <small class="text-muted">{{ lab_test.instructions|linebreaks }}</small>
                                    {% endif %}
                                </div>
                                <span class="badge {% if status_info.status == 'completed' %}bg-success{% elif status_info.status == 'rejected' %}bg-danger{% elif status_info.status == 'active' %}bg-primary{% else %}bg-secondary{% endif %} ms-2">
                                    {{ status_info.status_display }}
                                </span>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            {% if lab_test.instructions %}
                            <div class="mb-2">
                                <strong>Инструкции:</strong> {{ lab_test.instructions }}
                            </div>
                            {% endif %}
                            {% if lab_test.lab_test.description %}
                            <div class="mb-2">
                                <small class="text-muted">{{ lab_test.lab_test.description|truncatewords:15 }}</small>
                            </div>
                            {% endif %}
                            
                            {% comment %} Данные о назначении {% endcomment %}
                            <div class="mb-2">
                                {% if schedule_data %}
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>Назначено: {{ schedule_data.assigned_at|date:"d.m.Y" }}
                                        {% if schedule_data.first_time %}
                                            <i class="fas fa-clock me-1"></i>{{ schedule_data.first_time|time:"H:i" }}
                                        {% endif %}
                                    </small>
                                {% endif %}
                            </div>
                            
                            {% comment %} Информация о статусе {% endcomment %}
                            <div class="mt-2">
                                {% if status_info.status == 'completed' %}
                                    <div class="alert alert-success py-2 mb-2">
                                        <small>
                                            <i class="fas fa-check-circle me-1"></i>
                                            <strong>Выполнено:</strong> {{ status_info.end_date|date:"d.m.Y H:i" }}
                                            {% if status_info.completed_by %}
                                                <br>Выполнил: {{ status_info.completed_by.doctor_profile.full_name|default:status_info.completed_by.get_full_name|default:status_info.completed_by.username }}
                                            {% endif %}
                                        </small>
                                    </div>
                                    {% if not status_info.has_results %}
                                        <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <strong>Внимание:</strong> Исследование завершено без результатов. Редактирование недоступно.
                                        </div>
                                    {% endif %}
                                {% elif status_info.status == 'rejected' %}
                                    <div class="alert alert-danger py-2 mb-2">
                                        <small>
                                            <i class="fas fa-times-circle me-1"></i>
                                            <strong>Забраковано:</strong> {{ status_info.end_date|date:"d.m.Y H:i" }}
                                            {% if status_info.completed_by %}
                                                <br>Забраковал: {{ status_info.completed_by.doctor_profile.full_name|default:status_info.completed_by.get_full_name|default:status_info.completed_by.username }}
                                            {% endif %}
                                            {% if status_info.rejection_reason %}
                                                <br><strong>Причина:</strong> {{ status_info.rejection_reason|truncatechars:50 }}
                                            {% endif %}
                                        </small>
                                    </div>
                                    {% if not status_info.has_results %}
                                        <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 0.8rem;">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <strong>Внимание:</strong> Исследование забраковано без результатов. Редактирование недоступно.
                                        </div>
                                    {% endif %}
                                {% elif status_info.status == 'active' %}
                                    <div class="alert alert-primary py-2 mb-2">
                                        <small>
                                            <i class="fas fa-clock me-1"></i>
                                            <strong>Ожидает выполнения</strong>
                                        </small>
                                    </div>
                                {% elif status_info.status == 'cancelled' %}
                                    <div class="alert alert-secondary py-2 mb-2">
                                        <small>
                                            <i class="fas fa-ban me-1"></i>
                                            <strong>Отменено:</strong> {{ lab_test.cancelled_at|date:"d.m.Y H:i" }}
                                            {% if lab_test.cancelled_by %}
                                                <br>Отменено: {{ lab_test.cancelled_by.get_full_name|default:lab_test.cancelled_by.username }}
                                            {% endif %}
                                            {% if lab_test.cancellation_reason %}
                                                <br><strong>Причина:</strong> {{ lab_test.cancellation_reason|truncatechars:50 }}
                                            {% endif %}
                                        </small>
                                    </div>
                                {% endif %}
                            </div>
                            
                            {% comment %} Информация о добавлении {% endcomment %}
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>Добавлено: {{ lab_test.created_at|date:"d.m.Y H:i" }}
                                </small>
                            </div>

                        </div>
                        <div class="card-footer bg-white p-2">
                            <div class="d-flex justify-content-end gap-2">
                                {% if status_info.status == 'completed' %}
                                    <a href="{% url 'examination_management:lab_test_result_view' pk=lab_test.pk %}" 
                                       class="btn btn-outline-info btn-sm"
                                       title="Просмотреть результат">
                                        <i class="fas fa-eye me-1"></i> Просмотреть результат
                                    </a>
                                    <span class="btn btn-outline-secondary btn-sm disabled" 
                                          title="Удаление невозможно - исследование выполнено">
                                        <i class="fas fa-check me-1"></i> Выполнено
                                    </span>
                                {% elif status_info.status == 'cancelled' %}
                                    <span class="btn btn-outline-secondary btn-sm disabled" 
                                          title="Исследование отменено">
                                        <i class="fas fa-ban me-1"></i> Отменено
                                    </span>
                                {% else %}
                                    {% with can_cancel=lab_test.can_be_cancelled %}
                                    {% if can_cancel.0 %}
                                        <a href="{% url 'examination_management:lab_test_cancel' pk=lab_test.pk %}" 
                                           class="btn btn-outline-warning btn-sm">
                                            <i class="fas fa-ban me-1"></i> Отменить
                                        </a>
                                    {% else %}
                                        <span class="btn btn-outline-secondary btn-sm disabled" 
                                              title="{{ can_cancel.1 }}">
                                            <i class="fas fa-ban me-1"></i> Отменить
                                        </span>
                                    {% endif %}
                                    {% endwith %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center p-4 border rounded bg-light">
                <i class="fas fa-flask fa-2x text-muted mb-2"></i>
                <h6 class="text-muted">Лабораторные исследования пока не добавлены</h6>
                <p class="text-muted small">Начните, добавив первое лабораторное исследование в план обследования.</p>
                <a href="{% url 'examination_management:lab_test_create' plan_pk=examination_plan.pk %}" class="btn btn-success btn-sm">
                     <i class="fas fa-plus me-1"></i> Добавить лабораторное
                 </a>
            </div>
        {% endif %}
    </div>
</div>

{% comment %} Блок с инструментальными исследованиями. Логика не менялась, только стили "пустого состояния" {% endcomment %}
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-stethoscope me-1"></i> Инструментальные исследования</h5>
        <a href="{% url 'examination_management:instrumental_create' plan_pk=examination_plan.pk %}" class="btn btn-info btn-sm">
            <i class="fas fa-plus me-1"></i> Добавить инструментальное
        </a>
    </div>
    <div class="card-body">
        {% if instrumental_procedures_with_status %}
            {% comment %} Компактный список инструментальных исследований с отображением статусов {% endcomment %}
            <ul class="list-group">
                {% for item in instrumental_procedures_with_status %}
                {% with instrumental=item.examination_instrumental status_info=item.status_info schedule_data=item.schedule_data %}
                <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="me-3">
                                <div class="d-flex align-items-center mb-1">
                                    <p class="mb-0 me-2">
                                        {% if instrumental.is_archived %}
                                            <i class="fas fa-archive text-warning me-1" title="Исследование архивировано"></i>
                                        {% elif status_info.status != 'active' %}
                                            <i class="fas fa-lock text-muted me-1" title="Исследование заблокировано для редактирования"></i>
                                        {% endif %}
                                        {{ instrumental.instrumental_procedure.name }}
                                    </p>
                                    <span class="badge {% if status_info.status == 'completed' %}bg-success{% elif status_info.status == 'rejected' %}bg-danger{% elif status_info.status == 'active' %}bg-primary{% else %}bg-secondary{% endif %}">
                                        {{ status_info.status_display }}
                                    </span>
                                </div>
                                
                                {% if instrumental.instructions %}
                                <small class="text-muted">{{ instrumental.instructions|linebreaks }}</small>
                                {% endif %}
                                
                                {% comment %} Данные о назначении {% endcomment %}
                                <div class="mt-1">
                                    {% if schedule_data %}
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>Назначено: {{ schedule_data.assigned_at|date:"d.m.Y" }}
                                            {% if schedule_data.first_time %}
                                                <i class="fas fa-clock me-1"></i>{{ schedule_data.first_time|time:"H:i" }}
                                            {% endif %}
                                        </small>
                                    {% else %}
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>Добавлено: {{ instrumental.created_at|date:"d.m.Y H:i" }}
                                        </small>
                                    {% endif %}
                                </div>
                                
                                {% comment %} Информация о статусе {% endcomment %}
                                {% if status_info.status == 'completed' %}
                                    <div class="alert alert-success py-1 px-2 mt-1 mb-1" style="font-size: 0.8rem;">
                                        <i class="fas fa-check-circle me-1"></i>
                                        <strong>Выполнено:</strong> {{ status_info.end_date|date:"d.m.Y H:i" }}
                                        {% if status_info.completed_by %}
                                            | Выполнил: {{ status_info.completed_by.doctor_profile.full_name|default:status_info.completed_by.get_full_name|default:status_info.completed_by.username }}
                                        {% endif %}
                                    </div>
                                    {% if not status_info.has_results %}
                                        <div class="alert alert-warning py-1 px-2 mt-1 mb-1" style="font-size: 0.8rem;">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <strong>Внимание:</strong> Исследование завершено без результатов. Редактирование недоступно.
                                        </div>
                                    {% endif %}
                                {% elif status_info.status == 'rejected' %}
                                    <div class="alert alert-danger py-1 px-2 mt-1 mb-1" style="font-size: 0.8rem;">
                                        <i class="fas fa-times-circle me-1"></i>
                                        <strong>Забраковано:</strong> {{ status_info.end_date|date:"d.m.Y H:i" }}
                                        {% if status_info.completed_by %}
                                            | Забраковал: {{ status_info.completed_by.doctor_profile.full_name|default:status_info.completed_by.get_full_name|default:status_info.completed_by.username }}
                                        {% endif %}
                                        {% if status_info.rejection_reason %}
                                            | <strong>Причина:</strong> {{ status_info.rejection_reason|truncatechars:50 }}
                                        {% endif %}
                                    </div>
                                    {% if not status_info.has_results %}
                                        <div class="alert alert-warning py-1 px-2 mt-1 mb-1" style="font-size: 0.8rem;">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <strong>Внимание:</strong> Исследование забраковано без результатов. Редактирование недоступно.
                                        </div>
                                    {% endif %}
                                {% elif status_info.status == 'active' %}
                                    <div class="alert alert-primary py-1 px-2 mt-1 mb-1" style="font-size: 0.8rem;">
                                        <i class="fas fa-clock me-1"></i>
                                        <strong>Ожидает выполнения</strong>
                                    </div>
                                {% elif status_info.status == 'cancelled' %}
                                    <div class="alert alert-secondary py-1 px-2 mt-1 mb-1" style="font-size: 0.8rem;">
                                        <i class="fas fa-ban me-1"></i>
                                        <strong>Отменено:</strong> {{ instrumental.cancelled_at|date:"d.m.Y H:i" }}
                                        {% if instrumental.cancelled_by %}
                                            <br>Отменено: {{ instrumental.cancelled_by.get_full_name|default:instrumental.cancelled_by.username }}
                                        {% endif %}
                                        {% if instrumental.cancellation_reason %}
                                            <br><strong>Причина:</strong> {{ instrumental.cancellation_reason|truncatechars:50 }}
                                        {% endif %}
                                    </div>
                                {% endif %}
                                

                            </div>
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm" role="group">
                        {% if status_info.status == 'completed' %}
                            <a href="{% url 'examination_management:instrumental_result_view' pk=instrumental.pk %}" 
                               class="btn btn-outline-info btn-sm"
                               title="Просмотреть результат">
                                <i class="fas fa-eye"></i> Просмотреть результат
                            </a>
                            <span class="btn btn-outline-secondary btn-sm disabled" 
                                  title="Удаление невозможно - исследование выполнено">
                                <i class="fas fa-check"></i> Выполнено
                            </span>
                        {% elif status_info.status == 'cancelled' %}
                            <span class="btn btn-outline-secondary btn-sm disabled" 
                                  title="Исследование отменено">
                                <i class="fas fa-ban"></i> Отменено
                            </span>
                        {% else %}
                            {% with can_cancel=instrumental.can_be_cancelled %}
                            {% if can_cancel.0 %}
                                <a href="{% url 'examination_management:instrumental_cancel' pk=instrumental.pk %}" 
                                   class="btn btn-outline-warning btn-sm"
                                   title="Отменить">
                                    <i class="fas fa-ban"></i> Отменить
                                </a>
                            {% else %}
                                <span class="btn btn-outline-secondary btn-sm disabled" 
                                      title="{{ can_cancel.1 }}">
                                    <i class="fas fa-ban"></i> Отменить
                                </span>
                            {% endif %}
                            {% endwith %}
                        {% endif %}
                    </div>
                </li>
                {% endwith %}
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center p-4 border rounded bg-light">
                <i class="fas fa-stethoscope fa-2x text-muted mb-2"></i>
                <h6 class="text-muted">Инструментальные исследования не добавлены</h6>
                <p class="text-muted small">Добавьте первое инструментальное исследование в план обследования.</p>
                <a href="{% url 'examination_management:instrumental_create' plan_pk=examination_plan.pk %}" class="btn btn-info btn-sm">
                    <i class="fas fa-plus me-1"></i> Добавить инструментальное
                </a>
            </div>
        {% endif %}
    </div>
</div>

{% comment %} Навигационные кнопки внизу страницы. Логично сгруппированы. {% endcomment %}
<div class="d-flex gap-2 mt-4">
    <a href="{% if owner_model == 'encounter' %}{% url 'examination_management:examination_plan_list' encounter_pk=owner.pk %}{% else %}{% url 'examination_management:plan_list' owner_model=owner_model owner_id=owner.id %}{% endif %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i> Все планы обследования
    </a>
    {% if owner_model == 'encounter' %}
        <a href="{% url 'encounters:encounter_detail' pk=owner.pk %}" class="btn btn-outline-secondary">
            <i class="fas fa-user me-1"></i> Вернуться к случаю
        </a>
    {% elif owner_model == 'patientdepartmentstatus' %}
        <a href="{% url 'departments:patient_history' pk=owner.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-history me-1"></i> Вернуться к истории
        </a>
    {% endif %}
</div>

{% endblock %} 