# Интеграция статусов исследований в план обследования

## Обзор изменений

Реализована передача статуса исследования в план обследования пациента, что позволяет врачам видеть актуальное состояние всех назначений прямо в плане обследования.

## Детали изменений

### 1. Модели (examination_management/models.py)

#### Новые методы в ExaminationPlan:

- **`get_lab_test_status(examination_lab_test)`** - получает статус лабораторного исследования из связанного назначения
- **`get_instrumental_procedure_status(examination_instrumental)`** - получает статус инструментального исследования из связанного назначения
- **`get_overall_progress()`** - вычисляет общий прогресс выполнения плана обследования

#### Возвращаемая информация о статусе:
```python
{
    'status': 'completed|rejected|active|unknown',
    'status_display': 'Выполнено|Забраковано|Активно|Неизвестно',
    'completed_by': User,  # кто выполнил/забраковал
    'end_date': datetime,  # дата завершения
    'rejection_reason': str,  # причина брака (если есть)
    'assignment_id': int  # ID назначения
}
```

#### Информация о прогрессе плана:
```python
{
    'total': 5,           # общее количество исследований
    'completed': 3,       # выполнено
    'rejected': 1,        # забраковано
    'active': 1,          # в работе
    'percentage': 60.0,   # процент выполнения
    'status': 'in_progress'  # общий статус плана
}
```

### 2. Представления (examination_management/views.py)

#### ExaminationPlanDetailView:
- Добавлена передача информации о прогрессе плана
- Добавлена передача статусов для каждого исследования
- Контекст теперь включает:
  - `progress` - общий прогресс плана
  - `lab_tests_with_status` - лабораторные исследования со статусами
  - `instrumental_procedures_with_status` - инструментальные исследования со статусами

#### ExaminationPlanListView:
- Добавлена передача информации о прогрессе для каждого плана
- Контекст теперь включает `plans_with_progress`

### 3. Шаблоны

#### plan_detail.html:
- **Блок прогресса**: добавлен прогресс-бар с процентами выполнения
- **Статусы исследований**: каждое исследование показывает свой текущий статус
- **Цветовая индикация**: карточки и заголовки меняют цвет в зависимости от статуса
- **Детальная информация**: отображается кто выполнил, когда, причины брака

#### plan_list.html:
- **Прогресс-бары**: каждый план показывает свой прогресс выполнения
- **Статус-бейджи**: цветные индикаторы общего статуса плана
- **Статистика**: количество выполненных/забракованных исследований

## Логика работы

### Получение статуса исследования:
1. Система находит связанное назначение через ContentType
2. Извлекает всю информацию о статусе из назначения
3. Возвращает структурированную информацию для отображения

### Вычисление прогресса плана:
1. Подсчитывает общее количество исследований
2. Анализирует статус каждого исследования
3. Вычисляет процент выполнения
4. Определяет общий статус плана

### Отображение в интерфейсе:
1. **Зеленый** - выполнено
2. **Красный** - забраковано
3. **Синий** - активно/в работе
4. **Серый** - неизвестно/другое

## Преимущества изменений

1. **Прозрачность**: врачи видят реальное состояние всех назначений
2. **Контроль**: можно отслеживать прогресс выполнения плана
3. **Аналитика**: видно, сколько исследований выполнено/забраковано
4. **Удобство**: вся информация собрана в одном месте
5. **Визуализация**: цветовые индикаторы и прогресс-бары

## Примеры использования

### Врач видит:
- Общий прогресс выполнения плана (например, 60% выполнено)
- Какие исследования уже выполнены (зеленые карточки)
- Какие забракованы и почему (красные карточки с причиной)
- Какие ожидают выполнения (синие карточки)

### В списке планов:
- Быстрое понимание, какие планы выполнены полностью
- Какие планы требуют внимания
- Общая статистика по всем планам пациента

## Технические детали

- Используется система ContentTypes для связи планов с назначениями
- Статусы синхронизируются в реальном времени
- Добавлена обработка ошибок для случаев, когда назначение не найдено
- Оптимизированы запросы к базе данных 