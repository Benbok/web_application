{% extends 'patients/base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid p-4 bg-light min-vh-100">
  <div class="card shadow-sm border-0 ">
    <div class="card-body p-4">
      <h2 class="card-title mb-4 fw-bold">{{ title }}</h2>

      <form method="post">
        {% csrf_token %}

        <div class="row g-3">
          {% comment %} Hidden fields {% endcomment %}
          {{ form.patient }}

          {# Row 1: Дата начала и Препарат #}
          <div class="col-12 col-md-6 mb-3">
            <label for="{{ form.start_date.id_for_label }}" class="form-label fw-medium">
              {{ form.start_date.label }}
              {% if form.start_date.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.start_date|add_class:"form-control" }}
            {% for error in form.start_date.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="col-12 col-md-6 mb-3">
            <label for="{{ form.medication.id_for_label }}" class="form-label fw-medium">
              {{ form.medication.label }}
              {% if form.medication.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.medication }}
            {% for error in form.medication.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>

          {# Row 2: Вес пациента, Дозировка на кг и Расчетная дозировка #}
          <div class="col-12 col-md-4 mb-3">
            <label for="{{ form.patient_weight.id_for_label }}" class="form-label fw-medium">
              {{ form.patient_weight.label }}
              {% if form.patient_weight.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.patient_weight|add_class:"form-control" }}
            {% for error in form.patient_weight.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="col-12 col-md-4 mb-3">
            <label for="{{ form.dosage_per_kg.id_for_label }}" class="form-label fw-medium">
              {{ form.dosage_per_kg.label }}
              {% if form.dosage_per_kg.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.dosage_per_kg|add_class:"form-control" }}
            {% for error in form.dosage_per_kg.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="col-12 col-md-4 mb-3">
            <label for="{{ form.calculated_dosage.id_for_label }}" class="form-label fw-medium">
              {{ form.calculated_dosage.label }}
              {% if form.calculated_dosage.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.calculated_dosage|add_class:"form-control" }}
            {% for error in form.calculated_dosage.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>

          {# Row 3: Частота, Длительность, Путь введения #}
          <div class="col-12 col-md-4 mb-3">
            <label for="{{ form.frequency.id_for_label }}" class="form-label fw-medium">
              {{ form.frequency.label }}
              {% if form.frequency.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.frequency|add_class:"form-control" }}
            {% for error in form.frequency.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="col-12 col-md-4 mb-3">
            <label for="{{ form.duration.id_for_label }}" class="form-label fw-medium">
              {{ form.duration.label }}
              {% if form.duration.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.duration|add_class:"form-control" }}
            {% for error in form.duration.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="col-12 col-md-4 mb-3">
            <label for="{{ form.route.id_for_label }}" class="form-label fw-medium">
              {{ form.route.label }}
              {% if form.route.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.route|add_class:"form-control" }}
            {% for error in form.route.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>

          {# Row 4: Статус и Примечания #}
          <div class="col-12 col-md-6 mb-3">
            <label for="{{ form.status.id_for_label }}" class="form-label fw-medium">
              {{ form.status.label }}
              {% if form.status.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.status|add_class:"form-select" }}
            {% for error in form.status.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="col-12 col-md-6 mb-3">
            <label for="{{ form.notes.id_for_label }}" class="form-label fw-medium">
              {{ form.notes.label }}
              {% if form.notes.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.notes|add_class:"form-control"|attr:"rows:3" }}
            {% for error in form.notes.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>

          {# Row 5: Назначивший врач #}
          <div class="col-12 col-md-6 mb-3">
            <label for="{{ form.assigning_doctor.id_for_label }}" class="form-label fw-medium">
              {{ form.assigning_doctor.label }}
              {% if form.assigning_doctor.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.assigning_doctor|add_class:"form-select" }}
            {% for error in form.assigning_doctor.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        <div>
          <div class="d-flex justify-content-between">
            <a href="{{ next_url }}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-1"></i> Отмена
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-circle me-1"></i> Сохранить
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

{{ form.media }}

<script>
  $(document).ready(function() {
    const medicationSelect = $('#id_medication');
    const patientWeightInput = $('#id_patient_weight');
    const dosagePerKgInput = $('#id_dosage_per_kg');
    const frequencyInput = $('#id_frequency');
    const durationInput = $('#id_duration');
    const routeInput = $('#id_route');
    const calculatedDosageInput = $('#id_calculated_dosage');

    const defaultDosagePerKgUnitDisplay = $('#id_default_dosage_per_kg_unit_display');

    let currentMedicationData = null; // Для хранения данных о текущем препарате

    // Функция для расчета и обновления calculatedDosageInput
    function calculateDosage() {
      const patientWeight = parseFloat(patientWeightInput.val());
      const dosagePerKg = parseFloat(dosagePerKgInput.val());
      let calculatedDosageValue = '';

      if (dosagePerKg && patientWeight) {
        const calculated = dosagePerKg * patientWeight;
        calculatedDosageValue = `${calculated.toFixed(2)} ${currentMedicationData ? (currentMedicationData.default_dosage_per_kg_unit || '') : ''}`;
      } else if (currentMedicationData && currentMedicationData.default_dosage) {
        calculatedDosageValue = currentMedicationData.default_dosage;
      }
      calculatedDosageInput.val(calculatedDosageValue);
    }

    // Функция для получения данных о препарате и предварительного заполнения полей
    function fetchAndApplyMedicationData() {
      const medicationId = medicationSelect.val();

      if (medicationId) {
        $.ajax({
          url: `/pharmacy/api/medications/${medicationId}/`,
          method: 'GET',
          success: function(data) {
            currentMedicationData = data; // Сохраняем данные

            // Предварительно заполняем dosage_per_kg ТОЛЬКО если оно пустое
            if (!dosagePerKgInput.val()) {
              dosagePerKgInput.val(data.default_dosage_per_kg || '');
            }

            // Предварительно заполняем другие поля, если они пусты
            if (!frequencyInput.val()) {
              frequencyInput.val(data.default_frequency_hours_options || data.default_frequency || '');
            }
            if (!durationInput.val()) {
              durationInput.val(data.default_duration || '');
            }
            if (!routeInput.val()) {
              routeInput.val(data.default_route || '');
            }
            defaultDosagePerKgUnitDisplay.val(data.default_dosage_per_kg_unit || '');

            calculateDosage(); // Пересчитываем после предварительного заполнения
          },
          error: function(error) {
            console.error('Error fetching medication data:', error);
            currentMedicationData = null;
            clearFormFields(); // Очищаем поля при ошибке
          }
        });
      } else {
        clearFormFields();
        currentMedicationData = null;
      }
    }

    function clearFormFields() {
      frequencyInput.val('');
      durationInput.val('');
      routeInput.val('');
      calculatedDosageInput.val('');
      dosagePerKgInput.val('');
      defaultDosagePerKgUnitDisplay.val('');
    }

    // Слушатели событий
    medicationSelect.on('change', fetchAndApplyMedicationData);
    patientWeightInput.on('input', calculateDosage);
    dosagePerKgInput.on('input', calculateDosage); // Включаем этот слушатель обратно

    // Инициализация при загрузке страницы
    if (medicationSelect.val()) {
      fetchAndApplyMedicationData();
    }
  });
</script>
{% endblock %}