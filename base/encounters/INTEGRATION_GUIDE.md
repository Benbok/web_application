# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

## üìã –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å

### ‚ùå –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
**–ù–ï –¢–†–ï–ë–£–Æ–¢–°–Ø** - –º—ã –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–æ–¥–µ–ª–∏ `Encounter`

### ‚ùå –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–¥–µ–ª—è—Ö
**–ù–ï –¢–†–ï–ë–£–Æ–¢–°–Ø** - –≤—Å–µ –Ω–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ–≤–µ—Ä—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

## ‚úÖ –ß—Ç–æ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å

### 1. **–§–æ—Ä–º—ã (forms.py)** - ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û
- ‚úÖ `EncounterCloseForm` - –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å Strategy Pattern –∏ Command Pattern
- ‚úÖ `EncounterReopenForm` - –Ω–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å–ª—É—á–∞–µ–≤
- ‚úÖ `EncounterUndoForm` - –Ω–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ö–æ–¥–æ–≤ —á–µ—Ä–µ–∑ Strategy Pattern
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### 2. **–ê–¥–º–∏–Ω–∫–∞ (admin.py)** - ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û
- ‚úÖ –ù–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: `reopen_selected`
- ‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–µ URL –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏ –æ—Ç–º–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–∞–Ω–¥ –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–µ—Ä–≤–∏—Å–∞–º–∏

### 3. **–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (views.py)** - ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û
- ‚úÖ `EncounterDetailView` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π
- ‚úÖ `EncounterCloseView` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Command Pattern
- ‚úÖ `EncounterReopenView` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Ä–≤–∏—Å
- ‚úÖ `EncounterUndoView` - –Ω–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–π

### 4. **–®–∞–±–ª–æ–Ω—ã –∞–¥–º–∏–Ω–∫–∏** - ‚úÖ –°–û–ó–î–ê–ù–´
- ‚úÖ `reopen_form.html` - —Ñ–æ—Ä–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å–ª—É—á–∞—è
- ‚úÖ `undo_form.html` - —Ñ–æ—Ä–º–∞ –æ—Ç–º–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### 1. **URLs (urls.py)**
–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ URL –¥–ª—è –æ—Ç–º–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–π:

```python
# encounters/urls.py
from django.urls import path
from . import views

urlpatterns = [
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ URL ...
    path('<int:pk>/undo/', views.EncounterUndoView.as_view(), name='encounter_undo'),
]
```

### 2. **–®–∞–±–ª–æ–Ω—ã (templates)**
–û–±–Ω–æ–≤–∏—Ç–µ —à–∞–±–ª–æ–Ω –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π:

```html
<!-- encounters/detail.html -->
{% if encounter.is_active %}
    <a href="{% url 'encounters:encounter_close' encounter.pk %}" class="btn btn-warning">
        –ó–∞–∫—Ä—ã—Ç—å —Å–ª—É—á–∞–π
    </a>
{% else %}
    <form method="post" action="{% url 'encounters:encounter_reopen' encounter.pk %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-success">–í–æ–∑–≤—Ä–∞—Ç–∏—Ç—å –≤ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
    </form>
    
    <form method="post" action="{% url 'encounters:encounter_undo' encounter.pk %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-info">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –æ–ø–µ—Ä–∞—Ü–∏—é</button>
    </form>
{% endif %}

<!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–∞–Ω–¥ -->
{% if command_history %}
<div class="card mt-3">
    <div class="card-header">
        <h5>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h5>
    </div>
    <div class="card-body">
        {% for command in command_history %}
        <div class="mb-2">
            <small class="text-muted">{{ command.executed_at|date:"d.m.Y H:i" }}</small>
            <span class="badge {% if command.execution_successful %}bg-success{% else %}bg-danger{% endif %}">
                {{ command.description }}
            </span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
```

### 3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (settings.py)**
–î–æ–±–∞–≤—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–µ—Ç—Ä–∏–∫:

```python
# settings.py

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è encounters
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'encounter_file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': 'logs/encounters.log',
        },
    },
    'loggers': {
        'encounters': {
            'handlers': ['encounter_file'],
            'level': 'INFO',
            'propagate': True,
        },
    },
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–µ—Ç—Ä–∏–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
ENCOUNTER_METRICS = {
    'ENABLED': True,
    'CACHE_TIMEOUT': 300,  # 5 –º–∏–Ω—É—Ç
    'AUDIT_FILE': 'logs/encounter_audit.log',
}
```

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**
- ‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏
- ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞

### 2. **–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**
- ‚úÖ –û—Ç–º–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–π (undo/redo)
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–∞–Ω–¥
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫
- ‚úÖ –ê—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π

### 3. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞**
- ‚úÖ –ù–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Å–ø–∏—Å–∫–µ
- ‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ñ–æ—Ä–º—ã
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–∞–Ω–¥–∞—Ö

## üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º—ã**
```python
# –¢–µ—Å—Ç —Ñ–æ—Ä–º—ã –∑–∞–∫—Ä—ã—Ç–∏—è
form = EncounterCloseForm(encounter)
assert form.is_valid()

# –¢–µ—Å—Ç —Ñ–æ—Ä–º—ã –≤–æ–∑–≤—Ä–∞—Ç–∞
form = EncounterReopenForm(encounter)
assert form.is_valid()
```

### 2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–∏—Å—ã**
```python
# –¢–µ—Å—Ç —Å–µ—Ä–≤–∏—Å–∞
service = EncounterService(encounter)
details = service.get_encounter_details()
assert 'encounter_number' in details
```

### 3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–º–∞–Ω–¥—ã**
```python
# –¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥
command = CommandFactory.create_close_command(encounter, 'consultation_end')
success = command_invoker.execute_command(command)
assert success
```

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é

### 1. **–ü–æ—ç—Ç–∞–ø–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ**
1. –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–∏—Ç–µ —Ñ–æ—Ä–º—ã –∏ –∞–¥–º–∏–Ω–∫—É
2. –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
3. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ URL
4. –û–±–Ω–æ–≤–∏—Ç–µ —à–∞–±–ª–æ–Ω—ã

### 2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
3. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

### 3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
1. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏
2. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏
3. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:

1. **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** —Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
2. **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–π** —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∫–æ–º–∞–Ω–¥
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –∏ –º–µ—Ç—Ä–∏–∫–∏
4. **–£–ª—É—á—à–µ–Ω–Ω—É—é –∞–¥–º–∏–Ω–∫—É** —Å –Ω–æ–≤—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏
5. **–û–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è **–Ω–µ —Ç—Ä–µ–±—É—é—Ç –º–∏–≥—Ä–∞—Ü–∏–π** –∏ **–æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã**! 