# Модуль Encounters - Документация функционала

## Обзор модуля

Модуль `encounters` отвечает за управление случаями обращения пациентов в медицинской системе. Реализует жизненный цикл обращения от создания до завершения, включая переводы в отделения и интеграцию с системой документов и назначений.

## Модели (Models)

### Encounter
**Назначение**: Модель случая обращения пациента
**Основные поля**:
- `outcome` - Исход обращения (consultation_end, transferred)
- `transfer_to_department` - Связь с отделением при переводе
- `documents` - GenericRelation для клинических документов
- `patient` - Связь с пациентом
- `doctor` - Связь с врачом
- `date_start` - Дата начала обращения
- `date_end` - Дата завершения обращения
- `is_active` - Статус активности случая

**Исходы обращения**:
- `consultation_end` - Консультация (завершение без перевода)
- `transferred` - Перевод в отделение

**Методы**:
- `close_encounter(outcome, transfer_department)` - Закрытие случая обращения
- `reopen_encounter()` - Возврат случая в активное состояние
- `clean()` - Валидация дат
- `save()` - Автоматическое управление статусом активности
- `archive()` - Архивирование с синхронизацией связанных объектов
- `unarchive()` - Восстановление из архива

**Функционал**:
- Управление жизненным циклом обращения
- Интеграция с системой документов
- Автоматическое создание записей в отделениях при переводе
- Синхронизация с записями на прием (appointments)
- Система архивирования

## Представления (Views)

### EncounterDetailView
**Назначение**: Детальный просмотр случая обращения
**Функционал**:
- Отображение всех документов случая
- Вычисление номера обращения для пациента
- Предоставление контекста для шаблона

### EncounterCreateView
**Назначение**: Создание нового случая обращения
**Функционал**:
- Автоматическое заполнение пациента и врача
- Валидация данных формы
- Перенаправление к деталям созданного случая

**Логика**:
- Получение пациента из URL параметров
- Автоматическое назначение текущего пользователя как врача
- Сохранение случая с привязкой к пациенту

### EncounterUpdateView
**Назначение**: Редактирование случая обращения
**Функционал**:
- Обновление всех полей случая
- Автоматическое управление датой завершения
- Проверка наличия документов при закрытии
- Управление переводами в отделения

**Логика**:
- Валидация наличия документов при закрытии
- Автоматическое управление датой завершения
- Создание/отмена записей в отделениях при изменении перевода
- Синхронизация с системой отделений

### EncounterDeleteView
**Назначение**: Удаление случая обращения
**Функционал**:
- Подтверждение удаления
- Вычисление номера обращения для отображения
- Перенаправление к деталям пациента

### EncounterCloseView
**Назначение**: Закрытие случая обращения
**Функционал**:
- Закрытие только активных случаев
- Создание записей в отделениях при переводе
- Валидация наличия документов
- Управление исходами обращения

**Логика**:
- Проверка активности случая
- Валидация наличия документов
- Создание PatientDepartmentStatus при переводе
- Вызов метода close_encounter()

### EncounterReopenView
**Назначение**: Возврат случая обращения в активное состояние
**Функционал**:
- Активация закрытых случаев
- Отмена переводов в отделения
- Синхронизация с записями на прием

**Логика**:
- Проверка активности случая
- Вызов метода reopen_encounter()
- Отмена связанных записей в отделениях

## Формы (Forms)

### EncounterForm
**Назначение**: Форма создания случая обращения
**Поля**: date_start
**Виджеты**: DateTimeInput с типом datetime-local
**Функционал**: Базовая форма для создания нового случая

### EncounterUpdateForm
**Назначение**: Форма редактирования случая обращения
**Поля**: date_start, date_end, outcome, transfer_to_department
**Валидация**:
- Проверка соответствия исхода и отделения перевода
- Валидация логики перевода
**Функционал**: Полное редактирование случая с управлением переводами

### EncounterCloseForm
**Назначение**: Форма закрытия случая обращения
**Поля**: outcome, transfer_to_department
**Валидация**:
- Проверка наличия документов перед закрытием
- Валидация логики перевода
- Исключение отделения "admission" из списка переводов
**Функционал**: Специализированная форма для закрытия случая

## Админ-панель (Admin)

### EncounterAdmin
**Назначение**: Администрирование случаев обращения
**Функционал**:
- Отображение основных полей случая
- Фильтрация по активности, архиву, дате начала
- Поиск по данным пациента
- Действия массового архивирования/восстановления
- Работа с архивированными записями

## Интеграции

### С системой Documents
- GenericRelation для клинических документов
- Валидация наличия документов при закрытии
- Отображение документов в деталях случая

### С системой Departments
- Автоматическое создание PatientDepartmentStatus при переводе
- Отмена переводов при возврате случая в активное состояние
- Синхронизация статусов отделений

### С системой Appointments
- Синхронизация статусов записей на прием
- Автоматическое обновление статуса при закрытии/открытии случая
- Связь через OneToOneField

### С системой Patients
- Связь случаев обращения с пациентами
- Вычисление номера обращения для пациента
- Отслеживание истории обращений

## Архитектурные особенности

1. **Lifecycle Management**: Управление жизненным циклом обращения
2. **State Synchronization**: Синхронизация статусов между связанными объектами
3. **Document Validation**: Валидация наличия документов при закрытии
4. **Transfer Management**: Автоматическое управление переводами в отделения
5. **Archive Integration**: Интеграция с системой архивирования

## Бизнес-логика

### Жизненный цикл случая обращения:
1. **Создание** - создание нового случая обращения
2. **Активное состояние** - ведение документов и назначений
3. **Закрытие** - завершение с указанием исхода
4. **Перевод** - создание записи в отделении (опционально)
5. **Возврат** - возврат в активное состояние (опционально)

### Валидации:
- Проверка наличия документов при закрытии
- Валидация дат (дата завершения не может быть раньше начала)
- Проверка логики переводов (отделение только при переводе)
- Исключение отделения "admission" из переводов

### Автоматические действия:
- Создание PatientDepartmentStatus при переводе
- Отмена переводов при возврате случая
- Синхронизация статусов записей на прием
- Архивирование связанных объектов

### Интеграции с другими модулями:
- **Documents** → клиническая документация
- **Departments** → переводы в отделения
- **Appointments** → записи на прием
- **Patients** → управление пациентами

## Примеры использования

### Создание случая обращения:
```python
encounter = Encounter.objects.create(
    patient=patient,
    doctor=user,
    date_start=timezone.now()
)
```

### Закрытие случая с переводом:
```python
if encounter.close_encounter('transferred', cardiology_department):
    # Автоматически создается PatientDepartmentStatus
    print("Случай закрыт и пациент переведен")
```

### Возврат случая в активное состояние:
```python
if encounter.reopen_encounter():
    # Автоматически отменяется перевод в отделение
    print("Случай возвращен в активное состояние")
```

### Архивирование случая:
```python
encounter.archive()  # Также архивирует связанные объекты
```

### Получение документов случая:
```python
documents = encounter.documents.all()
```

### Проверка активности:
```python
if encounter.is_active:
    print("Случай активен")
else:
    print("Случай закрыт")
```

## Статусы и состояния

### Активность случая:
- `is_active = True` - случай активен, можно добавлять документы
- `is_active = False` - случай закрыт, документы только для чтения

### Исходы обращения:
- `consultation_end` - завершение консультации без перевода
- `transferred` - перевод в отделение

### Автоматические действия:
- При установке `outcome` и `date_end` → `is_active = False`
- При очистке `outcome` и `date_end` → `is_active = True`
- При переводе → создание `PatientDepartmentStatus`
- При возврате → отмена `PatientDepartmentStatus` 