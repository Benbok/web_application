# Интеграция Pharmacy в Encounters

## Обзор

Интеграция позволяет врачам просматривать схемы лечения и получать персонализированные рекомендации по препаратам прямо в процессе работы с обращениями пациентов.

## Что было добавлено

### 1. Модель Encounter
- Добавлено поле `diagnosis` - связь с моделью Diagnosis
- Поле необязательное (null=True, blank=True)

### 2. Формы
- **EncounterForm**: добавлено поле выбора диагноза
- **EncounterUpdateForm**: добавлено поле выбора диагноза
- Поле имеет ID `diagnosis-select` для JavaScript

### 3. Views (API endpoints)
- **TreatmentRegimensView**: AJAX endpoint для получения схем лечения по диагнозу
- **PatientRecommendationsView**: AJAX endpoint для персонализированных рекомендаций

### 4. URL маршруты
```python
path('api/treatment-regimens/', views.TreatmentRegimensView.as_view(), name='treatment_regimens'),
path('api/patient-recommendations/', views.PatientRecommendationsView.as_view(), name='patient_recommendations'),
```

### 5. JavaScript функционал
- **TreatmentRegimensManager**: класс для управления отображением схем лечения
- Динамическая загрузка данных через AJAX
- Отображение схем лечения и персонализированных рекомендаций

### 6. Шаблоны
- Обновлен `form.html` для encounters
- Добавлена секция "Схемы лечения"
- Подключен JavaScript файл

## Как это работает

### 1. Выбор диагноза
1. Врач выбирает диагноз в форме обращения
2. JavaScript автоматически загружает схемы лечения для выбранного диагноза
3. Отображаются все доступные схемы с инструкциями по дозированию

### 2. Персонализированные рекомендации
1. Если обращение уже создано, доступна кнопка "Показать персонализированные рекомендации"
2. Система учитывает возраст, вес и другие параметры пациента
3. Отображаются только подходящие схемы с учетом критериев пациента

### 3. API endpoints

#### GET /encounters/api/treatment-regimens/
**Параметры:**
- `diagnosis_id` (обязательный) - ID диагноза
- `encounter_id` (опциональный) - ID обращения для персонализации

**Ответ:**
```json
{
    "diagnosis": {
        "id": 1,
        "name": "Бактериальная пневмония",
        "code": "J15.9"
    },
    "regimens": [
        {
            "id": 1,
            "name": "Стандартная терапия",
            "medication_name": "Ампициллин",
            "notes": "Общие примечания",
            "dosing_instructions": [...]
        }
    ],
    "personalized_recommendations": {...}
}
```

#### GET /encounters/api/patient-recommendations/
**Параметры:**
- `encounter_id` (обязательный) - ID обращения
- `diagnosis_id` (опциональный) - ID диагноза для фильтрации

**Ответ:**
```json
{
    "patient": {
        "id": 1,
        "name": "Иванов Иван Иванович",
        "age_days": 10950
    },
    "recommendations": {
        "Ампициллин": [
            {
                "regimen_id": 1,
                "regimen_name": "Стандартная терапия",
                "suitable_criteria": [...],
                "dosing_instructions": [...],
                "adjustments": [...]
            }
        ]
    }
}
```

## Структура файлов

```
encounters/
├── models.py                    # Добавлено поле diagnosis
├── forms.py                     # Обновлены формы
├── views.py                     # Добавлены API views
├── urls.py                      # Добавлены API endpoints
├── static/
│   └── encounters/
│       └── js/
│           └── treatment_regimens.js  # JavaScript функционал
├── templates/
│   └── encounters/
│       └── form.html            # Обновлен шаблон
└── migrations/
    └── 0002_encounter_diagnosis.py  # Миграция
```

## Использование

### Для врачей:
1. Создайте или отредактируйте обращение пациента
2. Выберите диагноз в поле "Диагноз"
3. Просмотрите доступные схемы лечения
4. При необходимости нажмите "Показать персонализированные рекомендации"

### Для разработчиков:
1. API endpoints доступны для интеграции с другими частями системы
2. JavaScript класс можно расширить для дополнительного функционала
3. Схемы лечения автоматически обновляются при изменении данных в pharmacy

## Расширение функционала

### Добавление новых полей в рекомендации:
1. Обновите сервисы в `pharmacy.services`
2. Обновите JavaScript для отображения новых данных
3. Обновите API endpoints при необходимости

### Добавление фильтров:
1. Добавьте параметры в API endpoints
2. Обновите сервисы для обработки фильтров
3. Добавьте UI элементы для фильтрации

### Кэширование:
1. Добавьте кэширование в API endpoints
2. Используйте Django cache framework
3. Настройте TTL для кэшированных данных

## Безопасность

- API endpoints защищены CSRF токенами
- Проверка прав доступа к encounters
- Валидация входных данных
- Логирование запросов к API

## Производительность

- Оптимизированные запросы к БД через сервисы pharmacy
- AJAX загрузка данных без перезагрузки страницы
- Кэширование справочных данных
- Пагинация для больших списков (при необходимости) 