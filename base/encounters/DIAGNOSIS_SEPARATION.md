# Разделение создания случая и установки диагноза

## Описание изменений

Реализовано разделение процесса создания случая обращения и установки диагноза. Теперь:
1. Сначала создается случай обращения (только с датой начала)
2. Затем отдельно устанавливается диагноз
3. После этого можно создавать документы (дневник)

## Измененные файлы

### 1. `encounters/forms.py`
- **EncounterForm**: Убрано поле диагноза, оставлено только поле даты начала
- **EncounterUpdateForm**: Убрано поле диагноза из формы редактирования
- **EncounterDiagnosisForm**: Новая форма для установки диагноза

### 2. `encounters/views.py`
- **EncounterDiagnosisView**: Новое представление для установки диагноза
- Обновлены импорты для новой формы

### 3. `encounters/urls.py`
- Добавлен новый URL: `<int:pk>/diagnosis/` для установки диагноза

### 4. `encounters/templates/encounters/detail.html`
- Добавлено отображение диагноза в информации о случае
- Добавлена кнопка "Установить диагноз" / "Изменить диагноз"

### 5. `encounters/templates/encounters/form.html`
- Убрана секция схем лечения (теперь доступна только при установке диагноза)

### 6. `encounters/templates/encounters/diagnosis_form.html`
- Новый шаблон для формы установки диагноза
- Включает секцию схем лечения
- Показывает информацию о случае

## Новый процесс работы

### 1. Создание случая
```
Пациент → Создать обращение → Заполнить дату → Сохранить
```

### 2. Установка диагноза
```
Случай → Установить диагноз → Выбрать диагноз → Сохранить
```

### 3. Создание документов
```
Случай → Добавить документ → Создать дневник
```

## Функциональность

### Форма создания случая
- Только поле даты начала (автоматически заполняется текущей датой)
- Простая и быстрая форма
- Нет отвлечения на выбор диагноза

### Форма установки диагноза
- Выбор диагноза с поиском
- Отображение схем лечения для выбранного диагноза
- Информация о текущем состоянии случая
- Возможность изменения диагноза

### Детальная страница случая
- Отображение диагноза (или "Не установлен")
- Кнопка для установки/изменения диагноза
- Четкое разделение этапов работы

## Преимущества нового подхода

1. **Упрощение создания случая**: Меньше полей, быстрее создание
2. **Гибкость**: Диагноз можно установить позже, когда будет готов
3. **Лучшая организация**: Четкое разделение этапов работы
4. **Удобство**: Схемы лечения доступны только при установке диагноза
5. **Точность**: Диагноз устанавливается осознанно, а не "на скорую руку"

## Тестирование

Создан тест `test_diagnosis_separation.py`, который проверяет:
- Создание случая без диагноза
- Отсутствие поля диагноза в форме создания
- Наличие поля диагноза в форме диагноза
- Успешную установку диагноза

### Результат тестирования:
```
=== ТЕСТ РАЗДЕЛЕНИЯ СОЗДАНИЯ СЛУЧАЯ И УСТАНОВКИ ДИАГНОЗА ===

1. Создание случая без диагноза:
   Случай создан с ID: 68
   Диагноз: None
   Дата начала: 2025-08-03 19:00:33.832918+00:00
   ✅ Случай создан без диагноза

2. Тестирование формы создания случая:
   Поля в форме: ['date_start']
   ✅ Поле диагноза отсутствует в форме создания

3. Тестирование формы установки диагноза:
   Поля в форме диагноза: ['diagnosis']
   ✅ Поле диагноза присутствует в форме диагноза

4. Тестирование установки диагноза:
   Диагноз установлен: J03.9 - Острый тонзиллит неуточненный
   ✅ Диагноз успешно установлен

=== ТЕСТ ЗАВЕРШЕН УСПЕШНО ===
```

## Использование

### Для врачей:
1. **Создание случая**: Быстро создайте случай, указав только дату
2. **Установка диагноза**: Перейдите к случаю и установите диагноз
3. **Создание документов**: После установки диагноза создавайте дневник

### Для администраторов:
- Процесс стал более структурированным
- Легче отслеживать этапы работы
- Меньше ошибок при создании случаев

## URL-маршруты

- `/encounters/add/<patient_pk>/` - Создание случая
- `/encounters/<pk>/diagnosis/` - Установка диагноза
- `/encounters/<pk>/edit/` - Редактирование случая
- `/encounters/<pk>/` - Детальная страница случая 