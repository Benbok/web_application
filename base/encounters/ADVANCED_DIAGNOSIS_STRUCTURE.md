# Расширенная структура диагнозов и лечения

## Описание изменений

Реализована расширенная структура для работы с диагнозами и планами лечения в случаях обращения. Теперь система поддерживает:

1. **Сложную структуру диагнозов**:
   - Основной диагноз (один)
   - Осложнения (несколько)
   - Сопутствующие диагнозы (несколько)

2. **Гибкие планы лечения**:
   - Создание планов лечения
   - Добавление лекарств из справочника или собственных
   - Детальная настройка дозировки и режима приема

## Новые модели

### 1. `EncounterDiagnosis`
Модель для хранения диагнозов случая обращения:

```python
class EncounterDiagnosis(models.Model):
    DIAGNOSIS_TYPE_CHOICES = [
        ('main', 'Основной диагноз'),
        ('complication', 'Осложнение'),
        ('comorbidity', 'Сопутствующий диагноз'),
    ]
    
    encounter = models.ForeignKey('Encounter', ...)
    diagnosis_type = models.CharField(choices=DIAGNOSIS_TYPE_CHOICES)
    diagnosis = models.ForeignKey('diagnosis.Diagnosis', ...)  # Из справочника
    custom_diagnosis = models.TextField()  # Собственный диагноз
    description = models.TextField()  # Дополнительное описание
```

### 2. `TreatmentPlan`
Модель для планов лечения:

```python
class TreatmentPlan(models.Model):
    encounter = models.ForeignKey('Encounter', ...)
    name = models.CharField()  # Название плана
    description = models.TextField()  # Описание
    is_active = models.BooleanField(default=True)
```

### 3. `TreatmentMedication`
Модель для лекарств в плане лечения:

```python
class TreatmentMedication(models.Model):
    ROUTE_CHOICES = [
        ('oral', 'Перорально'),
        ('intravenous', 'Внутривенно'),
        ('intramuscular', 'Внутримышечно'),
        # ... и другие
    ]
    
    treatment_plan = models.ForeignKey(TreatmentPlan, ...)
    medication = models.ForeignKey('pharmacy.Medication', ...)  # Из справочника
    custom_medication = models.CharField()  # Собственный препарат
    dosage = models.CharField()  # Дозировка
    frequency = models.CharField()  # Частота приема
    route = models.CharField(choices=ROUTE_CHOICES)  # Способ применения
    duration = models.CharField()  # Длительность курса
    instructions = models.TextField()  # Особые указания
```

## Измененные файлы

### 1. `encounters/models.py`
- Добавлены новые модели: `EncounterDiagnosis`, `TreatmentPlan`, `TreatmentMedication`
- Обновлена модель `Encounter` с методами для работы с диагнозами и лечением
- Поле `diagnosis` в `Encounter` помечено как устаревшее

### 2. `encounters/forms.py`
- `EncounterDiagnosisAdvancedForm`: Форма для работы с расширенной структурой диагнозов
- `TreatmentPlanForm`: Форма для создания/редактирования планов лечения
- `TreatmentMedicationForm`: Форма для добавления лекарств в план лечения

### 3. `encounters/views.py`
- `EncounterDiagnosisAdvancedView`: Управление диагнозами
- `EncounterDiagnosisCreateView`: Создание диагноза
- `EncounterDiagnosisUpdateView`: Редактирование диагноза
- `EncounterDiagnosisDeleteView`: Удаление диагноза
- `TreatmentPlanListView`: Список планов лечения
- `TreatmentPlanCreateView`: Создание плана лечения
- `TreatmentPlanDetailView`: Детальный просмотр плана лечения
- `TreatmentMedicationCreateView`: Добавление лекарства

### 4. `encounters/urls.py`
Добавлены новые URL-маршруты:
- `/encounters/<pk>/diagnoses/` - Управление диагнозами
- `/encounters/<encounter_pk>/diagnoses/add/` - Добавление диагноза
- `/encounters/<encounter_pk>/treatment-plans/` - Планы лечения
- `/encounters/<encounter_pk>/treatment-plans/add/` - Создание плана лечения

### 5. `encounters/templates/encounters/diagnosis_advanced.html`
Новый шаблон для управления диагнозами с разделением по типам.

## Функциональность

### Управление диагнозами

#### 1. Основной диагноз
- Только один основной диагноз на случай
- Можно выбрать из справочника или ввести собственный
- При добавлении нового основного диагноза старый удаляется

#### 2. Осложнения
- Можно добавить несколько осложнений
- Каждое осложнение может быть из справочника или собственным
- Отображаются с иконкой предупреждения

#### 3. Сопутствующие диагнозы
- Можно добавить несколько сопутствующих диагнозов
- Каждый диагноз может быть из справочника или собственным
- Отображаются с иконкой списка

### Планы лечения

#### 1. Создание плана лечения
- Название плана (например: "Основная терапия", "Симптоматическое лечение")
- Описание плана
- Автоматическая привязка к случаю обращения

#### 2. Добавление лекарств
- Выбор из справочника препаратов или ввод собственного
- Настройка дозировки и частоты приема
- Выбор способа применения (перорально, внутривенно, etc.)
- Указание длительности курса
- Дополнительные инструкции

#### 3. Валидация
- Нельзя одновременно выбрать препарат из справочника и ввести собственный
- Нельзя создать диагноз без указания диагноза или собственного диагноза

## Методы модели Encounter

```python
# Работа с диагнозами
encounter.get_main_diagnosis()  # Возвращает основной диагноз
encounter.get_complications()    # Возвращает осложнения
encounter.get_comorbidities()    # Возвращает сопутствующие диагнозы
encounter.add_diagnosis(...)     # Добавляет диагноз

# Работа с лечением
encounter.get_active_treatment_plan()  # Возвращает активный план лечения
encounter.create_treatment_plan(...)   # Создает новый план лечения
```

## Интерфейс

### Детальная страница случая
- Отображение диагнозов с цветными бейджами
- Кнопка "Управление диагнозами" / "Добавить диагнозы"
- Кнопка "Планы лечения" с количеством активных планов

### Страница управления диагнозами
- Разделение по типам диагнозов
- Возможность добавления, редактирования, удаления
- Цветовое кодирование (основной - синий, осложнения - желтый, сопутствующие - голубой)

## Преимущества новой структуры

1. **Гибкость**: Поддержка как справочных, так и собственных диагнозов/лекарств
2. **Структурированность**: Четкое разделение типов диагнозов
3. **Детализация**: Возможность указать дозировку, частоту, способ применения
4. **Валидация**: Защита от некорректных данных
5. **Удобство**: Интуитивный интерфейс с цветовым кодированием

## Тестирование

Создан тест `test_advanced_diagnosis.py`, который проверяет:
- Создание случаев обращения
- Добавление диагнозов разных типов
- Создание планов лечения
- Валидацию данных

### Результат тестирования:
```
=== ТЕСТ РАСШИРЕННОЙ СТРУКТУРЫ ДИАГНОЗОВ И ЛЕЧЕНИЯ ===

1. Создание случая обращения:
   Случай создан с ID: 71

2. Тестирование добавления диагнозов:
   Основной диагноз добавлен: Основной диагноз: J03.9 - Острый тонзиллит неуточненный
   Осложнение добавлено: Осложнение: J03.0 - Стрептококковый тонзиллит
   Сопутствующий диагноз добавлен: Сопутствующий диагноз: Сахарный диабет 2 типа

3. Тестирование методов получения диагнозов:
   Основной диагноз: Основной диагноз: J03.9 - Острый тонзиллит неуточненный
   Осложнения: [<EncounterDiagnosis: Осложнение: J03.0 - Стрептококковый тонзиллит>]
   Сопутствующие диагнозы: [<EncounterDiagnosis: Сопутствующий диагноз: Сахарный диабет 2 типа>]

4. Тестирование создания плана лечения:
   План лечения создан: Основная терапия - Случай от 03.08.2025 — Пациент Тест
   Активный план лечения: Основная терапия - Случай от 03.08.2025 — Пациент Тест
```

## Использование

### Для врачей:
1. **Создание случая** → Быстрое создание с автоматической датой
2. **Добавление диагнозов** → Структурированное добавление основного, осложнений, сопутствующих
3. **Создание плана лечения** → Детальная настройка лекарств с дозировкой и режимом приема
4. **Создание документов** → Дневник с полной информацией о диагнозах и лечении

### Для администраторов:
- Более структурированный процесс работы
- Лучший контроль качества данных
- Возможность аналитики по диагнозам и лечению 