{% extends "patients/base.html" %}
{% load widget_tweaks %}
{% load static %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li{% if message.tags == "error" %} class="alert alert-danger"{% elif message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<div class="card mt-4">
    <div class="card-header">
        <h4 class="card-title mb-0">{{ title }}</h4>
        <small class="text-muted">–ü–∞—Ü–∏–µ–Ω—Ç: {{ patient.full_name }} | –ü–ª–∞–Ω: {{ treatment_plan.name }}</small>
    </div>
    <div class="card-body">
        <form method="post" novalidate>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.medication.id_for_label }}" class="form-label">{{ form.medication.label }}</label>
                        {{ form.medication|add_class:"form-select" }}
                        {% if form.medication.help_text %}
                            <div class="form-text">{{ form.medication.help_text }}</div>
                        {% endif %}
                        {% for error in form.medication.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.custom_medication.id_for_label }}" class="form-label">{{ form.custom_medication.label }}</label>
                        {{ form.custom_medication|add_class:"form-control" }}
                        {% if form.custom_medication.help_text %}
                            <div class="form-text">{{ form.custom_medication.help_text }}</div>
                        {% endif %}
                        {% for error in form.custom_medication.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- –í—ã–±–æ—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ä–º –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ -->
            <div class="mb-3" id="available-forms-container" style="display: none;">
                <label class="form-label">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º—ã –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:</label>
                <div id="available-forms-content">
                    <div class="row" id="forms-grid">
                        <!-- –§–æ—Ä–º—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    <small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ–∑–∏—Ä–æ–≤–∫–µ</small>
                </div>
            </div>
            
            <!-- –ü–æ–ª–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
            <div class="mb-3" id="external-link-container" style="display: none;">
                <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ:</label>
                <div id="external-link-content">
                    <div class="d-flex align-items-center gap-2">
                        <a href="#" id="external-link" target="_blank" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-external-link-alt"></i> –û—Ç–∫—Ä—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ
                        </a>
                        <small class="text-muted" id="medication-info-text"></small>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.dosage.id_for_label }}" class="form-label">{{ form.dosage.label }}</label>
                        {{ form.dosage|add_class:"form-control" }}
                        {% if form.dosage.help_text %}
                            <div class="form-text">{{ form.dosage.help_text }}</div>
                        {% endif %}
                        {% for error in form.dosage.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.frequency.id_for_label }}" class="form-label">{{ form.frequency.label }}</label>
                        {{ form.frequency|add_class:"form-control" }}
                        {% if form.frequency.help_text %}
                            <div class="form-text">{{ form.frequency.help_text }}</div>
                        {% endif %}
                        {% for error in form.frequency.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.route.id_for_label }}" class="form-label">{{ form.route.label }}</label>
                        {{ form.route|add_class:"form-select" }}
                        {% if form.route.help_text %}
                            <div class="form-text">{{ form.route.help_text }}</div>
                        {% endif %}
                        {% for error in form.route.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.duration.id_for_label }}" class="form-label">{{ form.duration.label }}</label>
                        {{ form.duration|add_class:"form-control" }}
                        {% if form.duration.help_text %}
                            <div class="form-text">{{ form.duration.help_text }}</div>
                        {% endif %}
                        {% for error in form.duration.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.instructions.id_for_label }}" class="form-label">{{ form.instructions.label }}</label>
                {{ form.instructions|add_class:"form-control" }}
                {% if form.instructions.help_text %}
                    <div class="form-text">{{ form.instructions.help_text }}</div>
                {% endif %}
                {% for error in form.instructions.errors %}
                    <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> –î–æ–±–∞–≤–∏—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–æ
                </button>
                <a href="{% url 'encounters:treatment_plan_detail' treatment_plan.pk %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                </a>
            </div>
        </form>
    </div>
</div>

<script>
console.log('üöÄ –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω!');
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    console.log('–ü–∞—Ü–∏–µ–Ω—Ç –≤ —à–∞–±–ª–æ–Ω–µ:', '{{ patient }}');
    console.log('ID –ø–∞—Ü–∏–µ–Ω—Ç–∞ –≤ —à–∞–±–ª–æ–Ω–µ:', '{{ patient.id }}');
    console.log('–ü–∞—Ü–∏–µ–Ω—Ç full_name:', '{{ patient.full_name }}');
    
    const medicationField = document.getElementById('{{ form.medication.id_for_label }}');
    const customMedicationField = document.getElementById('{{ form.custom_medication.id_for_label }}');
    const dosageField = document.getElementById('{{ form.dosage.id_for_label }}');
    const frequencyField = document.getElementById('{{ form.frequency.id_for_label }}');
    const routeField = document.getElementById('{{ form.route.id_for_label }}');
    const durationField = document.getElementById('{{ form.duration.id_for_label }}');
    const instructionsField = document.getElementById('{{ form.instructions.id_for_label }}');
    const externalLinkContainer = document.getElementById('external-link-container');
    const externalLink = document.getElementById('external-link');
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π –¥–æ–∑–∏—Ä–æ–≤–∫–∏
    async function loadMedicationInfo(medicationId) {
        console.log('üîç loadMedicationInfo –≤—ã–∑–≤–∞–Ω–∞ —Å ID:', medicationId);
        
        if (!medicationId) {
            console.log('‚ùå ID –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –æ—á–∏—â–∞–µ–º –ø–æ–ª—è');
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –µ—Å–ª–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω
            if (dosageField) dosageField.value = '';
            if (frequencyField) frequencyField.value = '';
            if (routeField) routeField.value = 'oral';
            if (durationField) durationField.value = '';
            if (instructionsField) instructionsField.value = '';
            // –°–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫
            if (externalLinkContainer) externalLinkContainer.style.display = 'none';
            return;
        }
        
        try {
            // –ü–µ—Ä–µ–¥–∞–µ–º ID –ø–∞—Ü–∏–µ–Ω—Ç–∞ –¥–ª—è —É—á–µ—Ç–∞ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã
            const patientId = {{ patient.id }};
            const url = `{% url 'encounters:medication_info' 0 %}`.replace('0', medicationId) + `?patient_id=${patientId}`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            console.log('üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å:', url);
            console.log('üë§ ID –ø–∞—Ü–∏–µ–Ω—Ç–∞:', patientId);
            console.log('üíä ID –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:', medicationId);
            
            const response = await fetch(url);
            console.log('üì° –ü–æ–ª—É—á–µ–Ω HTTP –æ—Ç–≤–µ—Ç:', response.status, response.statusText);
            
            const data = await response.json();
            console.log('üì¶ –ü–æ–ª—É—á–µ–Ω JSON –æ—Ç–≤–µ—Ç:', data);
            
            if (data.success && data.medication) {
                const med = data.medication;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                if (dosageField && med.dosage) dosageField.value = med.dosage;
                if (frequencyField && med.frequency) frequencyField.value = med.frequency;
                if (routeField && med.route) routeField.value = med.route;
                if (durationField && med.duration) durationField.value = med.duration;
                if (instructionsField && med.instructions) instructionsField.value = med.instructions;
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ
                console.log('üîó –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É...');
                console.log('üì¶ –î–∞–Ω–Ω—ã–µ –æ –≤–Ω–µ—à–Ω–µ–π —Å—Å—ã–ª–∫–µ:', {
                    external_url: med.external_url,
                    trade_name: med.trade_name,
                    generic_concept: med.generic_concept,
                    medication_form: med.medication_form
                });
                
                if (externalLinkContainer && externalLink) {
                    console.log('‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —Å—Å—ã–ª–∫–∞ –Ω–∞–π–¥–µ–Ω—ã');
                    const medicationInfoText = document.getElementById('medication-info-text');
                    console.log('üìù –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–∞:', medicationInfoText);
                    
                    if (med.external_url) {
                        console.log('üîó –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É:', med.external_url);
                        externalLink.href = med.external_url;
                        externalLinkContainer.style.display = 'block';
                        console.log('‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–∫–∞–∑–∞–Ω');
                        
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ
                        let infoText = '';
                        if (med.trade_name) {
                            infoText += `–¢–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: ${med.trade_name}`;
                        }
                        if (med.generic_concept) {
                            infoText += infoText ? ` | –ú–ù–ù: ${med.generic_concept}` : `–ú–ù–ù: ${med.generic_concept}`;
                        }
                        if (med.medication_form) {
                            infoText += infoText ? ` | –§–æ—Ä–º–∞: ${med.medication_form}` : `–§–æ—Ä–º–∞: ${med.medication_form}`;
                        }
                        
                        console.log('üìù –¢–µ–∫—Å—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:', infoText);
                        
                        if (medicationInfoText) {
                            medicationInfoText.textContent = infoText;
                            console.log('‚úÖ –¢–µ–∫—Å—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                        } else {
                            console.log('‚ùå –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        }
                    } else {
                        console.log('‚ùå –í–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä');
                        externalLinkContainer.style.display = 'none';
                    }
                } else {
                    console.log('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã:', {
                        externalLinkContainer: externalLinkContainer,
                        externalLink: externalLink
                    });
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö
                let notificationMessage = '–î–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏';
                if (med.selected_regimen) {
                    notificationMessage += ` (—Å—Ö–µ–º–∞: ${med.selected_regimen.name})`;
                }
                showNotification(notificationMessage, 'info');
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º—ã –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
                console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º—ã:', med.available_forms);
                if (med.available_forms && med.available_forms.length > 0) {
                    console.log('‚úÖ –ù–∞–π–¥–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º—ã, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Ö');
                    displayAvailableForms(med.available_forms, med.selected_form_id);
                    const formsContainer = document.getElementById('available-forms-container');
                    if (formsContainer) {
                        formsContainer.style.display = 'block';
                        console.log('‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ä–º –ø–æ–∫–∞–∑–∞–Ω');
                    } else {
                        console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ä–º –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                } else {
                    console.log('‚ùå –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä');
                    const formsContainer = document.getElementById('available-forms-container');
                    if (formsContainer) {
                        formsContainer.style.display = 'none';
                    }
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ', 'warning');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.card-body');
        container.insertBefore(alertDiv, container.firstChild);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±–æ—Ä–∞
    function toggleFields() {
        const hasMedication = medicationField.value !== '';
        const hasCustomMedication = customMedicationField.value.trim() !== '';
        
        if (hasMedication && hasCustomMedication) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–±–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞, –ª–∏–±–æ –≤–≤–µ–¥–∏—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–µ–ø–∞—Ä–∞—Ç');
            return;
        }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–∫—É –¥–ª—è –ø–æ–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
    console.log('üîç –ü–æ–ª–µ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –Ω–∞–π–¥–µ–Ω–æ:', medicationField);
    console.log('üìä –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è:', medicationField.value);
    console.log('üîç –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–Ω–µ—à–Ω–µ–π —Å—Å—ã–ª–∫–∏:', externalLinkContainer);
    console.log('üîó –≠–ª–µ–º–µ–Ω—Ç –≤–Ω–µ—à–Ω–µ–π —Å—Å—ã–ª–∫–∏:', externalLink);
    
    // –î–ª—è select2 –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
    $(medicationField).on('select2:select', function(e) {
        console.log('üéØ –°–æ–±—ã—Ç–∏–µ select2:select —Å—Ä–∞–±–æ—Ç–∞–ª–æ!');
        console.log('üìä –í—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:', e.params.data);
        console.log('üÜî ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:', e.params.data.id);
        toggleFields();
        loadMedicationInfo(e.params.data.id);
    });
    
    $(medicationField).on('select2:clear', function(e) {
        console.log('üóëÔ∏è –°–æ–±—ã—Ç–∏–µ select2:clear —Å—Ä–∞–±–æ—Ç–∞–ª–æ!');
        toggleFields();
        loadMedicationInfo('');
    });
    
    // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å change –Ω–∞ —Å–ª—É—á–∞–π
    medicationField.addEventListener('change', function() {
        console.log('üîÑ –°–æ–±—ã—Ç–∏–µ change —Å—Ä–∞–±–æ—Ç–∞–ª–æ!');
        console.log('üÜî –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:', this.value);
        toggleFields();
        loadMedicationInfo(this.value);
    });
    
    customMedicationField.addEventListener('input', toggleFields);
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ä–º –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
    function displayAvailableForms(forms, selectedFormId) {
        console.log('üöÄ displayAvailableForms –≤—ã–∑–≤–∞–Ω–∞');
        console.log('üì¶ –§–æ—Ä–º—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', forms);
        console.log('üéØ –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ ID:', selectedFormId);
        
        const formsGrid = document.getElementById('forms-grid');
        if (!formsGrid) {
            console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–æ—Ä–º –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        console.log('‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ä–º –Ω–∞–π–¥–µ–Ω, –æ—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ');
        formsGrid.innerHTML = '';
        console.log('üîÑ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º—ã:', forms);
        
        forms.forEach(form => {
            const formCard = document.createElement('div');
            formCard.className = 'col-md-4 mb-2';
            
            const isSelected = form.id === selectedFormId;
            const cardClass = isSelected ? 'border-primary bg-primary text-white' : 'border-secondary';
            
            formCard.innerHTML = `
                <div class="card ${cardClass} h-100" style="cursor: pointer;" 
                     onclick="selectForm(${form.id}, '${form.name}')">
                    <div class="card-body p-2">
                        <h6 class="card-title mb-1">${form.name}</h6>
                        ${form.group ? `<small class="d-block">–ì—Ä—É–ø–ø–∞: ${form.group}</small>` : ''}
                        ${form.release_form && form.release_form.name ? `<small class="d-block">–§–æ—Ä–º–∞: ${form.release_form.name}</small>` : ''}
                        ${form.atc_code ? `<small class="d-block">–ê–¢–•: ${form.atc_code}</small>` : ''}
                    </div>
                </div>
            `;
            
            formsGrid.appendChild(formCard);
        });
        
        console.log('‚úÖ –§–æ—Ä–º—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ä–º—ã –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
    function selectForm(tradeNameId, formName) {
        console.log(`üöÄ selectForm –≤—ã–∑–≤–∞–Ω–∞`);
        console.log(`üîÑ –í—ã–±—Ä–∞–Ω–∞ —Ñ–æ—Ä–º–∞: ${formName} (ID: ${tradeNameId})`);
        
        const patientId = getPatientId();
        console.log(`üë§ ID –ø–∞—Ü–∏–µ–Ω—Ç–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: ${patientId}`);
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ
        const url = `/encounters/api/trade-name-info/${tradeNameId}/?patient_id=${patientId}`;
        console.log(`üåê URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: ${url}`);
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateFormWithTradeNameInfo(data.form_info);
                    updateSelectedFormUI(tradeNameId);
                    console.log('‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', data.form_info);
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–æ—Ä–º–µ:', data.error);
                }
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ AJAX –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —Ñ–æ—Ä–º—ã:', error);
            });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ñ–æ—Ä–º–µ
    function updateFormWithTradeNameInfo(formInfo) {
        console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ—Ä–≥–æ–≤–æ–π —Ñ–æ—Ä–º–µ:', formInfo);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –¥–æ–∑–∏—Ä–æ–≤–∫–∏
        if (formInfo.dosage) {
            const dosageField = document.getElementById('id_dosage');
            if (dosageField) dosageField.value = formInfo.dosage;
        }
        if (formInfo.frequency) {
            const frequencyField = document.getElementById('id_frequency');
            if (frequencyField) frequencyField.value = formInfo.frequency;
        }
        if (formInfo.route) {
            const routeField = document.getElementById('id_route');
            if (routeField) {
                // –ò—â–µ–º –æ–ø—Ü–∏—é –ø–æ —Ç–µ–∫—Å—Ç—É
                for (let option of routeField.options) {
                    if (option.text.toLowerCase().includes(formInfo.route.toLowerCase())) {
                        routeField.value = option.value;
                        break;
                    }
                }
            }
        }
        if (formInfo.duration) {
            const durationField = document.getElementById('id_duration');
            if (durationField) durationField.value = formInfo.duration;
        }
        if (formInfo.instructions) {
            const instructionsField = document.getElementById('id_instructions');
            if (instructionsField) instructionsField.value = formInfo.instructions;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        const externalLink = document.getElementById('external-link');
        if (externalLink && formInfo.external_url) {
            externalLink.href = formInfo.external_url;
            externalLink.style.display = 'inline';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        const medicationInfoText = document.getElementById('medication-info-text');
        if (medicationInfoText) {
            let infoText = '';
            if (formInfo.name) {
                infoText += `–¢–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: ${formInfo.name}<br>`;
            }
            if (formInfo.medication_name) {
                infoText += `–ú–ù–ù: ${formInfo.medication_name}<br>`;
            }
            if (formInfo.release_form && formInfo.release_form.name) {
                infoText += `–§–æ—Ä–º–∞: ${formInfo.release_form.name}`;
            }
            medicationInfoText.innerHTML = infoText;
            medicationInfoText.style.display = 'block';
        }
        
        console.log('‚úÖ –§–æ—Ä–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ—Ä–≥–æ–≤–æ–π —Ñ–æ—Ä–º–µ');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã
    function updateSelectedFormUI(selectedFormId) {
        const formCards = document.querySelectorAll('#forms-grid .card');
        formCards.forEach(card => {
            const onclickAttr = card.getAttribute('onclick');
            const match = onclickAttr.match(/selectForm\((\d+)/);
            if (match) {
                const formId = parseInt(match[1]);
                if (formId === selectedFormId) {
                    card.className = 'card border-primary bg-primary text-white h-100';
                } else {
                    card.className = 'card border-secondary h-100';
                }
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∏–∑ URL –∏–ª–∏ —Ñ–æ—Ä–º—ã
    function getPatientId() {
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        let patientId = urlParams.get('patient_id');
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤ URL, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è
        if (!patientId) {
            const patientField = document.querySelector('input[name="patient"]');
            if (patientField) {
                patientId = patientField.value;
            }
        }
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤ —Å–∫—Ä—ã—Ç–æ–º –ø–æ–ª–µ, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ select
        if (!patientId) {
            const patientSelect = document.querySelector('select[name="patient"]');
            if (patientSelect) {
                patientId = patientSelect.value;
            }
        }
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤ select, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ encounter
        if (!patientId) {
            const encounterField = document.querySelector('input[name="encounter"]');
            if (encounterField) {
                // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–ª—É—á–∏—Ç—å patient_id –∏–∑ encounter
                // –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
                patientId = '';
            }
        }
        
        console.log('üë§ ID –ø–∞—Ü–∏–µ–Ω—Ç–∞:', patientId);
        return patientId;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ–ø–∞—Ä–∞—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (medicationField && medicationField.value) {
        console.log('üîç –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–∂–µ –≤—ã–±—Ä–∞–Ω –ø—Ä–µ–ø–∞—Ä–∞—Ç:', medicationField.value);
        loadMedicationInfo(medicationField.value);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—è –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
    if (medicationField) {
        medicationField.addEventListener('change', function() {
            console.log('üîÑ –ü–æ–ª–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:', this.value);
            loadMedicationInfo(this.value);
        });
    }
});
</script>
{% endblock %} 