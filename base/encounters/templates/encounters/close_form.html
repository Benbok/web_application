{% extends 'patients/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Закрытие случая №{{ encounter_number }}{% endblock %}
{% block page_title %}Закрытие случая{% endblock %}

{% block content %}
<div class="card mt-4">
  <div class="card-body">
    <h4 class="card-title mb-4">
      <i class="fas fa-lock me-2"></i>Закрытие случая №{{ encounter.encounter_number }}
    </h4>
    
    <!-- Информация о случае -->
    <div class="card mb-4 border-light">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Информация о случае</h6>
      </div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span><i class="fas fa-hashtag me-2"></i>Номер случая:</span>
            <span class="badge bg-secondary">{{ encounter_number }}</span>
          </li>
          <li class="list-group-item">
            <strong>Пациент:</strong>
            <a href="{% url 'patients:patient_detail' encounter.patient.pk %}" class="text-decoration-none">
              {{ encounter.patient.get_full_name_with_age }}
            </a>
          </li>
          <li class="list-group-item">
            <strong>Дата начала:</strong>
            {{ encounter.date_start|date:'d.m.Y H:i' }}
          </li>
          <li class="list-group-item">
            <strong>Врач:</strong> 
            {% if encounter.doctor.doctor_profile %}
              {{ encounter.doctor.doctor_profile.full_name }}
            {% else %}
              {{ encounter.doctor.get_full_name|default:encounter.doctor.username }}
            {% endif %}
          </li>
          <li class="list-group-item">
            <strong>Статус:</strong>
            <span class="badge bg-secondary">Активен</span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span><i class="fas fa-file-medical me-2"></i>Документы:</span>
            <span class="badge bg-success">{{ encounter_service.get_documents_count }}</span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span><i class="fas fa-stethoscope me-2"></i>Основной диагноз:</span>
            {% if main_diagnosis %}
              {% if main_diagnosis.diagnosis %}
                <span class="badge bg-info">{{ main_diagnosis.diagnosis.name }}</span>
              {% elif main_diagnosis.custom_diagnosis %}
                <span class="badge bg-info">{{ main_diagnosis.custom_diagnosis|truncatechars:30 }}</span>
              {% else %}
                <span class="badge bg-warning">Не указан</span>
              {% endif %}
            {% else %}
              <span class="badge bg-warning">Не установлен</span>
            {% endif %}
          </li>
        </ul>
      </div>
    </div>

    <!-- Сообщения об ошибках -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          <i class="fas fa-info-circle me-2"></i>{{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {% for error in form.non_field_errors %}
          {{ error }}
        {% endfor %}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endif %}

    <!-- Форма закрытия -->
    <div class="card">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-edit me-2"></i>Параметры закрытия</h6>
      </div>
      <div class="card-body">
        <form method="post">
          {% csrf_token %}
          <div class="mb-3">
            <label for="{{ form.outcome.id_for_label }}" class="form-label">
              <i class="fas fa-flag me-2"></i>{{ form.outcome.label }}
            </label>
            {{ form.outcome }}
            {% if form.outcome.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.outcome.errors %}
                  <small class="text-danger">
                    <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                  </small>
                {% endfor %}
              </div>
            {% endif %}
            {% if form.outcome.help_text %}
              <div class="form-text">{{ form.outcome.help_text }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label for="{{ form.date_end.id_for_label }}" class="form-label">
              <i class="fas fa-calendar-alt me-2"></i>{{ form.date_end.label }}
            </label>
            {{ form.date_end }}
            {% if form.date_end.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.date_end.errors %}
                  <small class="text-danger">
                    <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                  </small>
                {% endfor %}
              </div>
            {% endif %}
            {% if form.date_end.help_text %}
              <div class="form-text">{{ form.date_end.help_text }}</div>
            {% endif %}
          </div>

          <div class="mb-3" id="transfer_department_field" style="display: none;">
            <label for="{{ form.transfer_to_department.id_for_label }}" class="form-label">
              <i class="fas fa-hospital me-2"></i>{{ form.transfer_to_department.label }}
            </label>
            {{ form.transfer_to_department }}
            {% if form.transfer_to_department.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.transfer_to_department.errors %}
                  <small class="text-danger">
                    <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                  </small>
                {% endfor %}
              </div>
            {% endif %}
            {% if form.transfer_to_department.help_text %}
              <div class="form-text">{{ form.transfer_to_department.help_text }}</div>
            {% endif %}
          </div>

          <!-- Информация о закрытии -->
          <div class="alert alert-info mt-4">
            <div class="d-flex align-items-start">
              <i class="fas fa-info-circle me-3"></i>
              <div>
                <h6 class="alert-heading mb-2">
                  <strong>Информация</strong>
                </h6>
                <p class="mb-0">После закрытия случая его нельзя будет изменить.</p>
              </div>
            </div>
          </div>

          <!-- Кнопки действий -->
          <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="btn-toolbar" role="toolbar">
              <div class="btn-group me-2" role="group">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-check me-2"></i>Закрыть случай
                </button>
                <a href="{% url 'encounters:encounter_detail' encounter.pk %}" class="btn btn-secondary">
                  <i class="fas fa-times me-2"></i>Отмена
                </a>
              </div>
            </div>
            
            <div class="ms-auto">
              <a href="{% url 'patients:patient_detail' encounter.patient.pk %}" class="btn btn-outline-secondary">
                <i class="fas fa-user me-1"></i>К пациенту
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
.card {
    transition: all 0.2s ease-in-out;
}

.card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.btn {
    transition: all 0.2s ease-in-out;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.list-group-item {
    border-left: none;
    border-right: none;
}

.list-group-item:first-child {
    border-top: none;
}

.list-group-item:last-child {
    border-bottom: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Находим поля формы
    const outcomeSelect = document.querySelector('select[name="outcome"]');
    const transferField = document.querySelector('select[name="transfer_to_department"]');
    const submitButton = document.querySelector('button[type="submit"]');
    
    function toggleTransferField() {
        if (!transferField) return;
        
        // Находим контейнер всего поля (включая label, help_text и т.д.)
        const transferFieldContainer = transferField.closest('.form-group') || 
                                     transferField.closest('.mb-3') || 
                                     transferField.parentElement.parentElement;
        
        if (outcomeSelect.value === 'transferred') {
            transferField.required = true;
            if (transferFieldContainer) {
                transferFieldContainer.style.display = 'block';
            }
        } else {
            transferField.required = false;
            transferField.value = '';
            if (transferFieldContainer) {
                transferFieldContainer.style.display = 'none';
            }
        }
    }
    

    
    if (outcomeSelect) {
        outcomeSelect.addEventListener('change', toggleTransferField);
        toggleTransferField(); // Инициализация при загрузке
    }
    
    // Скрываем поле transfer_to_department по умолчанию
    if (transferField) {
        const transferFieldContainer = transferField.closest('.form-group') || 
                                     transferField.closest('.mb-3') || 
                                     transferField.parentElement.parentElement;
        if (transferFieldContainer) {
            transferFieldContainer.style.display = 'none';
        }
    }
});
</script>
{% endblock %}