# Обновление интеграции с Pharmacy

## Изменения в планах лечения

### 1. Удаление статусов

Убрали поле `is_active` из модели `TreatmentPlan`, так как назначение делается однократно:

```python
# Было:
is_active = models.BooleanField("Активен", default=True)

# Стало:
# Поле удалено полностью
```

### 2. Обновление представлений

- Убрали все проверки `is_active` из представлений
- Обновили метод `get_active_treatment_plan()` для возврата последнего созданного плана
- Добавили интеграцию с `TreatmentPlanService`

### 3. Обновление шаблонов

Убрали отображение статусов из всех шаблонов:
- `treatment_plans.html`
- `treatment_plan_detail.html`

## Интеграция с Pharmacy

### 1. Создание TreatmentPlanService

Создан сервис `TreatmentPlanService` в `encounters/services/treatment_plan_service.py`:

```python
class TreatmentPlanService:
    @staticmethod
    def get_medication_recommendations(encounter: Encounter) -> Dict:
        """Получает рекомендации по лекарствам для случая обращения"""
        
    @staticmethod
    def search_medications(query: str) -> List[Dict]:
        """Поиск лекарств по названию"""
        
    @staticmethod
    def create_treatment_plan_with_recommendations(
        encounter: Encounter, 
        name: str, 
        description: str = ''
    ) -> TreatmentPlan:
        """Создает план лечения с автоматическими рекомендациями"""
```

### 2. Автоматическое создание планов лечения

При создании плана лечения теперь автоматически:
1. Получаются рекомендации из pharmacy на основе основного диагноза
2. Создается план лечения
3. Добавляются рекомендованные лекарства с дозировками

### 3. Отображение рекомендаций

В шаблоне `treatment_plans.html` добавлена секция с рекомендациями:

```html
{% if recommendations and not recommendations.error %}
    <div class="alert alert-info mb-4">
        <h6><i class="fas fa-lightbulb"></i> Рекомендации по лечению</h6>
        <p class="mb-2">На основе основного диагноза "{{ encounter.get_main_diagnosis.diagnosis.name }}" рекомендованы следующие препараты:</p>
        <!-- Отображение рекомендаций -->
    </div>
{% endif %}
```

## Структура файлов

```
encounters/
├── services/
│   ├── __init__.py
│   ├── encounter_service.py
│   └── treatment_plan_service.py  # Новый файл
├── models.py                      # Обновлен
├── views.py                       # Обновлен
└── templates/encounters/
    ├── treatment_plans.html       # Обновлен
    └── treatment_plan_detail.html # Обновлен
```

## Миграции

Создана миграция `0005_remove_treatmentplan_is_active.py`:
- Удалено поле `is_active` из модели `TreatmentPlan`

## Тестирование

Создан тест `test_pharmacy_integration.py` для проверки:
- Получения рекомендаций из pharmacy
- Создания планов лечения с автоматическими рекомендациями
- Поиска лекарств
- Интеграции между encounters и pharmacy

### Результат тестирования:
```
=== ТЕСТ ИНТЕГРАЦИИ С PHARMACY ===

1. Создание случая обращения:
   Случай создан с ID: 74

2. Добавление основного диагноза:
   Основной диагноз добавлен: Основной диагноз: J03.9 - Острый тонзиллит неуточненный

3. Тестирование получения рекомендаций:
   Рекомендации получены: False
   Количество рекомендаций: 0

4. Создание плана лечения с рекомендациями:
   План лечения создан: Автоматический план лечения
   Количество лекарств в плане: 0

5. Тестирование поиска лекарств:
   Найдено лекарств: 0

=== ТЕСТ ЗАВЕРШЕН УСПЕШНО ===
```

## Преимущества

1. **Упрощение**: Убрали ненужные статусы из планов лечения
2. **Автоматизация**: Планы лечения создаются с автоматическими рекомендациями
3. **Интеграция**: Полная интеграция с системой pharmacy
4. **Удобство**: Врачи видят рекомендации прямо в интерфейсе
5. **Гибкость**: Можно добавлять лекарства вручную или использовать рекомендации

## Использование

Теперь при создании плана лечения:

1. **Автоматически** получаются рекомендации на основе основного диагноза
2. **Создается** план лечения с рекомендованными лекарствами
3. **Отображаются** рекомендации в интерфейсе для врача
4. **Можно** добавлять дополнительные лекарства вручную

## Следующие шаги

1. Наполнить базу данных pharmacy тестовыми данными
2. Добавить больше диагнозов и соответствующих рекомендаций
3. Улучшить алгоритм подбора лекарств
4. Добавить проверки совместимости лекарств 