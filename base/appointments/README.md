# Модуль Appointments - Документация функционала

## Обзор модуля

Модуль `appointments` отвечает за управление записями на прием к врачам, включая создание расписаний, бронирование слотов и интеграцию с системой обращений (encounters).

## Модели (Models)

### AppointmentStatus
**Назначение**: Перечисление статусов записи на прием
**Функционал**:
- `SCHEDULED` - Запланирован
- `COMPLETED` - Завершен  
- `CANCELED` - Отменен

### Schedule
**Назначение**: Модель расписания работы врача
**Основные поля**:
- `doctor` - Связь с врачом (только с профилем доктора)
- `start_time` - Время начала смены
- `end_time` - Время окончания смены
- `duration` - Длительность приема в минутах (по умолчанию 30)
- `recurrences` - Правило повторения расписания

**Методы**:
- `doctor_full_name` (property) - Полное имя врача для расписания
- `__str__()` - Строковое представление расписания
- `clean()` - Валидация и автоматическая корректировка времени окончания смены

**Функционал**:
- Автоматический расчет времени окончания смены на основе длительности приема
- Интеграция с системой повторений (recurrence)
- Валидация корректности временных интервалов

### AppointmentEvent
**Назначение**: Модель записи на прием пациента
**Основные поля**:
- `schedule` - Связь с расписанием врача
- `patient` - Связь с пациентом
- `start` - Время начала приема
- `end` - Время окончания приема
- `notes` - Заметки к записи
- `status` - Статус записи (из AppointmentStatus)
- `encounter` - Связь с случаем обращения (OneToOne)

**Методы**:
- `doctor` (property) - Безопасный доступ к врачу через расписание
- `__str__()` - Строковое представление записи
- `is_upcoming()` - Проверка, является ли прием предстоящим
- `is_completed()` - Проверка завершенности приема
- `archive()` - Архивирование записи с синхронизацией encounter
- `unarchive()` - Восстановление из архива с синхронизацией encounter

**Функционал**:
- Интеграция с системой архивирования (ArchivableModel)
- Синхронизация с случаями обращения (Encounter)
- Автоматическое управление статусами

## Представления (Views)

### AppointmentEventViewSet
**Назначение**: REST API для управления записями на прием
**Функционал**:
- CRUD операции для AppointmentEvent
- Фильтрация по врачу через query параметр `doctor`

### AppointmentEventsAPI
**Назначение**: API для FullCalendar - возвращает записанные приемы
**Функционал**:
- Возвращает только записи со статусом "scheduled"
- Форматирует ФИО пациента в сокращенном виде
- Генерирует события для календаря с цветовой индикацией

### AvailableSlotsAPIView
**Назначение**: API для получения свободных слотов врача
**Параметры**:
- `start` - начало периода
- `end` - конец периода  
- `doctor_id` - ID врача
**Функционал**:
- Генерирует свободные слоты на основе расписания
- Исключает уже забронированные времена

### CalendarView
**Назначение**: Отображение календаря приемов
**Функционал**:
- Предоставляет список врачей для фильтрации
- Интеграция с FullCalendar

### AppointmentCreateView
**Назначение**: Создание новой записи на прием
**Функционал**:
- Обработка параметров из сессии (после создания пациента)
- Обработка параметров из URL
- Автоматическое заполнение начальных данных

### AppointmentUpdateView
**Назначение**: Редактирование записи на прием
**Функционал**:
- Стандартное редактирование с возвратом к календарю

### AppointmentEventUpdateView
**Назначение**: Альтернативное редактирование с возвратом к деталям
**Функционал**:
- Редактирование с переходом к детальному просмотру записи

### AppointmentEventDetailView
**Назначение**: Детальный просмотр записи на прием
**Функционал**:
- Отображение полной информации о записи

### AppointmentEventDeleteView
**Назначение**: Удаление записи на прием
**Функционал**:
- Подтверждение удаления с возвратом к календарю

### CreateEncounterForAppointmentView
**Назначение**: Создание случая обращения для записи
**Функционал**:
- Автоматическое создание Encounter для записи
- Синхронизация с AppointmentEvent
- Перенаправление к деталям случая обращения

## Сервисы (Services)

### generate_available_slots()
**Назначение**: Генерация свободных слотов по расписанию врача
**Параметры**:
- `start_dt` - начало периода
- `end_dt` - конец периода
- `doctor_id` - ID врача
**Функционал**:
- Анализ расписания врача с учетом повторений
- Исключение уже забронированных слотов
- Генерация списка доступных временных интервалов
- Возврат данных в формате для FullCalendar

## Сериализаторы (Serializers)

### DoctorSerializer
**Назначение**: Сериализация данных врача
**Поля**: id, first_name, last_name

### PatientSerializer  
**Назначение**: Сериализация данных пациента
**Поля**: id, full_name

### ScheduleSerializer
**Назначение**: Сериализация расписания с вложенным врачом
**Функционал**: Включает полную информацию о расписании

### AppointmentEventSerializer
**Назначение**: Сериализация записи на прием
**Поля**: id, schedule, patient, start, end, notes, status, title
**Методы**:
- `get_title()` - Форматирование ФИО пациента для отображения

## Формы (Forms)

### AppointmentEventForm
**Назначение**: Форма создания/редактирования записи на прием
**Валидация**:
- Проверка времени приема в рамках смены врача
- Проверка на пересечение записей у врача
- Проверка на пересечение записей у пациента
- Автоматический расчет времени окончания приема

### ScheduleAdminForm
**Назначение**: Форма для админ-панели расписаний
**Функционал**:
- Кастомное отображение врачей в выпадающем списке
- Использование полного имени из DoctorProfile

## Админ-панель (Admin)

### ScheduleAdmin
**Назначение**: Администрирование расписаний
**Функционал**:
- Отображение полного имени врача
- Фильтрация и поиск
- Оптимизированные запросы с select_related

### AppointmentEventAdmin
**Назначение**: Администрирование записей на прием
**Функционал**:
- Отображение статуса архивирования
- Действия массового архивирования/восстановления
- Фильтрация по статусу и архиву
- Поиск по данным пациента

## Интеграции

### С системой Encounter
- Автоматическое создание случая обращения при необходимости
- Синхронизация статусов между записью и случаем
- Совместное архивирование/восстановление

### С системой Patient
- Связь записей с пациентами
- Валидация доступности пациента

### С системой Doctor
- Связь через DoctorProfile
- Валидация доступности врача

### С FullCalendar
- API для отображения записей в календаре
- Генерация свободных слотов
- Цветовая индикация статусов

## Архитектурные особенности

1. **Soft Delete**: Использование ArchivableModel для мягкого удаления
2. **Синхронизация**: Автоматическая синхронизация между связанными моделями
3. **Валидация**: Многоуровневая валидация данных
4. **API First**: REST API для интеграции с фронтендом
5. **Календарная интеграция**: Полная поддержка FullCalendar 