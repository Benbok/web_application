{% extends 'patients/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans 'Настройка расписания' %}{% endblock %}

{% block page_title %}{% trans 'Настройка расписания назначения' %}{% endblock %}

{% block content %}
<div class="card mt-4" style="z-index: 2;">
    <div class="card-body position-relative">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="card-title mb-0">{% trans 'Настройка расписания назначения' %}</h4>
            {% if return_url and return_url != request.path %}
                <a href="{{ return_url }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>{% trans 'Вернуться' %}
                </a>
            {% endif %}
        </div>
        
        <!-- Информация о назначении -->
        <ul class="list-group list-group-flush mb-4">
            <li class="list-group-item">
                <strong>{% trans 'Тип назначения:' %}</strong>
                {% if assignment_type == 'medication' %}
                    <span class="badge bg-success ms-2">{% trans 'Лекарство' %}</span>
                {% elif assignment_type == 'lab_test' %}
                    <span class="badge bg-info ms-2">{% trans 'Лабораторное исследование' %}</span>
                {% elif assignment_type == 'procedure' %}
                    <span class="badge bg-warning ms-2">{% trans 'Процедура' %}</span>
                {% else %}
                    <span class="badge bg-secondary ms-2">{% trans 'Неизвестно' %}</span>
                {% endif %}
            </li>
            <li class="list-group-item">
                <strong>{% trans 'Название назначения:' %}</strong> 
                {% if assignment_type == 'medication' %}
                    {{ assignment.treatment_name|default:assignment }}
                {% elif assignment_type == 'lab_test' %}
                    {{ assignment.lab_test.name|default:assignment }}
                {% elif assignment_type == 'procedure' %}
                    {{ assignment.instrumental_procedure.name|default:assignment }}
                {% else %}
                    {{ assignment }}
                {% endif %}
            </li>
        </ul>
        
        <form method="post">
            {% csrf_token %}
            
            <!-- Скрытые поля -->
            <input type="hidden" name="assignment_type" value="{{ assignment_type }}">
            <input type="hidden" name="assignment_id" value="{{ assignment_id }}">
            <input type="hidden" name="content_type_id" value="{{ content_type_id }}">
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.start_date.id_for_label }}" class="form-label">
                            {{ form.start_date.label }}
                        </label>
                        {{ form.start_date }}
                        {% if form.start_date.help_text %}
                            <small class="form-text text-muted">{{ form.start_date.help_text }}</small>
                        {% endif %}
                        {% if form.start_date.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.start_date.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.first_time.id_for_label }}" class="form-label">
                            {{ form.first_time.label }}
                        </label>
                        {{ form.first_time }}
                        {% if form.first_time.help_text %}
                            <small class="form-text text-muted">{{ form.first_time.help_text }}</small>
                        {% endif %}
                        {% if form.first_time.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.first_time.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.times_per_day.id_for_label }}" class="form-label">
                            {{ form.times_per_day.label }}
                        </label>
                        {{ form.times_per_day }}
                        {% if form.times_per_day.help_text %}
                            <small class="form-text text-muted">{{ form.times_per_day.help_text }}</small>
                        {% endif %}
                        {% if form.times_per_day.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.times_per_day.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.duration_days.id_for_label }}" class="form-label">
                            {{ form.duration_days.label }}
                        </label>
                        {{ form.duration_days }}
                        {% if form.duration_days.help_text %}
                            <small class="form-text text-muted">{{ form.duration_days.help_text }}</small>
                        {% endif %}
                        {% if form.duration_days.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.duration_days.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-4">
                <a href="{{ return_url|default:next_url }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>{% trans 'Назад' %}
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-calendar-plus me-1"></i>{% trans 'Создать расписание' %}
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Устанавливаем текущую дату по умолчанию, если поле пустое
    document.addEventListener('DOMContentLoaded', function() {
        const startDateField = document.getElementById('{{ form.start_date.id_for_label }}');
        if (startDateField) {
            // Если поле пустое, устанавливаем сегодняшнюю дату
            if (!startDateField.value) {
                const today = new Date().toISOString().split('T')[0];
                startDateField.value = today;
            }
            
            // Устанавливаем минимальную дату как сегодня (нельзя выбрать прошедшую дату)
            const today = new Date().toISOString().split('T')[0];
            startDateField.setAttribute('min', today);
        }
    });
</script>
{% endblock %}

<style>
    .form-control, .form-select {
        border-radius: 0.375rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .list-group-item {
        border-left: none;
        border-right: none;
    }
    
    .badge {
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .card {
        border: 1px solid rgba(0, 0, 0, 0.125);
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
</style> 